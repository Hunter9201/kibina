<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KIBIINA – Savings & Loans (KYC + Loans by Term + Accrual YTD + Auto Month-End + Smart XLSX Merge)</title>
<meta name="description" content="Kibiina saving group app: members numbered 1–30, Excel import/merge, registrar with files & KYC, Google Drive backup, loans with monthly terms, automatic interest accrual postings, meetings & reports.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center}
  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  main{padding:16px;max-width:1200px;margin:0 auto}
  h2{margin:.2rem 0 1rem}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:.3rem 0 .8rem}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button,textarea{font:inherit}
  input[type="number"],input[type="date"],input[type="text"],input[type="tel"],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d)}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed var(--line);padding:8px;text-align:left;font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){ .row{grid-template-columns:1fr} .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }
  .stat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat b{display:block;font-size:20px;margin-top:4px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:10px}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:8px;border-radius:10px}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  img{max-width:100%}
  .file-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .kyc-chip{font-size:11px;padding:2px 6px;border-radius:999px;border:1px solid var(--line);background:#ecfeff}
  .kyc-chip.ok{background:#ecfdf5;border-color:#86efac;color:#065f46}
  .kyc-chip.bad{background:#fef2f2;border-color:#fecaca;color:#991b1b}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">K</div> KIBIINA – Savings & Loans</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="members">Members</button>
        <button class="tab" data-tab="registrar">Registrar</button>
        <button class="tab" data-tab="meeting">Sunday Meeting</button>
        <button class="tab" data-tab="loans">Loans</button>
        <button class="tab" data-tab="repay">Repayments</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <h2>Group Overview</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Members</span><b id="statMembers">0</b></div>
        <div class="stat"><span class="muted">Total Share Capital</span><b id="statShareCap">UGX 0</b></div>
        <div class="stat"><span class="muted">Loans Outstanding</span><b id="statLoans">UGX 0</b></div>
        <div class="stat"><span class="muted">Interest Collected (YTD)</span><b id="statInterestYTD">UGX 0</b></div>
      </div>
      <div class="grid-4" style="margin-top:8px">
        <div class="stat"><span class="muted">Interest Accrued (YTD)</span><b id="statAccruedYTD">UGX 0</b></div>
        <div class="stat"><span class="muted">Welfare Fund</span><b id="fundWelfare">UGX 0</b></div>
        <div class="stat"><span class="muted">Munno (aggregate)</span><b id="fundMunno">UGX 0</b></div>
        <div class="stat"><span class="muted">Last Accrual Posted</span><b id="statLastAccPosted">—</b></div>
      </div>
      <div class="hr"></div>
      <div class="grid-2">
        <div class="card">
          <h3>Funds</h3>
          <table class="table">
            <tr><th>Fund</th><th>Balance</th></tr>
            <tr><td>Welfare</td><td id="fundWelfare2">UGX 0</td></tr>
            <tr><td>Munno (aggregate of members)</td><td id="fundMunno2">UGX 0</td></tr>
          </table>
          <p class="help">Munno is saved by each member and is returned in full with no charges or profit.</p>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="stack">
            <button class="btn primary" id="btnCreate30">Create numbered members 1–30</button>
            <button class="btn" id="btnTodaySunday">Set meeting date to next Sunday</button>
            <button class="btn" id="btnBackup">Export data (JSON)</button>
            <label class="btn"><input type="file" id="restoreFile" accept="application/json" style="display:none">Import data</label>
          </div>
          <p class="help">All data saves to this browser using localStorage. Use export/import to move or back up.</p>
        </div>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Add / Edit Member</h3>
          <div class="grid-3">
            <div>
              <label>Member No (1–30, unique)</label>
              <input id="mNo" type="number" min="1" max="30" step="1" placeholder="1">
            </div>
            <div>
              <label>Display Name</label>
              <input id="mName" type="text" placeholder="Member name">
            </div>
            <div>
              <label>Join Date</label>
              <input id="mJoin" type="date">
            </div>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Shares (0–10)</label>
              <input id="mShares" type="number" min="0" max="10" step="1" value="0">
            </div>
            <div>
              <label>Munno Balance (UGX)</label>
              <input id="mMunno" type="number" min="0" step="1" value="0">
            </div>
            <div style="align-self:end">
              <div class="stack">
                <button class="btn primary" id="btnSaveMember">Save Member</button>
                <button class="btn bad" id="btnDeleteMember" disabled>Delete</button>
              </div>
            </div>
          </div>
          <p class="help">Each member is identified by a <b>number from 1 to 30</b>. Names are for display only.</p>
        </div>
        <div class="card" style="grid-column: span 8;">
          <h3>Member List</h3>
          <table class="table" id="membersTable">
            <thead>
              <tr>
                <th>No.</th><th>Name</th><th>Shares</th><th>Share Capital</th><th>Munno</th><th>Loan O/S</th><th>Available Limit</th><th>KYC</th><th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REGISTRAR -->
    <section id="registrar" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>New Registrar Entry</h3>
          <div class="grid-3">
            <div>
              <label>Date</label>
              <input type="date" id="regDate">
            </div>
            <div>
              <label>Type</label>
              <select id="regType">
                <option value="fine">Fine</option>
                <option value="loan_form_fee">Loan Form Fee</option>
                <option value="munno_withdraw">Munno Withdraw</option>
                <option value="munno_returned">Munno Returned</option>
                <option value="other">Other (note only)</option>
              </select>
            </div>
            <div>
              <label>Member (optional)</label>
              <select id="regMember"></select>
            </div>
          </div>
          <div class="grid-2" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="regAmount" min="0" step="1" value="0">
            </div>
            <div>
              <label>Attachments</label>
              <input type="file" id="regFiles" multiple>
            </div>
          </div>
          <div style="margin-top:8px">
            <label>Notes</label>
            <textarea id="regNotes" rows="3" placeholder="Brief description..."></textarea>
          </div>
          <div class="right" style="margin-top:8px">
            <button class="btn primary" id="btnRegAdd">Add Entry</button>
          </div>
          <p class="help">Registrar supports attachments stored locally (IndexedDB). You can also save a JSON backup or push to Drive in the Data tab.</p>

          <div class="hr"></div>
          <h3>Member KYC & Documents</h3>
          <div>
            <label>Member</label>
            <select id="kycMember"></select>
          </div>
          <div class="grid-2" style="margin-top:8px">
            <div>
              <label>Full Name</label>
              <input type="text" id="kycName" placeholder="(defaults to member name)">
            </div>
            <div>
              <label>Tribe</label>
              <input type="text" id="kycTribe" placeholder="e.g., Baganda">
            </div>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Age</label>
              <input type="number" id="kycAge" min="0" step="1">
            </div>
            <div>
              <label>Date of Birth</label>
              <input type="date" id="kycDob">
            </div>
            <div>
              <label>Phone</label>
              <input type="tel" id="kycPhone" placeholder="+256...">
            </div>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Next of Kin – Name</label>
              <input type="text" id="kycNokName">
            </div>
            <div>
              <label>Relationship</label>
              <input type="text" id="kycNokRel" placeholder="e.g., Brother">
            </div>
            <div>
              <label>Next of Kin – Phone</label>
              <input type="tel" id="kycNokPhone" placeholder="+256...">
            </div>
          </div>
          <div class="stack" style="margin-top:8px">
            <label class="pill"><input type="checkbox" id="kycAppForm"> Full Application form received</label>
            <label class="pill"><input type="checkbox" id="kycPassport"> Passport photos received</label>
          </div>
          <div style="margin-top:8px">
            <label>Upload KYC Documents</label>
            <input type="file" id="kycFiles" multiple>
          </div>
          <div class="right" style="margin-top:8px">
            <button class="btn ok" id="btnKycSave">Save KYC</button>
          </div>
          <p class="help">All uploaded KYC documents save to IndexedDB and are linked to the member’s profile.</p>
        </div>

        <div class="card" style="grid-column: span 8;">
          <h3>Registrar Entries</h3>
          <table class="table" id="regTable">
            <thead>
              <tr><th>Date</th><th>Type</th><th>Member</th><th>Amount</th><th>Notes</th><th>Files</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>

          <div class="hr"></div>
          <h3>Member KYC Files & Status</h3>
          <div id="kycSummary"></div>
        </div>
      </div>
    </section>

    <!-- MEETING -->
    <section id="meeting" class="tabpanel" hidden>
      <div class="card">
        <h3>Sunday Meeting Sheet</h3>
        <div class="grid-3">
          <div>
            <label>Meeting Date</label>
            <input type="date" id="meetDate">
          </div>
          <div>
            <label>Welfare per member (UGX)</label>
            <input type="number" id="welfarePer" min="0" step="1" value="1500">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn" id="btnStartMeeting">Generate Sheet</button>
            <button class="btn ok" id="btnPostMeeting" disabled>Post Meeting</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="meetingSheet"></div>
      </div>
      <p class="help">Munno deposit, welfare (checkbox), and new shares (#) per member. Posting writes transactions and updates balances.</p>
    </section>

    <!-- LOANS -->
    <section id="loans" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Issue Loan / Top-up</h3>
          <div>
            <label>Member</label>
            <select id="loanMember"></select>
          </div>
          <div class="grid-2" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="loanAmt" min="1" step="1">
            </div>
            <div>
              <label>Term (months)</label>
              <input type="number" id="loanTerm" min="1" step="1" value="3">
            </div>
          </div>
          <div style="margin-top:8px">
            <label>Date</label>
            <input type="date" id="loanDate">
          </div>
          <div class="help" id="loanHint" style="margin-top:6px"></div>
          <div class="right" style="margin-top:8px"><button class="btn primary" id="btnIssueLoan">Record Loan</button></div>
          <p class="help">Rate: <b>2.5%/mo</b> for UGX 1–3,999,999; <b>2%/mo</b> for UGX ≥ 4,000,000. Limit = 2 × share capital minus outstanding principal.</p>
        </div>
        <div class="card" style="grid-column: span 8;">
          <h3>Active Loans</h3>
          <table class="table" id="loansTable">
            <thead>
              <tr>
                <th>No.</th><th>Name</th>
                <th>Principal O/S</th><th>Interest Accrued</th>
                <th>Rate</th><th>Since</th>
                <th>Term</th><th>End</th>
                <th>Monthly Int</th><th>Term Int</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPAYMENTS -->
    <section id="repay" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Post Repayment</h3>
          <div>
            <label>Member (with active loan)</label>
            <select id="rpMember"></select>
          </div>
          <div style="margin-top:8px">
            <label>Amount (UGX)</label>
            <input type="number" id="rpAmt" min="1" step="1">
          </div>
          <div style="margin-top:8px">
            <label>Date</label>
            <input type="date" id="rpDate">
          </div>
          <div style="margin-top:8px">
            <label>Apply to</label>
            <select id="rpApply">
              <option value="auto">Auto: interest then principal</option>
              <option value="interest">Interest only</option>
              <option value="principal">Principal only</option>
            </select>
          </div>
          <div class="right" style="margin-top:8px"><button class="btn primary" id="btnPostRepay">Post</button></div>
        </div>
        <div class="card" style="grid-column: span 8;">
          <h3>Recent Transactions</h3>
          <table class="table" id="txTable">
            <thead><tr><th>Date</th><th>No.</th><th>Name</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tabpanel" hidden>
      <div class="card">
        <h3>Quarterly Summary (quick)</h3>
        <div class="grid-3">
          <div>
            <label>Quarter</label>
            <select id="rQuarter">
              <option value="Q1">Q1 (Jan–Mar)</option>
              <option value="Q2">Q2 (Apr–Jun)</option>
              <option value="Q3">Q3 (Jul–Sep)</option>
              <option value="Q4">Q4 (Oct–Dec)</option>
            </select>
          </div>
          <div>
            <label>Year</label>
            <input type="number" id="rYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnRunQuarter">Run Quarterly Report</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="quarterOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Custom Period Report (any dates, optional member)</h3>
        <div class="grid-3">
          <div>
            <label>From (inclusive)</label>
            <input type="date" id="pFrom">
          </div>
          <div>
            <label>To (inclusive)</label>
            <input type="date" id="pTo">
          </div>
          <div>
            <label>Member filter</label>
            <select id="pMember"></select>
          </div>
        </div>
        <div class="right" style="align-items:end;margin-top:8px">
          <button class="btn primary" id="btnRunPeriod">Run Period Report</button>
          <button class="btn" id="btnPeriodCSV" disabled>Export CSV</button>
        </div>
        <div class="hr"></div>
        <div id="periodOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Member Statement (activity in period + current snapshot)</h3>
        <div class="grid-3">
          <div>
            <label>Member</label>
            <select id="msMember"></select>
          </div>
          <div>
            <label>From</label>
            <input type="date" id="msFrom">
          </div>
          <div>
            <label>To</label>
            <input type="date" id="msTo">
          </div>
        </div>
        <div class="right" style="align-items:end;margin-top:8px">
          <button class="btn primary" id="btnMemberStmt">Run Member Statement</button>
          <button class="btn" id="btnMemberCSV" disabled>Export CSV</button>
        </div>
        <div class="hr"></div>
        <div id="msOut"></div>
        <p class="help">“Current Snapshot” shows balances now; “Activity in Period” shows movements within the chosen dates.</p>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Year-End Profit Sharing</h3>
        <div class="grid-3">
          <div>
            <label>Year</label>
            <input type="number" id="yShareYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn ok" id="btnShareOut">Compute Distribution</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="shareOut"></div>
        <p class="help">Profits considered: <b>interest collected</b> from loans in that year. Shared to members <b>proportional to their share capital</b>.</p>
      </div>
    </section>

    <!-- DATA -->
    <section id="data" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 6;">
          <h3>Backup / Restore (JSON)</h3>
          <div class="stack">
            <button class="btn" id="btnBackup2">Export data (JSON)</button>
            <label class="btn"><input type="file" id="restoreFile2" accept="application/json" style="display:none">Import data</label>
          </div>
          <p class="help">JSON contains members, loans, welfare, transactions, registrar, and KYC details.</p>
          <div class="hr"></div>
          <h3>Excel (XLSX)</h3>
          <div class="stack">
            <button class="btn" id="btnExportXLSX">Export XLSX</button>
            <label class="btn"><input type="file" id="xlsImport" accept=".xlsx,.xlsb,.xls" style="display:none">Import XLSX</label>
            <label class="pill"><input type="checkbox" id="xlsMerge" checked> Merge newer only (recommended)</label>
          </div>
          <p class="help">Sheets: Members, Loans, Transactions, KYC. When “Merge newer only” is ON, Transactions with newer dates are appended; Members/Loans are updated or added.</p>
        </div>

        <div class="card" style="grid-column: span 6;">
          <h3>Google Drive Sync</h3>
          <div class="stack">
            <button class="btn primary" id="btnGSignIn">Sign in</button>
            <button class="btn bad" id="btnGSignOut" disabled>Sign out</button>
          </div>
          <div class="stack" style="margin-top:8px">
            <button class="btn ok" id="btnDriveSave" disabled>Save backup to Drive</button>
            <button class="btn" id="btnDriveLoad" disabled>Load latest backup from Drive</button>
          </div>
          <p class="help mono" id="driveStatus">Not signed in.</p>
          <div class="hr"></div>
          <h3>Self-Test</h3>
          <button class="btn warn" id="btnAddDummyData">Generate demo data</button>
          <p class="help">Adds a few members, a meeting, a loan and some repayments for testing.</p>
        </div>
      </div>
    </section>
  </main>

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>

<script>
/* ========= Utilities ========= */
const UGX = (v)=> new Intl.NumberFormat('en-UG', {style:'currency', currency:'UGX', maximumFractionDigits:0}).format(v||0);
const todayStr = ()=> new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Kampala' });
const parseDate = s => new Date(s+'T00:00:00');
const daysBetween = (a,b)=> Math.max(0, Math.round((parseDate(b)-parseDate(a)) / (1000*60*60*24)));
const clone = x => JSON.parse(JSON.stringify(x));
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function addMonths(dateStr, n){
  const d = new Date(dateStr+'T00:00:00'); d.setMonth(d.getMonth()+Number(n||0));
  return d.toISOString().slice(0,10);
}
function yyyMM(dateStr){ return String(dateStr||'').slice(0,7); }
function lastFullMonthYYYYMM(){ const d = new Date(); d.setDate(1); d.setMonth(d.getMonth()-1); return d.toISOString().slice(0,7); }
function monthStartEnd(yyyyMM){ const [y,m] = yyyyMM.split('-').map(Number); const from = new Date(y, m-1, 1).toISOString().slice(0,10); const to = new Date(y, m, 0).toISOString().slice(0,10); return [from,to]; }

/* ========= Data Model (localStorage) ========= */
const KEY='kibiina_v4';
let db = {};
try { db = JSON.parse(localStorage.getItem(KEY) || '{}'); }
catch(e){ console.warn('Local data corrupted. Resetting storage.', e); localStorage.removeItem(KEY); db = {}; }
if(!db.members){ // initialize
  db = {
    members: [],
    loans: [],
    welfareFund: 0,
    tx: [],
    registrar: [], // {id, date, type, memberNo?, amount, notes, fileIds:[]}
    kyc: {}, // { [memberNo]: {name, tribe, age, dob, phone, nokName, nokRel, nokPhone, appForm, passport, fileIds:[] } }
    settings: { lastMeetingDate: todayStr(), updatedAt: new Date().toISOString(), lastAccrualPosted: null, autoAccrualOnOpen: true }
  };
  save();
}
function save(){
  if(!db.settings) db.settings = {};
  db.settings.updatedAt = new Date().toISOString();
  localStorage.setItem(KEY, JSON.stringify(db));
}
function getMemberByNo(no){ return db.members.find(m => Number(m.number) === Number(no)); }
function ensureUniqueNo(no, ignoreId=null){ return !db.members.some(m=> Number(m.number)===Number(no) && m.id!==ignoreId); }
function nextFreeNo(){ for(let i=1;i<=30;i++){ if(!db.members.some(m=>Number(m.number)===i)) return i; } return null; }

/* ========= Tabs ========= */
function wireTabs(){
  const tabsEl = document.getElementById('tabs');
  if(!tabsEl) return;
  tabsEl.addEventListener('click', e=>{
    const b = e.target.closest('.tab'); if(!b) return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===b));
    document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id !== b.dataset.tab);
    if(b.dataset.tab==='dashboard') renderDashboard();
    if(b.dataset.tab==='members')   { fillMemberOptions('regMember', true); fillMemberOptions('kycMember', false); renderMembers(); renderKYCSummary(); }
    if(b.dataset.tab==='registrar') { fillMemberOptions('regMember', true); fillMemberOptions('kycMember', false); renderRegistrar(); renderKYCSummary(); }
    if(b.dataset.tab==='loans')     { accrueAll(); renderLoans(); }
    if(b.dataset.tab==='repay')     { accrueAll(); renderRepay(); }
    if(b.dataset.tab==='reports')   { accrueAll(); initReports(); }
    if(b.dataset.tab==='meeting')   initMeeting();
    if(b.dataset.tab==='data')      { /* nothing extra on open */ }
  });
}

/* ========= Dashboard ========= */
function renderDashboard(){
  const n = db.members.length;
  const shareCap = db.members.reduce((s,m)=> s + (m.shares||0)*3000, 0);
  const loansOut = db.loans.reduce((s,l)=> s + l.principalOut, 0);
  const year = new Date().getFullYear();
  const intYTD = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                      .reduce((s,t)=> s + t.amount, 0);
  const accrYTD = db.tx.filter(t => t.type==='interest_accrual' && new Date(t.ts).getFullYear()===year)
                       .reduce((s,t)=> s + t.amount, 0);
  const munnoAgg = db.members.reduce((s,m)=> s + (m.munno||0), 0);
  document.getElementById('statMembers').textContent = String(n);
  document.getElementById('statShareCap').textContent = UGX(shareCap);
  document.getElementById('statLoans').textContent = UGX(loansOut);
  document.getElementById('statInterestYTD').textContent = UGX(intYTD);
  document.getElementById('statAccruedYTD').textContent = UGX(accrYTD);
  document.getElementById('fundWelfare').textContent = UGX(db.welfareFund||0);
  document.getElementById('fundMunno').textContent = UGX(munnoAgg);
  document.getElementById('fundWelfare2').textContent = UGX(db.welfareFund||0);
  document.getElementById('fundMunno2').textContent = UGX(munnoAgg);
  document.getElementById('statLastAccPosted').textContent = db.settings?.lastAccrualPosted || '—';
}

/* ========= Members ========= */
let editingId = null;
function kycComplete(no){
  const k = db.kyc?.[Number(no)];
  if(!k) return false;
  return !!(k.appForm && k.passport && k.age && k.dob && (k.nokName || k.nokPhone));
}
function renderMembers(){
  const tbody = document.querySelector('#membersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const rows = [...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  rows.forEach((m)=>{
    const shareCap = (m.shares||0)*3000;
    const loan = db.loans.find(l=>Number(l.memberNo)===Number(m.number));
    const principalOut = loan? loan.principalOut : 0;
    const limit = Math.max(0, (shareCap*2) - principalOut);
    const kycTag = kycComplete(m.number) ? '<span class="kyc-chip ok">KYC ✓</span>' : '<span class="kyc-chip bad">KYC</span>';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.number||''}</td>
      <td>${m.name||''}</td>
      <td>${m.shares||0}</td>
      <td>${UGX(shareCap)}</td>
      <td>${UGX(m.munno||0)}</td>
      <td>${UGX(principalOut)}</td>
      <td>${UGX(limit)}</td>
      <td>${kycTag}</td>
      <td><button class="btn" data-edit="${m.id}">Edit</button></td>`;
    tbody.appendChild(tr);
  });
}
function resetMemberForm(){
  editingId=null;
  document.getElementById('mNo').value= nextFreeNo() || '';
  document.getElementById('mName').value='';
  document.getElementById('mShares').value=0;
  document.getElementById('mMunno').value=0;
  document.getElementById('mJoin').value=todayStr();
  document.getElementById('btnDeleteMember').disabled = true;
}
function wireMembers(){
  const table = document.getElementById('membersTable');
  if(table){
    table.addEventListener('click', e=>{
      const id = e.target.dataset.edit; if(!id) return;
      const m = db.members.find(x=>x.id===id);
      editingId = id;
      document.getElementById('mNo').value    = m.number||'';
      document.getElementById('mName').value  = m.name||'';
      document.getElementById('mShares').value= m.shares||0;
      document.getElementById('mMunno').value = m.munno||0;
      document.getElementById('mJoin').value  = m.joinDate||todayStr();
      document.getElementById('btnDeleteMember').disabled = false;
    });
  }
  const saveBtn = document.getElementById('btnSaveMember');
  if(saveBtn){
    saveBtn.onclick = ()=>{
      let number = parseInt(document.getElementById('mNo').value||0);
      if(!number){
        const nf = nextFreeNo();
        if(!nf){ alert('All numbers 1–30 are taken. Delete a member first.'); return; }
        number = nf; document.getElementById('mNo').value = nf;
      }
      if(number<1 || number>30){ alert('Member number must be between 1 and 30.'); return; }
      const name = document.getElementById('mName').value.trim();
      const shares = Math.min(10, Math.max(0, parseInt(document.getElementById('mShares').value||0)));
      const munno = Math.max(0, parseInt(document.getElementById('mMunno').value||0));
      const join = document.getElementById('mJoin').value || todayStr();
      if(!ensureUniqueNo(number, editingId)){ alert('That number is already assigned to another member.'); return; }
      if(!name){ alert('Enter member name'); return; }
      if(editingId){
        const m = db.members.find(x=>x.id===editingId);
        if(Number(m.number)!==number){
          db.loans.forEach(l=>{ if(Number(l.memberNo)===Number(m.number)) l.memberNo = number; });
          db.tx.forEach(t=>{ if(Number(t.memberNo)===Number(m.number)) t.memberNo = number; });
          if(db.kyc[m.number]){ db.kyc[number] = db.kyc[m.number]; delete db.kyc[m.number]; }
        }
        m.number=number; m.name=name; m.shares=shares; m.munno=munno; m.joinDate=join;
      }else{
        const id='m'+Math.random().toString(36).slice(2,9);
        db.members.push({id, number, name, shares, munno, joinDate:join});
      }
      save(); renderMembers(); renderDashboard(); resetMemberForm(); renderKYCSummary();
    };
  }
  const delBtn = document.getElementById('btnDeleteMember');
  if(delBtn){
    delBtn.onclick = ()=>{
      if(!editingId) return;
      const mem = db.members.find(x=>x.id===editingId);
      if(!confirm(`Delete member No. ${mem?.number}? This also removes loans.`)) return;
      db.loans = db.loans.filter(l=> Number(l.memberNo)!==Number(mem.number));
      delete db.kyc[mem.number];
      db.members = db.members.filter(m=>m.id!==editingId);
      save(); renderMembers(); renderDashboard(); resetMemberForm(); renderKYCSummary();
    };
  }
  const c30 = document.getElementById('btnCreate30');
  if(c30){
    c30.onclick = ()=>{
      if(db.members.length && !confirm('Replace current list with 30 numbered members (1–30)?')) return;
      db.members = [];
      db.loans = []; db.kyc = {};
      for(let i=1;i<=30;i++){
        const id='m'+Math.random().toString(36).slice(2,9);
        db.members.push({id, number:i, name:`Member ${i}`, shares:0, munno:0, joinDate:todayStr()});
      }
      save(); renderMembers(); renderDashboard(); renderKYCSummary();
    };
  }
}

/* ========= Meeting (Sunday) ========= */
function nextSundayStr(){ const d=new Date(); const day=d.getDay(); const diff=(7-day)%7; d.setDate(d.getDate()+diff); return d.toISOString().slice(0,10); }
function initMeeting(){
  const md = document.getElementById('meetDate'); if(md) md.value = db.settings.lastMeetingDate || nextSundayStr();
  const wp = document.getElementById('welfarePer'); if(wp) wp.value = 1500;
  const box = document.getElementById('meetingSheet'); if(box) box.innerHTML='';
  const pm = document.getElementById('btnPostMeeting'); if(pm) pm.disabled = true;
}
function wireMeeting(){
  const setSun = document.getElementById('btnTodaySunday');
  if(setSun) setSun.onclick = ()=>{ document.getElementById('meetDate').value = nextSundayStr(); };
  const start = document.getElementById('btnStartMeeting');
  if(start) start.onclick = ()=>{
    const date = document.getElementById('meetDate').value || todayStr();
    db.settings.lastMeetingDate = date; save();
    const per = parseInt(document.getElementById('welfarePer').value||1500);
    const box = document.getElementById('meetingSheet');
    if(db.members.length===0){ box.innerHTML='<div class="warnmsg">No members yet. Add members first.</div>'; return; }
    const sorted = [...db.members].sort((a,b)=> Number(a.number)-Number(b.number));
    let html = `<table class="table"><thead><tr>
        <th>No.</th><th>Name</th><th>Munno Deposit</th><th>Welfare (UGX ${per})</th><th>Buy Shares</th></tr></thead><tbody>`;
    sorted.forEach((m)=>{
      html += `<tr>
        <td>${m.number}</td>
        <td>${m.name}</td>
        <td><input type="number" min="0" step="1" id="in_munno_${m.number}" placeholder="0"></td>
        <td style="text-align:center"><input type="checkbox" id="in_wel_${m.number}" checked></td>
        <td><input type="number" min="0" max="${Math.max(0,10-(m.shares||0))}" step="1" id="in_share_${m.number}" placeholder="0"></td>
      </tr>`;
    });
    html += '</tbody></table>';
    box.innerHTML = html;
    document.getElementById('btnPostMeeting').disabled = false;
  };
  const post = document.getElementById('btnPostMeeting');
  if(post) post.onclick = ()=>{
    const date = document.getElementById('meetDate').value || todayStr();
    const per = parseInt(document.getElementById('welfarePer').value||1500);
    accrueAll(date);
    db.members.forEach(m=>{
      const munno = parseInt(document.getElementById(`in_munno_${m.number}`).value||0);
      const wel = document.getElementById(`in_wel_${m.number}`).checked;
      const sharesBuy = Math.min(10-(m.shares||0), Math.max(0, parseInt(document.getElementById(`in_share_${m.number}`).value||0)));
      if(munno>0){
        m.munno = (m.munno||0) + munno;
        db.tx.push({ts:date, type:'munno_deposit', memberNo:m.number, amount:munno});
      }
      if(wel){
        db.welfareFund = (db.welfareFund||0) + per;
        db.tx.push({ts:date, type:'welfare', memberNo:m.number, amount:per});
      }
      if(sharesBuy>0){
        m.shares = (m.shares||0) + sharesBuy;
        db.tx.push({ts:date, type:'share_buy', memberNo:m.number, amount: sharesBuy*3000, meta:{shares:sharesBuy}});
      }
    });
    save(); initMeeting(); renderDashboard(); alert('Meeting posted.');
  };
}

/* ========= Loans ========= */
function loanRateFor(amount){ if(amount>=1 && amount<=3999999) return 0.025; if(amount>=4000000) return 0.02; return 0; }

// Accrues interest daily onto l.accruedInterest up to date (inclusive end-1 day semantics)
function accrueAll(upToDate){
  const dTo = upToDate || todayStr();
  db.loans.forEach(l=>{
    if(l.principalOut<=0) return;
    const start = l.lastAccrual || l.startDate;
    const days = daysBetween(start, dTo);
    if(days<=0) return;
    const dailyRate = l.rateMonthly/30;
    const add = l.principalOut * dailyRate * days;
    l.accruedInterest = (l.accruedInterest||0) + Math.round(add);
    l.lastAccrual = dTo;
  });
  save();
}

function renderLoans(){
  const sel = document.getElementById('loanMember'); if(!sel) return;
  const sorted=[...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = sorted.map(m=>`<option value="${m.number}">${m.number} – ${m.name}</option>`).join('');
  document.getElementById('loanAmt').value='';
  document.getElementById('loanDate').value = todayStr();
  document.getElementById('loanTerm').value = 3;
  document.getElementById('loanHint').textContent='';

  const tbody = document.querySelector('#loansTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  db.loans.forEach(l=>{
    const m = getMemberByNo(l.memberNo);
    const monthlyInt = Math.round((l.principalOut||0) * (l.rateMonthly||0));
    const termInt = (l.termMonths? monthlyInt * l.termMonths : 0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${l.memberNo}</td>
      <td>${m? m.name:''}</td>
      <td>${UGX(l.principalOut)}</td>
      <td>${UGX(l.accruedInterest||0)}</td>
      <td>${(l.rateMonthly*100).toFixed(2)}%/mo</td>
      <td>${l.startDate}</td>
      <td>${l.termMonths||''}</td>
      <td>${l.endDate||''}</td>
      <td>${UGX(monthlyInt)}</td>
      <td>${termInt? UGX(termInt): ''}</td>`;
    tbody.appendChild(tr);
  });
}

function updateLoanHint(){
  const no = document.getElementById('loanMember').value;
  const m = getMemberByNo(no); if(!m){ document.getElementById('loanHint').textContent=''; return; }
  const amount = parseInt(document.getElementById('loanAmt').value||0);
  const term = parseInt(document.getElementById('loanTerm').value||0);
  const date = document.getElementById('loanDate').value || todayStr();

  const shareCap = (m.shares||0)*3000;
  const currentLoan = db.loans.find(l=>Number(l.memberNo)===Number(no));
  const principalOut = currentLoan? currentLoan.principalOut : 0;
  const limit = Math.max(0, shareCap*2 - principalOut);
  const rate = loanRateFor(amount) || 0;

  const monthlyInt = amount>0 ? Math.round(amount*rate) : 0;
  const termInt = (amount>0 && term>0) ? monthlyInt*term : 0;
  const end = term>0 ? addMonths(date, term) : '';

  document.getElementById('loanHint').innerHTML =
    `Share capital: <b>${UGX(shareCap)}</b> → Limit: <b>${UGX(limit)}</b> • Rate: <b>${(rate*100)||0}%/mo</b>`+
    ` • Monthly interest: <b>${UGX(monthlyInt)}</b>`+
    (term>0 ? ` • Term total: <b>${UGX(termInt)}</b> • Maturity: <b>${end}</b>` : '');
}

function wireLoans(){
  const amt = document.getElementById('loanAmt');
  const term = document.getElementById('loanTerm');
  const date = document.getElementById('loanDate');
  const memberSel = document.getElementById('loanMember');
  [amt, term, date, memberSel].forEach(el=> el && el.addEventListener('input', updateLoanHint));

  const issue = document.getElementById('btnIssueLoan');
  if(issue){
    issue.onclick = ()=>{
      const memberNo = document.getElementById('loanMember').value;
      const m = getMemberByNo(memberNo);
      if(!m){ alert('Select member'); return; }
      const amount = parseInt(document.getElementById('loanAmt').value||0);
      const months = parseInt(document.getElementById('loanTerm').value||0);
      const date = document.getElementById('loanDate').value || todayStr();
      if(amount<=0){ alert('Enter amount'); return; }
      if(months<=0){ alert('Enter term (months)'); return; }
      const current = db.loans.find(l=>Number(l.memberNo)===Number(memberNo));
      const principalOut = current? current.principalOut : 0;
      const limit = Math.max(0, ((m.shares||0)*3000)*2 - principalOut);
      if(amount>limit){ alert('Amount exceeds limit.'); return; }
      const rate = loanRateFor(amount);
      accrueAll(date);
      if(current){
        current.principalOut += amount;
        current.termMonths = months; current.endDate = addMonths(date, months);
        if(!current.rateMonthly) current.rateMonthly = rate;
        db.tx.push({ts:date, type:'loan_topup', memberNo, amount});
      } else {
        db.loans.push({ id:'L'+Math.random().toString(36).slice(2,9), memberNo, principalOut:amount, rateMonthly:rate, startDate:date, lastAccrual:date, accruedInterest:0, termMonths:months, endDate:addMonths(date, months) });
        db.tx.push({ts:date, type:'loan_issue', memberNo, amount});
      }
      save(); renderLoans(); renderDashboard(); alert('Loan recorded.');
    };
  }
}

/* ========= Repayments ========= */
function renderRepay(){
  const sel = document.getElementById('rpMember'); if(!sel) return;
  const withLoans = db.members.filter(m=> db.loans.find(l=>Number(l.memberNo)===Number(m.number) && (l.principalOut>0 || (l.accruedInterest||0)>0)));
  const sorted=[...withLoans].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = sorted.map(m=>`<option value="${m.number}">${m.number} – ${m.name}</option>`).join('');
  document.getElementById('rpAmt').value='';
  document.getElementById('rpDate').value = todayStr();
  document.getElementById('rpApply').value = 'auto';
  const tbody = document.querySelector('#txTable tbody'); if(!tbody) return;
  const last = clone(db.tx).sort((a,b)=> new Date(b.ts) - new Date(a.ts)).slice(0,15);
  tbody.innerHTML = last.map(t=>{
    const m = getMemberByNo(t.memberNo);
    return `<tr><td>${t.ts}</td><td>${t.memberNo||''}</td><td>${m?m.name:''}</td><td>${t.type}</td><td>${UGX(t.amount)}</td></tr>`;
  }).join('');
}
function wireRepay(){
  const post = document.getElementById('btnPostRepay');
  if(post){
    post.onclick = ()=>{
      const memberNo = document.getElementById('rpMember').value;
      const amt = parseInt(document.getElementById('rpAmt').value||0);
      const date = document.getElementById('rpDate').value || todayStr();
      const how = document.getElementById('rpApply').value;
      if(amt<=0){ alert('Enter amount'); return; }
      const loan = db.loans.find(l=>Number(l.memberNo)===Number(memberNo));
      if(!loan){ alert('No active loan'); return; }
      accrueAll(date);
      let remain = amt;
      if(how==='auto' || how==='interest'){
        const payInt = Math.min(loan.accruedInterest||0, remain);
        if(payInt>0){ loan.accruedInterest -= payInt; db.tx.push({ts:date, type:'repay_interest', memberNo, amount:payInt}); remain -= payInt; }
      }
      if((how==='auto' || how==='principal') && remain>0){
        const payP = Math.min(loan.principalOut, remain);
        if(payP>0){ loan.principalOut -= payP; db.tx.push({ts:date, type:'repay_principal', memberNo, amount:payP}); remain -= payP; }
      }
      save(); renderRepay(); renderLoans(); renderDashboard(); alert('Repayment posted.');
    };
  }
}

/* ========= Interest Accrual Posting (Accounting) ========= */
// Sum interest accrued by simulation in a period (daily) for member's current loan.
function interestAccruedInPeriod(from, to, memberNo){
  const l = db.loans.find(x=> Number(x.memberNo)===Number(memberNo));
  if(!l || !l.rateMonthly) return 0;
  const dailyRate = l.rateMonthly/30;

  // Collect principal-changing events up to 'to'
  const events = db.tx.filter(t=> Number(t.memberNo)===Number(memberNo) &&
    (t.type==='loan_issue'||t.type==='loan_topup'||t.type==='repay_principal') &&
    t.ts && t.ts<=to).map(t=> ({date:t.ts, delta: (t.type==='repay_principal'? -t.amount: t.amount)}));

  // Initial principal at 'from' (apply all changes before from)
  let principal = 0;
  events.filter(e=> e.date<from).forEach(e=> principal += e.delta);
  // If loan existed before tx history, fallback to l.principalOut approximations: ignore (we rely on tx)

  const cutEvents = events.filter(e=> e.date>=from && e.date<=to).sort((a,b)=> new Date(a.date)-new Date(b.date));
  let curStart = from;
  let total = 0;

  function spanDays(a,b){ const d = daysBetween(a,b); return d; } // daily accrual from a up to b (exclusive of b day-end)

  for(const ev of cutEvents){
    if(ev.date>curStart){
      const d = spanDays(curStart, ev.date);
      if(d>0) total += Math.round(principal * dailyRate * d);
      curStart = ev.date;
    }
    principal += ev.delta;
  }
  // Final span to 'to'
  if(curStart<=to){
    const d = spanDays(curStart, to);
    if(d>0) total += Math.round(principal * dailyRate * d);
  }
  return Math.max(0, total);
}

function postedAccrualFor(memberNo, from, to){
  return db.tx.filter(t=> t.type==='interest_accrual' && Number(t.memberNo)===Number(memberNo) && t.ts && t.ts>=from && t.ts<=to)
              .reduce((s,t)=> s+t.amount, 0);
}

function earliestLoanStart(){
  let min = null;
  db.loans.forEach(l=>{ if(l.startDate && (!min || l.startDate<min)) min = l.startDate; });
  return min;
}

function nextYYYYMM(curYM){
  const [y,m] = curYM.split('-').map(Number);
  const d = new Date(y, m, 1);
  return d.toISOString().slice(0,7);
}

// Posts missing interest_accrual entries month-by-month up to last full month.
function autoPostMissingAccrualsOnOpen(){
  if(!db.settings) db.settings = {};
  if(db.settings.autoAccrualOnOpen === false) return;

  const goal = lastFullMonthYYYYMM();
  const start = db.settings.lastAccrualPosted || earliestLoanStart();
  if(!goal || !start) return;

  let curYM = yyyMM(start);
  let anyPosted = false;

  while(curYM <= goal){
    const [from,to] = monthStartEnd(curYM);
    db.members.forEach(m=>{
      const accrued = interestAccruedInPeriod(from,to,m.number);
      const already = postedAccrualFor(m.number, from, to);
      const toPost = Math.max(0, accrued - already);
      if(toPost>0){
        db.tx.push({ts:to, type:'interest_accrual', memberNo:m.number, amount:toPost});
        anyPosted = true;
      }
    });
    curYM = nextYYYYMM(curYM);
  }
  db.settings.lastAccrualPosted = goal;
  if(anyPosted){ save(); }
}

/* ========= Reports ========= */
function initReports(){
  const y = new Date().getFullYear();
  document.getElementById('rYear').value = y;
  document.getElementById('yShareYear').value = y;
  document.getElementById('quarterOut').innerHTML='';
  document.getElementById('shareOut').innerHTML='';
  const from = new Date(y,0,1).toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const to   = new Date().toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const pF = document.getElementById('pFrom'); if(pF) pF.value = from;
  const pT = document.getElementById('pTo');   if(pT) pT.value = to;
  fillMemberOptions('pMember', true);
  fillMemberOptions('msMember', false);
  const msF = document.getElementById('msFrom'); if(msF) msF.value = from;
  const msT = document.getElementById('msTo');   if(msT) msT.value = to;
  document.getElementById('periodOut').innerHTML='';
  document.getElementById('msOut').innerHTML='';
  document.getElementById('btnPeriodCSV').disabled = true;
  document.getElementById('btnMemberCSV').disabled = true;
}
function fillMemberOptions(selectId, includeAll){
  const sel = document.getElementById(selectId); if(!sel) return;
  const rows = [...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = (includeAll? `<option value="all">All Members</option>` : '') +
    rows.map(m=>`<option value="${m.number}">${m.number} – ${m.name||''}</option>`).join('');
  if(!includeAll && rows.length) sel.value = String(rows[0].number);
}
function quarterRange(q, year){
  const y=Number(year);
  if(q==='Q1') return [new Date(y,0,1), new Date(y,2,31)];
  if(q==='Q2') return [new Date(y,3,1), new Date(y,5,30)];
  if(q==='Q3') return [new Date(y,6,1), new Date(y,8,30)];
  return [new Date(y,9,1), new Date(y,11,31)];
}
function wireReports(){
  const runQ = document.getElementById('btnRunQuarter');
  if(runQ){
    runQ.onclick = ()=>{
      const q = document.getElementById('rQuarter').value;
      const y = parseInt(document.getElementById('rYear').value||new Date().getFullYear());
      const [a,b] = quarterRange(q,y);
      const inRange = t => { const d = new Date(t.ts); return d>=a && d<=b; };
      const welfare = db.tx.filter(t=>t.type==='welfare' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const munno = db.tx.filter(t=>t.type==='munno_deposit' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const shares = db.tx.filter(t=>t.type==='share_buy' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const interestRec = db.tx.filter(t=>t.type==='repay_interest' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const interestAcc = db.tx.filter(t=>t.type==='interest_accrual' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const principalRec = db.tx.filter(t=>t.type==='repay_principal' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const loansOut = db.tx.filter(t=>(t.type==='loan_issue'||t.type==='loan_topup') && inRange(t)).reduce((s,t)=>s+t.amount,0);
      document.getElementById('quarterOut').innerHTML = `
        <div class="grid-3">
          <div class="stat"><span class="muted">Welfare contributions</span><b>${UGX(welfare)}</b></div>
          <div class="stat"><span class="muted">Munno deposits</span><b>${UGX(munno)}</b></div>
          <div class="stat"><span class="muted">Shares purchased</span><b>${UGX(shares)}</b></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div class="stat"><span class="muted">Loans issued/topups</span><b>${UGX(loansOut)}</b></div>
          <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(principalRec)}</b></div>
          <div class="stat"><span class="muted">Interest collected</span><b>${UGX(interestRec)}</b></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div class="stat"><span class="muted">Interest accrued</span><b>${UGX(interestAcc)}</b></div>
          <div class="stat"><span class="muted">Txn count</span><b>${db.tx.filter(inRange).length}</b></div>
          <div class="stat"><span class="muted">Active loans</span><b>${db.loans.filter(l=>l.principalOut>0).length}</b></div>
        </div>
      `;
    };
  }
  const btnP = document.getElementById('btnRunPeriod'); if(btnP) btnP.onclick = renderPeriodReport;
  const btnPCSV = document.getElementById('btnPeriodCSV'); if(btnPCSV) btnPCSV.onclick = exportPeriodCSV;
  const btnMS = document.getElementById('btnMemberStmt'); if(btnMS) btnMS.onclick = renderMemberStatement;
  const btnMSCSV = document.getElementById('btnMemberCSV'); if(btnMSCSV) btnMSCSV.onclick = exportMemberCSV;
  const share = document.getElementById('btnShareOut');
  if(share){
    share.onclick = ()=>{
      const year = parseInt(document.getElementById('yShareYear').value||new Date().getFullYear());
      const totalInterest = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                                 .reduce((s,t)=>s+t.amount,0);
      const members = clone(db.members).map(m=> ({...m, shareCap:(m.shares||0)*3000}));
      const pool = members.reduce((s,m)=> s+m.shareCap, 0);
      let html = `<div class="stat"><span class="muted">Total interest (year)</span><b>${UGX(totalInterest)}</b></div>`;
      if(pool<=0 || totalInterest<=0){
        html += `<p class="warnmsg" style="margin-top:8px">No share capital or no interest collected for ${year}.</p>`;
      }else{
        html += `<table class="table" style="margin-top:8px"><thead><tr><th>No.</th><th>Name</th><th>Shares</th><th>Share Capital</th><th>Share %</th><th>Payout</th></tr></thead><tbody>`;
        members.sort((a,b)=>Number(a.number)-Number(b.number)).forEach(m=>{
          const pct = m.shareCap/pool;
          const pay = Math.round(totalInterest * pct);
          html += `<tr><td>${m.number||''}</td><td>${m.name}</td><td>${m.shares||0}</td><td>${UGX(m.shareCap)}</td><td>${(pct*100).toFixed(2)}%</td><td>${UGX(pay)}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      document.getElementById('shareOut').innerHTML = html;
    };
  }
}
/* ===== Period helpers ===== */
function normalizeRange(fromStr, toStr){
  const defFrom = new Date(new Date().getFullYear(),0,1).toLocaleDateString('en-CA',{timeZone:'Africa/Kampala'});
  const defTo   = todayStr();
  const from = fromStr || defFrom;
  const to   = toStr   || defTo;
  const a = new Date(from); const b = new Date(to);
  if(isNaN(a) || isNaN(b)) return [defFrom, defTo];
  return (a>b) ? [to, from] : [from, to];
}
function inRange(ts, from, to){ const d = new Date(ts); return d>=new Date(from) && d<=new Date(to); }
function sumPeriod(from, to, memberNoOrAll='all'){
  const isAll = memberNoOrAll==='all';
  const sums = {
    welfare:0, munnoDep:0, munnoReturned:0, munnoTaken:0,
    sharesUGX:0, sharesCount:0,
    loanIssue:0, loanTopup:0, loanTaken:0,
    repayPrincipal:0, repayInterest:0, interestAccrual:0,
    fines:0, loanForm:0, txCount:0
  };
  const perMember = {};
  const addMemberRow = (no)=> perMember[no]||(perMember[no]={ No:no, Name:(getMemberByNo(no)?.name)||'',
    Welfare:0, Munno:0, MunnoReturned:0, MunnoTaken:0, SharesUGX:0, SharesCount:0, LoanTaken:0, PrincipalRepaid:0, InterestPaid:0, InterestAccrued:0, Fines:0, LoanForm:0 });

  db.tx.forEach(t=>{
    if(!t.ts || !inRange(t.ts, from, to)) return;
    if(!isAll && Number(t.memberNo)!==Number(memberNoOrAll)) return;
    const no = Number(t.memberNo)||0;
    sums.txCount++;
    switch(t.type){
      case 'welfare': sums.welfare+=t.amount; if(no){addMemberRow(no); perMember[no].Welfare+=t.amount;} break;
      case 'munno_deposit': sums.munnoDep+=t.amount; if(no){addMemberRow(no); perMember[no].Munno+=t.amount;} break;
      case 'munno_returned': case 'munno_withdraw':
        sums.munnoReturned+=t.amount; if(no){addMemberRow(no); perMember[no].MunnoReturned+=t.amount;} break;
      case 'munno_taken':
        sums.munnoTaken+=t.amount; if(no){addMemberRow(no); perMember[no].MunnoTaken+=t.amount;} break;
      case 'share_buy':
        sums.sharesUGX+=t.amount; sums.sharesCount += (t.meta?.shares||0);
        if(no){addMemberRow(no); perMember[no].SharesUGX+=t.amount; perMember[no].SharesCount+=(t.meta?.shares||0);} break;
      case 'loan_issue':
        sums.loanIssue+=t.amount; sums.loanTaken+=t.amount;
        if(no){addMemberRow(no); perMember[no].LoanTaken+=t.amount;} break;
      case 'loan_topup':
        sums.loanTopup+=t.amount; sums.loanTaken+=t.amount;
        if(no){addMemberRow(no); perMember[no].LoanTaken+=t.amount;} break;
      case 'repay_principal':
        sums.repayPrincipal+=t.amount; if(no){addMemberRow(no); perMember[no].PrincipalRepaid+=t.amount;} break;
      case 'repay_interest':
        sums.repayInterest+=t.amount; if(no){addMemberRow(no); perMember[no].InterestPaid+=t.amount;} break;
      case 'interest_accrual':
        sums.interestAccrual+=t.amount; if(no){addMemberRow(no); perMember[no].InterestAccrued+=t.amount;} break;
      case 'fine':
        sums.fines+=t.amount; if(no){addMemberRow(no); perMember[no].Fines+=t.amount;} break;
      case 'loan_form_fee':
        sums.loanForm+=t.amount; if(no){addMemberRow(no); perMember[no].LoanForm+=t.amount;} break;
    }
  });
  return { sums, perMember: Object.values(perMember).sort((a,b)=>a.No-b.No) };
}
/* ===== Render: Custom Period ===== */
let lastPeriodCSVRows = null;
function renderPeriodReport(){
  const [from, to] = normalizeRange(
    document.getElementById('pFrom').value,
    document.getElementById('pTo').value
  );
  const who = document.getElementById('pMember').value || 'all';
  const { sums, perMember } = sumPeriod(from, to, who);

  let html = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Dates</span><b>${from} → ${to}</b></div>
      <div class="stat"><span class="muted">Transactions</span><b>${sums.txCount}</b></div>
      <div class="stat"><span class="muted">Interest collected</span><b>${UGX(sums.repayInterest)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Interest accrued</span><b>${UGX(sums.interestAccrual)}</b></div>
      <div class="stat"><span class="muted">Welfare</span><b>${UGX(sums.welfare)}</b></div>
      <div class="stat"><span class="muted">Munno deposits</span><b>${UGX(sums.munnoDep)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Munno returned</span><b>${UGX(sums.munnoReturned)}</b></div>
      <div class="stat"><span class="muted">Shares (UGX)</span><b>${UGX(sums.sharesUGX)}</b></div>
      <div class="stat"><span class="muted">Shares (count)</span><b>${sums.sharesCount}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Loans issued</span><b>${UGX(sums.loanIssue)}</b></div>
      <div class="stat"><span class="muted">Loan topups</span><b>${UGX(sums.loanTopup)}</b></div>
      <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(sums.repayPrincipal)}</b></div>
    </div>
  `;

  if(who==='all' && perMember.length){
    html += `
      <h4 style="margin-top:12px">Per-member breakdown</h4>
      <table class="table">
        <thead>
          <tr>
            <th>No.</th><th>Name</th>
            <th>Welfare</th><th>Munno +</th><th>Munno Returned</th><th>Munno Taken</th>
            <th>Shares (UGX)</th><th>Shares (#)</th>
            <th>Loans Taken</th><th>Principal Repaid</th><th>Interest Paid</th><th>Interest Accrued</th><th>Fines</th><th>Loan Form</th>
          </tr>
        </thead>
        <tbody>
          ${perMember.map(r=>`
            <tr>
              <td>${r.No}</td><td>${r.Name}</td>
              <td>${UGX(r.Welfare)}</td><td>${UGX(r.Munno)}</td><td>${UGX(r.MunnoReturned)}</td><td>${UGX(r.MunnoTaken)}</td>
              <td>${UGX(r.SharesUGX)}</td><td>${r.SharesCount}</td>
              <td>${UGX(r.LoanTaken)}</td><td>${UGX(r.PrincipalRepaid)}</td><td>${UGX(r.InterestPaid)}</td><td>${UGX(r.InterestAccrued)}</td><td>${UGX(r.Fines)}</td><td>${UGX(r.LoanForm)}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    `;
    lastPeriodCSVRows = [
      ['From',from,'To',to],
      [],
      ['No','Name','Welfare','Munno+','MunnoReturned','MunnoTaken','SharesUGX','SharesCount','LoanTaken','PrincipalRepaid','InterestPaid','InterestAccrued','Fines','LoanForm'],
      ...perMember.map(r=>[r.No,r.Name,r.Welfare,r.Munno,r.MunnoReturned,r.MunnoTaken,r.SharesUGX,r.SharesCount,r.LoanTaken,r.PrincipalRepaid,r.InterestPaid,r.InterestAccrued,r.Fines,r.LoanForm])
    ];
    document.getElementById('btnPeriodCSV').disabled = false;
  }else{
    lastPeriodCSVRows = null;
    document.getElementById('btnPeriodCSV').disabled = true;
  }

  document.getElementById('periodOut').innerHTML = html;
}
function toCSV(rows){
  return rows.map(r=>r.map(v=>{
    const s = (v===undefined||v===null)? '' : String(v);
    if(s.includes(',')||s.includes('"')||s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(',')).join('\n');
}
function exportPeriodCSV(){
  if(!lastPeriodCSVRows){ alert('Run an all-members period report first.'); return; }
  const csv = toCSV(lastPeriodCSVRows);
  download('period-report.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
}

/* ===== Member Statement ===== */
let lastMemberCSVRows = null;
function currentSnapshotFor(no){
  accrueAll(todayStr());
  const m = getMemberByNo(no);
  const loan = db.loans.find(l=>Number(l.memberNo)===Number(no));
  return {
    shares: m?.shares||0,
    shareCap: (m?.shares||0)*3000,
    munno: m?.munno||0,
    principalOut: loan?.principalOut||0,
    accruedInterest: loan?.accruedInterest||0
  };
}
function txForMemberInRange(no, from, to){
  return db.tx.filter(t=> Number(t.memberNo)===Number(no) && t.ts && inRange(t.ts, from, to))
              .sort((a,b)=> new Date(a.ts)-new Date(b.ts));
}
function renderMemberStatement(){
  const sel = document.getElementById('msMember'); if(!sel||!sel.value){ alert('Choose a member'); return; }
  const no = Number(sel.value);
  const [from, to] = normalizeRange(document.getElementById('msFrom').value, document.getElementById('msTo').value);
  const person = getMemberByNo(no);
  const { sums } = sumPeriod(from, to, no);
  const snap = currentSnapshotFor(no);
  const tx = txForMemberInRange(no, from, to);

  let html = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Member</span><b>${no} – ${person?.name||''}</b></div>
      <div class="stat"><span class="muted">Period</span><b>${from} → ${to}</b></div>
      <div class="stat"><span class="muted">Transactions in period</span><b>${tx.length}</b></div>
    </div>
    <h4 style="margin-top:10px">Current Snapshot (now)</h4>
    <div class="grid-3">
      <div class="stat"><span class="muted">Shares</span><b>${snap.shares} (UGX ${UGX(snap.shareCap).replace('UGX ','')})</b></div>
      <div class="stat"><span class="muted">Munno balance</span><b>${UGX(snap.munno)}</b></div>
      <div class="stat"><span class="muted">Loan O/S • Interest O/S</span><b>${UGX(snap.principalOut)} • ${UGX(snap.accruedInterest)}</b></div>
    </div>
    <h4 style="margin-top:10px">Activity in Period</h4>
    <div class="grid-3">
      <div class="stat"><span class="muted">Welfare</span><b>${UGX(sums.welfare)}</b></div>
      <div class="stat"><span class="muted">Munno +</span><b>${UGX(sums.munnoDep)}</b></div>
      <div class="stat"><span class="muted">Munno returned</span><b>${UGX(sums.munnoReturned)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Shares (UGX)</span><b>${UGX(sums.sharesUGX)}</b></div>
      <div class="stat"><span class="muted">Shares (count)</span><b>${sums.sharesCount}</b></div>
      <div class="stat"><span class="muted">Fines</span><b>${UGX(sums.fines)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Loans taken</span><b>${UGX(sums.loanTaken)}</b></div>
      <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(sums.repayPrincipal)}</b></div>
      <div class="stat"><span class="muted">Interest paid • Accrued</span><b>${UGX(sums.repayInterest)} • ${UGX(sums.interestAccrual)}</b></div>
    </div>
    <h4 style="margin-top:12px">Transactions (${tx.length})</h4>
    <table class="table">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Meta</th></tr></thead>
      <tbody>
        ${tx.map(t=>`<tr><td>${t.ts}</td><td>${t.type}</td><td>${UGX(t.amount)}</td><td>${t.meta?JSON.stringify(t.meta):''}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('msOut').innerHTML = html;
  lastMemberCSVRows = [
    ['Member', `${no} – ${person?.name||''}`],
    ['From', from, 'To', to],
    [],
    ['Date','Type','Amount','Meta'],
    ...tx.map(t=>[t.ts, t.type, t.amount, t.meta? JSON.stringify(t.meta): ''])
  ];
  document.getElementById('btnMemberCSV').disabled = (tx.length===0);
}
function exportMemberCSV(){
  if(!lastMemberCSVRows){ alert('Run a member statement first.'); return; }
  const csv = toCSV(lastMemberCSVRows);
  download('member-statement.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
}

/* ========= Backup/Restore (JSON) ========= */
function doBackup(){
  const blob = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
  download(`kibiina-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`, blob);
}
function handleRestore(file){
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result);
      if(!obj || !obj.members || !obj.tx || !obj.loans){ alert('Invalid backup file.'); return; }
      if(!confirm('Restore will REPLACE your current data. Continue?')) return;
      db = obj; if(!db.kyc) db.kyc = {}; if(!db.settings) db.settings = { lastMeetingDate: todayStr(), lastAccrualPosted:null, autoAccrualOnOpen:true };
      save();
      renderAll();
      alert('Data restored.');
    }catch(e){ alert('Failed to parse backup: '+e.message); }
  };
  r.readAsText(file);
}
function wireBackup(){
  const b1 = document.getElementById('btnBackup'); if(b1) b1.onclick = doBackup;
  const b2 = document.getElementById('btnBackup2'); if(b2) b2.onclick = doBackup;
  const r1 = document.getElementById('restoreFile'); if(r1) r1.onchange = e=> e.target.files[0] && handleRestore(e.target.files[0]);
  const r2 = document.getElementById('restoreFile2'); if(r2) r2.onchange = e=> e.target.files[0] && handleRestore(e.target.files[0]);
}

/* ========= Excel (SheetJS) ========= */
function exportXLSX(){
  const wb = XLSX.utils.book_new();
  const members = db.members.map(m=>({Number:m.number, Name:m.name, Shares:m.shares, ShareCapital:(m.shares||0)*3000, Munno:m.munno, JoinDate:m.joinDate}));
  const loans = db.loans.map(l=>({MemberNo:l.memberNo, PrincipalOut:l.principalOut, RateMonthly:l.rateMonthly, StartDate:l.startDate, LastAccrual:l.lastAccrual, AccruedInterest:l.accruedInterest||0, TermMonths:l.termMonths||'', EndDate:l.endDate||''}));
  const tx = db.tx.map(t=>({Date:t.ts, Type:t.type, MemberNo:t.memberNo||'', Amount:t.amount, Meta: t.meta? JSON.stringify(t.meta): ''}));
  const kycRows = Object.entries(db.kyc||{}).map(([no,k])=>({
    MemberNo:Number(no), Name:k.name||'', Tribe:k.tribe||'', Age:k.age||'', DOB:k.dob||'', Phone:k.phone||'',
    NOK_Name:k.nokName||'', NOK_Rel:k.nokRel||'', NOK_Phone:k.nokPhone||'', AppForm:k.appForm? 'Yes':'No', Passport:k.passport? 'Yes':'No'
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(members), 'Members');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(loans), 'Loans');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(tx), 'Transactions');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(kycRows), 'KYC');
  XLSX.writeFile(wb, `kibiina-${new Date().toISOString().slice(0,10)}.xlsx`);
}
function importXLSX(file){
  const mergeMode = document.getElementById('xlsMerge')?.checked !== false; // default true
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const data = new Uint8Array(r.result);
      const wb = XLSX.read(data, {type:'array'});
      const S = (name)=> wb.Sheets[name];
      const J = (name)=> XLSX.utils.sheet_to_json(S(name)||{}, {defval:''});
      const mRows = J('Members'), lRows = J('Loans'), tRows = J('Transactions'), kRows = J('KYC');

      if(!mRows.length){ alert('Members sheet missing or empty.'); return; }
      if(!mergeMode && !confirm('Importing XLSX will REPLACE your current data. Continue?')) return;

      if(!mergeMode){
        const members = mRows.map(x=>{
          const id='m'+Math.random().toString(36).slice(2,9);
          return {id, number:Number(x.Number)||0, name:String(x.Name||''), shares:Number(x.Shares)||0, munno:Number(x.Munno)||0, joinDate:String(x.JoinDate||todayStr())}
        }).filter(m=>m.number>=1 && m.number<=30 && m.name);
        const loans = lRows.filter(x=>x.MemberNo).map(x=>({
          id:'L'+Math.random().toString(36).slice(2,9),
          memberNo:Number(x.MemberNo),
          principalOut:Number(x.PrincipalOut)||0,
          rateMonthly:Number(x.RateMonthly)||0.02,
          startDate:String(x.StartDate||todayStr()),
          lastAccrual:String(x.LastAccrual||x.StartDate||todayStr()),
          accruedInterest:Number(x.AccruedInterest)||0,
          termMonths:Number(x.TermMonths)||'',
          endDate:String(x.EndDate||'')
        }));
        const tx = tRows.filter(x=>x.Date && x.Type).map(x=>({
          ts:String(x.Date), type:String(x.Type), memberNo: x.MemberNo? Number(x.MemberNo): undefined, amount:Number(x.Amount)||0,
          meta: (()=>{ try{return x.Meta? JSON.parse(x.Meta): undefined;}catch{return undefined;} })()
        }));
        const kyc = {};
        (kRows||[]).forEach(k=>{
          const no = Number(k.MemberNo); if(!no) return;
          kyc[no] = {
            name: k.Name||'', tribe:k.Tribe||'', age:Number(k.Age)||'', dob:String(k.DOB||''), phone:String(k.Phone||''),
            nokName:k.NOK_Name||'', nokRel:k.NOK_Rel||'', nokPhone:String(k.NOK_Phone||''), appForm: String(k.AppForm).toLowerCase()==='yes', passport: String(k.Passport).toLowerCase()==='yes', fileIds: (db.kyc?.[no]?.fileIds)||[]
          };
        });
        db = {members, loans, welfareFund:0, tx, registrar:[], kyc, settings:{ lastMeetingDate: todayStr(), updatedAt:new Date().toISOString(), lastAccrualPosted:null, autoAccrualOnOpen:true }};
        save(); renderAll(); alert('XLSX imported (replace).');
        return;
      }

      // MERGE MODE: update/add members & loans; append transactions with newer dates only; merge KYC fields.
      // Members
      mRows.forEach(x=>{
        const number = Number(x.Number)||0; if(number<1||number>30) return;
        const name = String(x.Name||''); const shares=Number(x.Shares)||0; const munno=Number(x.Munno)||0; const joinDate=String(x.JoinDate||todayStr());
        let m = db.members.find(mm=>Number(mm.number)===number);
        if(m){ m.name = name||m.name; m.shares = shares; m.munno = munno; if(joinDate) m.joinDate = joinDate; }
        else { db.members.push({id:'m'+Math.random().toString(36).slice(2,9), number, name, shares, munno, joinDate}); }
      });
      // Loans
      lRows.forEach(x=>{
        const no = Number(x.MemberNo); if(!no) return;
        let l = db.loans.find(ll=>Number(ll.memberNo)===no);
        const rec = {
          principalOut:Number(x.PrincipalOut)||0,
          rateMonthly:Number(x.RateMonthly)||0.02,
          startDate:String(x.StartDate||todayStr()),
          lastAccrual:String(x.LastAccrual||x.StartDate||todayStr()),
          accruedInterest:Number(x.AccruedInterest)||0,
          termMonths:Number(x.TermMonths)||'',
          endDate:String(x.EndDate||'')
        };
        if(l){
          // prefer the row with newer lastAccrual
          if(new Date(rec.lastAccrual)>new Date(l.lastAccrual||l.startDate)){ Object.assign(l, rec); }
        }else{
          db.loans.push({ id:'L'+Math.random().toString(36).slice(2,9), memberNo:no, ...rec });
        }
      });
      // Transactions: append newer only (greater than latest existing date)
      const maxDate = db.tx.reduce((m,t)=> t.ts && new Date(t.ts)>new Date(m)? t.ts : m, '1900-01-01');
      const newTx = tRows.filter(x=>x.Date && x.Type && new Date(String(x.Date))>new Date(maxDate)).map(x=>({
        ts:String(x.Date), type:String(x.Type), memberNo: x.MemberNo? Number(x.MemberNo): undefined, amount:Number(x.Amount)||0,
        meta: (()=>{ try{return x.Meta? JSON.parse(x.Meta): undefined;}catch{return undefined;} })()
      }));
      db.tx.push(...newTx);

      // KYC merge
      (kRows||[]).forEach(k=>{
        const no = Number(k.MemberNo); if(!no) return;
        const cur = db.kyc[no]||{fileIds:[]};
        db.kyc[no] = {
          name: k.Name||cur.name||'', tribe:k.Tribe||cur.tribe||'', age: Number(k.Age)||cur.age||'', dob: String(k.DOB||cur.dob||''), phone: String(k.Phone||cur.phone||''),
          nokName: k.NOK_Name||cur.nokName||'', nokRel: k.NOK_Rel||cur.nokRel||'', nokPhone: String(k.NOK_Phone||cur.nokPhone||''),
          appForm: String(k.AppForm|| (cur.appForm?'Yes':'No')).toLowerCase()==='yes',
          passport: String(k.Passport|| (cur.passport?'Yes':'No')).toLowerCase()==='yes',
          fileIds: cur.fileIds||[]
        };
      });

      save(); renderAll();
      alert(`XLSX merged: ${newTx.length} new transactions, ${mRows.length} members processed, ${lRows.length} loans processed.`);
    }catch(e){ alert('Import failed: '+e.message); }
  };
  r.readAsArrayBuffer(file);
}
function wireExcel(){
  const ex = document.getElementById('btnExportXLSX'); if(ex) ex.onclick = exportXLSX;
  const im = document.getElementById('xlsImport'); if(im) im.onchange = e=> e.target.files[0] && importXLSX(e.target.files[0]);
}

/* ========= Registrar + IndexedDB for files + KYC ========= */
let idb = null;
function openIDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open('kibiina_files', 1);
    r.onupgradeneeded = e=>{ const dbx = r.result; if(!dbx.objectStoreNames.contains('files')) dbx.createObjectStore('files', {keyPath:'id'}); };
    r.onsuccess = ()=>{ idb = r.result; res(); };
    r.onerror = ()=> rej(r.error);
  });
}
function idbPut(fileObj){
  return new Promise((res,rej)=>{ const tx = idb.transaction('files','readwrite').objectStore('files').put(fileObj); tx.onsuccess = ()=> res(); tx.onerror = ()=> rej(tx.error); });
}
function idbGet(id){
  return new Promise((res,rej)=>{ const tx = idb.transaction('files','readonly').objectStore('files').get(id); tx.onsuccess = ()=> res(tx.result); tx.onerror = ()=> rej(tx.error); });
}
function idbDelete(id){
  return new Promise((res,rej)=>{ const tx = idb.transaction('files','readwrite').objectStore('files').delete(id); tx.onsuccess = ()=> res(); tx.onerror = ()=> rej(tx.error); });
}
async function addRegistrar(){
  const date = document.getElementById('regDate').value || todayStr();
  const type = document.getElementById('regType').value;
  const memberNo = document.getElementById('regMember').value || '';
  const amount = Number(document.getElementById('regAmount').value||0);
  const notes = document.getElementById('regNotes').value.trim();
  const files = document.getElementById('regFiles').files;

  const id = 'R'+Math.random().toString(36).slice(2,9);
  const fileIds = [];
  if(files && files.length){
    for(const f of files){
      const fid = 'F'+Math.random().toString(36).slice(2,10);
      const buf = await f.arrayBuffer();
      await idbPut({id:fid, name:f.name, type:f.type, size:f.size, data:new Blob([buf], {type:f.type})});
      fileIds.push(fid);
    }
  }
  db.registrar.unshift({id, date, type, memberNo: memberNo? Number(memberNo): undefined, amount, notes, fileIds});
  // Register as transaction if relevant
  const ts = date;
  if(type==='fine' && amount>0 && memberNo){ db.tx.push({ts, type:'fine', memberNo:Number(memberNo), amount}); }
  if(type==='loan_form_fee' && amount>0 && memberNo){ db.tx.push({ts, type:'loan_form_fee', memberNo:Number(memberNo), amount}); }
  if(type==='munno_withdraw' && amount>0 && memberNo){
    const m = getMemberByNo(memberNo); if(m){ m.munno = Math.max(0, (m.munno||0)-amount); db.tx.push({ts, type:'munno_taken', memberNo:Number(memberNo), amount}); }
  }
  if(type==='munno_returned' && amount>0 && memberNo){
    const m = getMemberByNo(memberNo); if(m){ m.munno = (m.munno||0)+amount; db.tx.push({ts, type:'munno_returned', memberNo:Number(memberNo), amount}); }
  }
  save(); renderRegistrar(); renderDashboard(); document.getElementById('regNotes').value=''; document.getElementById('regFiles').value='';
}
function fileBadge(fid, name){
  return `<span class="file-pill"><span class="mono" style="font-size:12px">${name||fid}</span>
    <button class="btn" data-dl="${fid}" title="Download">⬇</button>
    <button class="btn bad" data-del="${fid}" title="Delete">✖</button></span>`;
}
function renderRegistrar(){
  const tbody = document.querySelector('#regTable tbody'); if(!tbody) return;
  tbody.innerHTML = '';
  db.registrar.forEach(async (r)=>{
    const tr = document.createElement('tr');
    const mem = r.memberNo? getMemberByNo(r.memberNo): null;
    let filesHTML = '';
    if(r.fileIds && r.fileIds.length){
      const parts = await Promise.all(r.fileIds.map(async id=>{ const fo = await idbGet(id); return fileBadge(id, fo?.name); }));
      filesHTML = parts.join(' ');
    }
    tr.innerHTML = `<td>${r.date}</td><td>${r.type}</td><td>${r.memberNo||''} ${mem? '– '+mem.name:''}</td><td>${UGX(r.amount||0)}</td><td>${r.notes||''}</td><td>${filesHTML}</td><td><button class="btn bad" data-rdel="${r.id}">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  // Wire file buttons
  tbody.onclick = async (e)=>{
    const dl = e.target.closest('[data-dl]'); const del = e.target.closest('[data-del]'); const rdel = e.target.closest('[data-rdel]');
    if(dl){
      const id = dl.dataset.dl; const fo = await idbGet(id); if(!fo){ alert('Missing file'); return; }
      download(fo.name||('file-'+id), fo.data);
    }
    if(del){
      const id = del.dataset.del;
      for(const rec of db.registrar){ rec.fileIds = (rec.fileIds||[]).filter(x=>x!==id); }
      // Also unlink from any KYC file lists
      Object.values(db.kyc||{}).forEach(k=> k.fileIds = (k.fileIds||[]).filter(x=>x!==id));
      await idbDelete(id); save(); renderRegistrar(); renderKYCSummary();
    }
    if(rdel){
      const id = rdel.dataset.rdel;
      const rec = db.registrar.find(x=>x.id===id);
      if(rec && rec.fileIds && rec.fileIds.length){ for(const fid of rec.fileIds){ await idbDelete(fid); } }
      db.registrar = db.registrar.filter(x=>x.id!==id); save(); renderRegistrar();
    }
  }
}

/* ---- KYC form/save/summary ---- */
function fillKYCFormFromDB(no){
  const k = db.kyc?.[Number(no)] || {};
  const m = getMemberByNo(no);
  document.getElementById('kycName').value = k.name || m?.name || '';
  document.getElementById('kycTribe').value = k.tribe || '';
  document.getElementById('kycAge').value = k.age || '';
  document.getElementById('kycDob').value = k.dob || '';
  document.getElementById('kycPhone').value = k.phone || '';
  document.getElementById('kycNokName').value = k.nokName || '';
  document.getElementById('kycNokRel').value = k.nokRel || '';
  document.getElementById('kycNokPhone').value = k.nokPhone || '';
  document.getElementById('kycAppForm').checked = !!k.appForm;
  document.getElementById('kycPassport').checked = !!k.passport;
}
function kycRowHTML(no, k){
  const files = (k.fileIds||[]).map(fid=> `<span data-kyc="${fid}"></span>`).join(' ');
  const ok = kycComplete(no);
  return `<div class="stat" style="margin-bottom:8px">
    <div class="stack" style="justify-content:space-between">
      <div>
        <b>${no} – ${(k.name || getMemberByNo(no)?.name || '(unnamed)')}</b>
        <div class="muted" style="font-size:12px">Tribe: ${k.tribe||'-'} • Age: ${k.age||'-'} • DOB: ${k.dob||'-'} • Phone: ${k.phone||'-'}</div>
        <div class="muted" style="font-size:12px">NOK: ${k.nokName||'-'} (${k.nokRel||'-'}) ${k.nokPhone||''}</div>
        <div class="muted" style="font-size:12px">Docs: App Form ${k.appForm?'✓':'✗'} • Passport ${k.passport?'✓':'✗'}</div>
      </div>
      <div>${ ok? '<span class="kyc-chip ok">KYC ✓</span>' : '<span class="kyc-chip bad">KYC</span>' }</div>
    </div>
    <div class="stack" style="margin-top:6px" id="kycFilesRow_${no}">${files||''}</div>
  </div>`;
}
async function renderKYCSummary(){
  const box = document.getElementById('kycSummary'); if(!box) return;
  box.innerHTML = '';
  const entries = Object.entries(db.kyc||{}).sort((a,b)=>Number(a[0])-Number(b[0]));
  if(entries.length===0){ box.innerHTML = '<div class="warnmsg">No KYC profiles saved yet.</div>'; return; }
  for(const [noStr, k] of entries){
    const no = Number(noStr);
    const div = document.createElement('div');
    div.innerHTML = kycRowHTML(no, k);
    box.appendChild(div);
    // Inflate file badges
    const row = div.querySelector(`#kycFilesRow_${no}`);
    if(k.fileIds && k.fileIds.length){
      const parts = await Promise.all(k.fileIds.map(async fid=>{ const fo = await idbGet(fid); return fileBadge(fid, fo?.name); }));
      row.innerHTML = parts.join(' ');
    }
  }
}

function wireKYC(){
  const sel = document.getElementById('kycMember');
  if(sel){
    sel.onchange = ()=> fillKYCFormFromDB(sel.value);
  }
  const saveBtn = document.getElementById('btnKycSave');
  if(saveBtn){
    saveBtn.onclick = async ()=>{
      const no = Number(document.getElementById('kycMember').value);
      if(!no){ alert('Choose a member for KYC'); return; }
      const files = document.getElementById('kycFiles').files;
      const cur = db.kyc[no]||{fileIds:[]};
      const fileIds = cur.fileIds||[];
      if(files && files.length){
        for(const f of files){
          const fid = 'F'+Math.random().toString(36).slice(2,10);
          const buf = await f.arrayBuffer();
          await idbPut({id:fid, name:f.name, type:f.type, size:f.size, data:new Blob([buf], {type:f.type})});
          fileIds.push(fid);
        }
      }
      db.kyc[no] = {
        name: document.getElementById('kycName').value.trim() || getMemberByNo(no)?.name || '',
        tribe: document.getElementById('kycTribe').value.trim(),
        age: Number(document.getElementById('kycAge').value||''),
        dob: document.getElementById('kycDob').value || '',
        phone: document.getElementById('kycPhone').value.trim(),
        nokName: document.getElementById('kycNokName').value.trim(),
        nokRel: document.getElementById('kycNokRel').value.trim(),
        nokPhone: document.getElementById('kycNokPhone').value.trim(),
        appForm: document.getElementById('kycAppForm').checked,
        passport: document.getElementById('kycPassport').checked,
        fileIds
      };
      save(); renderKYCSummary(); renderMembers(); alert('KYC saved.');
      document.getElementById('kycFiles').value = '';
    };
  }
}

/* ========= Google Drive (GIS + REST) ========= */
const CLIENT_ID = '1012401719257-nm0hj0h1na9d7tm8eat4tllgigjrbir0.apps.googleusercontent.com';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
let tokenClient = null;
let gReady = false;

function setDriveUI(signedIn){
  document.getElementById('btnGSignIn').disabled = signedIn;
  document.getElementById('btnGSignOut').disabled = !signedIn;
  document.getElementById('btnDriveSave').disabled = !signedIn;
  document.getElementById('btnDriveLoad').disabled = !signedIn;
}
function driveStatus(msg){ const el=document.getElementById('driveStatus'); if(el) el.textContent = msg; }

function initDrive(){
  return new Promise((resolve)=>{
    function onGapi(){ gapi.load('client', async ()=>{ gReady = true; resolve(); }); }
    if(window.gapi) onGapi(); else {
      const i=setInterval(()=>{ if(window.gapi){ clearInterval(i); onGapi(); }}, 50);
    }
  });
}
function wireDrive(){
  const si = document.getElementById('btnGSignIn');
  const so = document.getElementById('btnGSignOut');
  const sv = document.getElementById('btnDriveSave');
  const ld = document.getElementById('btnDriveLoad');

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID, scope: SCOPES,
    callback: (resp)=>{
      if(resp.error){ driveStatus('Sign-in failed: '+resp.error); return; }
      gapi.client.setToken({access_token: resp.access_token});
      setDriveUI(true); driveStatus('Signed in.');
    }
  });

  si.onclick = ()=> tokenClient.requestAccessToken({prompt: 'consent'});
  so.onclick = ()=>{
    const tok = gapi.client.getToken();
    if(tok && tok.access_token){
      google.accounts.oauth2.revoke(tok.access_token, ()=>{});
    }
    gapi.client.setToken('');
    setDriveUI(false); driveStatus('Signed out.');
  };
  sv.onclick = async ()=>{
    try{
      const tok = gapi.client.getToken(); if(!tok) { alert('Sign in first'); return; }
      const data = new Blob([JSON.stringify(db,null,2)], {type:'application/json'});
      const metadata = { name: `kibiina-backup-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json` };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], {type:'application/json'}));
      form.append('file', data);
      const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method:'POST',
        headers:{ 'Authorization':'Bearer '+tok.access_token },
        body: form
      });
      if(!r.ok) throw new Error(await r.text());
      driveStatus('Backup saved to Drive ✅');
      alert('Backup saved to Drive.');
    }catch(e){ console.error(e); alert('Drive save failed: '+e.message); driveStatus('Drive save failed.'); }
  };
  ld.onclick = async ()=>{
    try{
      const tok = gapi.client.getToken(); if(!tok) { alert('Sign in first'); return; }
      const q = encodeURIComponent("name contains 'kibiina-backup-'");
      const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&orderBy=modifiedTime desc&fields=files(id,name,modifiedTime)&pageSize=1`, {
        headers:{ 'Authorization':'Bearer '+tok.access_token }
      });
      const j = await r.json();
      if(!j.files || !j.files.length){ alert('No backups found in Drive.'); return; }
      const file = j.files[0];
      const d = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, { headers:{ 'Authorization':'Bearer '+tok.access_token } });
      const txt = await d.text();
      const obj = JSON.parse(txt);
      if(!confirm(`Load backup "${file.name}" from Drive and REPLACE current data?`)) return;
      db = obj; if(!db.kyc) db.kyc = {}; if(!db.settings) db.settings = { lastMeetingDate: todayStr(), lastAccrualPosted:null, autoAccrualOnOpen:true };
      save();
      renderAll();
      driveStatus(`Loaded backup: ${file.name}`);
      alert('Backup loaded from Drive.');
    }catch(e){ console.error(e); alert('Drive load failed: '+e.message); driveStatus('Drive load failed: '+e.message); }
  };
}

/* ========= Self-Test / Demo ========= */
function wireSelfTest(){
  const btn = document.getElementById('btnAddDummyData');
  if(!btn) return;
  btn.onclick = ()=>{
    if(!confirm('Add demo data?')) return;
    db.members = [];
    for(let i=1;i<=8;i++){
      db.members.push({id:'m'+Math.random().toString(36).slice(2,9), number:i, name:`Member ${i}`, shares: i%3, munno: i*5000, joinDate:todayStr()});
      db.kyc[i] = { name:`Member ${i}`, tribe:'—', age:20+i, dob:'', phone:'', nokName:'', nokRel:'', nokPhone:'', appForm:false, passport:false, fileIds:[] };
    }
    db.loans = [];
    db.tx = [];
    db.welfareFund = 0;
    const date = todayStr();
    // Meeting deposits
    db.members.forEach((m,i)=>{
      db.tx.push({ts:date, type:'welfare', memberNo:m.number, amount:1500}); db.welfareFund+=1500;
      const dep = i*1000; if(dep){ m.munno+=dep; db.tx.push({ts:date, type:'munno_deposit', memberNo:m.number, amount:dep}); }
      const sh = i%2; if(sh){ m.shares+=sh; db.tx.push({ts:date, type:'share_buy', memberNo:m.number, amount:sh*3000, meta:{shares:sh}}); }
    });
    // One loan
    db.loans.push({ id:'L'+Math.random().toString(36).slice(2,9), memberNo:1, principalOut:200000, rateMonthly:0.025, startDate:date, lastAccrual:date, accruedInterest:0, termMonths:3, endDate:addMonths(date,3) });
    db.tx.push({ts:date, type:'loan_issue', memberNo:1, amount:200000});
    save(); renderAll(); alert('Demo data added.');
  };
}

/* ========= Render all ========= */
function renderAll(){
  renderDashboard();
  renderMembers();
  initMeeting();
  renderLoans();
  renderRepay();
  initReports();
  renderRegistrar();
  renderKYCSummary();
}

/* ========= Boot ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  await openIDB();

  // Auto-post missing month-end accruals (quiet, no duplicates)
  try { autoPostMissingAccrualsOnOpen(); } catch(e){ console.warn('Auto accrual failed', e); }

  wireTabs();
  wireMembers();
  wireMeeting();
  wireLoans();
  wireRepay();
  wireReports();
  wireBackup();
  wireExcel();
  wireSelfTest();
  wireRegistrar();
  wireKYC();

  // fill KYC form initial
  fillMemberOptions('kycMember', false);
  const ksel = document.getElementById('kycMember'); if(ksel && ksel.value) fillKYCFormFromDB(ksel.value);

  renderAll();

  // Drive
  try{ await initDrive(); wireDrive(); }catch(e){ console.warn('Drive init failed', e); }
});
</script>
</body>
</html>
