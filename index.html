<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KIBIINA – Savings & Loans (Complete v4)</title>
<meta name="description" content="Kibiina saving group app: members 1–30, registrar with docs, loans with terms & expected interest, automatic accrual, Excel/ledger import/export (with Shares column), Google Drive backup, detailed reports & print.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center}
  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  main{padding:16px;max-width:1200px;margin:0 auto}
  h2{margin:.2rem 0 1rem}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:.3rem 0 .8rem}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button,textarea{font:inherit}
  input[type="number"],input[type="date"],input[type="text"],input[type="tel"],select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d)}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed var(--line);padding:8px;text-align:left;font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){ .row{grid-template-columns:1fr} .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }
  .stat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat b{display:block;font-size:20px;margin-top:4px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:10px}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:8px;border-radius:10px}
  .mono{font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace; white-space: pre-wrap;}
  img{max-width:100%}
  .file-pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:.5rem 0}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">K</div> KIBIINA – Savings & Loans</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="members">Members</button>
        <button class="tab" data-tab="registrar">Registrar</button>
        <button class="tab" data-tab="meeting">Sunday Meeting</button>
        <button class="tab" data-tab="loans">Loans</button>
        <button class="tab" data-tab="repay">Repayments</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <div class="toolbar">
        <button class="btn" id="btnSaveNow">💾 Save now</button>
      </div>
      <h2>Group Overview</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Members</span><b id="statMembers">0</b></div>
        <div class="stat"><span class="muted">Total Share Capital</span><b id="statShareCap">UGX 0</b></div>
        <div class="stat"><span class="muted">Loans Outstanding</span><b id="statLoans">UGX 0</b></div>
        <div class="stat"><span class="muted">Interest Collected (YTD)</span><b id="statInterestYTD">UGX 0</b></div>
      </div>
      <div class="grid-4" style="margin-top:8px">
        <div class="stat"><span class="muted">Expected Interest to Collect (All active loans)</span><b id="statExpectedInterest">UGX 0</b></div>
        <div class="stat"><span class="muted">Accrued Interest O/S (All loans)</span><b id="statAccruedOS">UGX 0</b></div>
        <div class="stat"><span class="muted">Welfare Fund</span><b id="fundWelfare">UGX 0</b></div>
        <div class="stat"><span class="muted">Munno (aggregate)</span><b id="fundMunno">UGX 0</b></div>
      </div>
      <div class="hr"></div>
      <div class="grid-2">
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="stack">
            <button class="btn primary" id="btnCreate30">Create numbered members 1–30</button>
            <button class="btn" id="btnTodaySunday">Set meeting date to next Sunday</button>
            <button class="btn" id="btnBackup">Export data (JSON)</button>
            <label class="btn"><input type="file" id="restoreFile" accept="application/json" style="display:none">Import data</label>
          </div>
          <p class="help">All data saves to this browser (localStorage). Use export/import for backup or moving devices.</p>
        </div>
        <div class="card">
          <h3>Tips</h3>
          <ul class="help" style="margin:0 0 0 16px">
            <li>Loans now include <b>Term (months)</b> and show <b>Expected Interest</b> immediately.</li>
            <li>Month-end <b>interest_accrual</b> entries auto-post when the app opens.</li>
            <li>Reports & statements include <b>Print</b> buttons.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Add / Edit Member</h3>
          <div class="grid-3">
            <div>
              <label>Member No (1–30, unique)</label>
              <input id="mNo" type="number" min="1" max="30" step="1" placeholder="1">
            </div>
            <div>
              <label>Display Name</label>
              <input id="mName" type="text" placeholder="Member name">
            </div>
            <div>
              <label>Join Date</label>
              <input id="mJoin" type="date">
            </div>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Shares (0–10)</label>
              <input id="mShares" type="number" min="0" max="10" step="1" value="0">
            </div>
            <div>
              <label>Munno Balance (UGX)</label>
              <input id="mMunno" type="number" min="0" step="1" value="0">
            </div>
            <div style="align-self:end">
              <div class="stack">
                <button class="btn primary" id="btnSaveMember">Save Member</button>
                <button class="btn bad" id="btnDeleteMember" disabled>Delete</button>
              </div>
            </div>
          </div>
          <p class="help">Each member is identified by a <b>unique number (1–30)</b>. Names are for display only.</p>
        </div>
        <div class="card" style="grid-column: span 8;">
          <h3>Member List</h3>
          <table class="table" id="membersTable">
            <thead>
              <tr><th>No.</th><th>Name</th><th>Shares</th><th>Share Capital</th><th>Munno</th><th>Loan O/S</th><th>Available Limit</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REGISTRAR -->
    <section id="registrar" class="tabpanel" hidden>
      <div class="card">
        <h3>Member Registrar</h3>
        <div class="grid-3">
          <div>
            <label>Member No (1–30)</label>
            <select id="regMemberNo"></select>
          </div>
          <div>
            <label>Date of Registration</label>
            <input type="date" id="regDate">
          </div>
          <div>
            <label>Full Names</label>
            <input type="text" id="regFullName" placeholder="e.g., Amina N. Kato">
          </div>
        </div>

        <div class="grid-3" style="margin-top:8px">
          <div>
            <label>Phone Number</label>
            <input type="tel" id="regPhone" placeholder="+2567...">
          </div>
          <div>
            <label>National ID Number</label>
            <input type="text" id="regNIN" placeholder="CFxxxxxxxxxxx">
          </div>
          <div>
            <label>Nationality</label>
            <input type="text" id="regNationality" placeholder="Ugandan">
          </div>
        </div>

        <div class="grid-3" style="margin-top:8px">
          <div>
            <label>Area of Residence</label>
            <input type="text" id="regResidence" placeholder="Village / Parish / Subcounty">
          </div>
          <div>
            <label>Tribe</label>
            <input type="text" id="regTribe" placeholder="e.g., Baganda">
          </div>
          <div>
            <label>Date of Birth</label>
            <input type="date" id="regDOB">
          </div>
        </div>

        <div class="grid-3" style="margin-top:8px">
          <div>
            <label>Age</label>
            <input type="number" id="regAge" min="0" step="1" placeholder="e.g., 32">
          </div>
          <div>
            <label>Application form fully filled?</label>
            <select id="regFormFilled">
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>
          <div style="align-self:end">
            <button class="btn primary" id="btnSaveRegistrar">Save Registrar Details</button>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card" style="grid-column: span 6;">
          <h3>Passport Photos (multiple)</h3>
          <div class="stack">
            <label class="btn"><input type="file" id="regPassports" accept="image/*" multiple style="display:none">Upload Photos</label>
          </div>
          <div id="listPassports" style="margin-top:8px"></div>
          <p class="help">Stored locally in this browser (IndexedDB).</p>
        </div>

        <div class="card" style="grid-column: span 6;">
          <h3>Signed Group By-Laws (PDF/Image)</h3>
          <div class="stack">
            <label class="btn"><input type="file" id="regBylaws" accept="application/pdf,image/*" style="display:none">Upload File</label>
            <button class="btn bad" id="btnRemoveBylaws">Remove</button>
          </div>
          <div id="infoBylaws" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="card" style="grid-column: span 6;">
          <h3>Fully Filled Registration Form (PDF/Image)</h3>
          <div class="stack">
            <label class="btn"><input type="file" id="regForm" accept="application/pdf,image/*" style="display:none">Upload File</label>
            <button class="btn bad" id="btnRemoveForm">Remove</button>
          </div>
          <div id="infoForm" style="margin-top:8px"></div>
        </div>

        <div class="card" style="grid-column: span 6;">
          <h3>Other Scanned Documents (multiple)</h3>
          <div class="stack">
            <label class="btn"><input type="file" id="regOtherDocs" accept="application/pdf,image/*" multiple style="display:none">Upload Files</label>
          </div>
          <div id="listOtherDocs" style="margin-top:8px"></div>
        </div>
      </div>
      <p class="help" style="margin-top:8px">
        Tip: Export JSON frequently and/or enable Google Drive backup in the Data tab.
      </p>
    </section>

    <!-- MEETING -->
    <section id="meeting" class="tabpanel" hidden>
      <div class="card">
        <h3>Sunday Meeting Entry</h3>
        <div class="grid-3">
          <div>
            <label>Meeting (Sunday) Date</label>
            <input type="date" id="meetDate">
          </div>
          <div>
            <label>Welfare amount per member</label>
            <input type="number" id="welfarePer" value="1500" min="0" step="1">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnStartMeeting">Start / Reset Sheet</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="meetingSheet"></div>
        <div class="right" style="margin-top:10px">
          <button class="btn ok" id="btnPostMeeting" disabled>Post Meeting</button>
          <button class="btn" id="btnPrintMeeting" disabled>Print Sheet</button>
        </div>
        <p class="help">Munno (any amount), welfare (UGX 1,500 default), and buy shares (max 10 total shares per member).</p>
      </div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Issue Loan</h3>
          <label>Member (by No.)</label>
          <select id="loanMember"></select>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="loanAmt" min="1" step="1">
            </div>
            <div>
              <label>Term (months)</label>
              <input type="number" id="loanTerm" min="1" step="1" value="1">
            </div>
            <div>
              <label>Start Date</label>
              <input type="date" id="loanDate">
            </div>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Monthly Rate (auto)</label>
              <input type="text" id="loanRate" disabled value="auto (2.5%/2%)">
            </div>
            <div>
              <label>Expected Interest (total)</label>
              <input type="text" id="loanExpected" disabled value="UGX 0">
            </div>
            <div>
              <label>Expected Due Date</label>
              <input type="text" id="loanDue" disabled value="-">
            </div>
          </div>
          <div id="loanHint" class="help" style="margin-top:6px"></div>
          <div class="stack" style="margin-top:10px">
            <button class="btn primary" id="btnIssueLoan">Issue Loan</button>
            <button class="btn" id="btnSaveAfterLoan">💾 Save</button>
          </div>
        </div>
        <div class="card">
          <h3>Active Loans</h3>
          <table class="table" id="loansTable">
            <thead>
              <tr>
                <th>No.</th><th>Name</th>
                <th>Principal O/S</th><th>Accrued Interest</th><th>Rate</th>
                <th>Term</th><th>Expected Interest</th><th>Interest Remaining</th><th>Since</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="help">Limit: up to <b>2× share capital</b>. Rate: <b>2.5%/month</b> for UGX 1–3,999,000; otherwise <b>2%/month</b>. Expected interest is <b>principal × rate × months</b>.</p>
        </div>
      </div>
    </section>

    <!-- REPAYMENTS -->
    <section id="repay" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Record Repayment</h3>
          <label>Member (with loan)</label>
          <select id="rpMember"></select>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="rpAmt" min="1" step="1">
            </div>
            <div>
              <label>Date</label>
              <input type="date" id="rpDate">
            </div>
            <div>
              <label>Apply to</label>
              <select id="rpApply">
                <option value="auto">Interest first (recommended)</option>
                <option value="principal">Principal only</option>
                <option value="interest">Interest only</option>
              </select>
            </div>
          </div>
          <div class="stack" style="margin-top:10px">
            <button class="btn ok" id="btnPostRepay">Post Repayment</button>
            <button class="btn" id="btnSaveAfterRepay">💾 Save</button>
          </div>
          <p class="help">Shows new balances after posting. “Recent Transactions” uses the exact date you choose.</p>
        </div>
        <div class="card">
          <h3>Recent Transactions</h3>
          <table class="table" id="txTable">
            <thead><tr><th>Date</th><th>No.</th><th>Name</th><th>Type</th><th>Amount</th><th>Principal Bal</th><th>Interest O/S</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tabpanel" hidden>
      <div class="card">
        <div class="toolbar">
          <button class="btn" id="btnPrintQuarter" disabled>🖨️ Print</button>
        </div>
        <h3>Quarterly Summary (quick)</h3>
        <div class="grid-3">
          <div>
            <label>Quarter</label>
            <select id="rQuarter">
              <option value="Q1">Q1 (Jan–Mar)</option>
              <option value="Q2">Q2 (Apr–Jun)</option>
              <option value="Q3">Q3 (Jul–Sep)</option>
              <option value="Q4">Q4 (Oct–Dec)</option>
            </select>
          </div>
          <div>
            <label>Year</label>
            <input type="number" id="rYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnRunQuarter">Run Quarterly Report</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="quarterOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="toolbar">
          <button class="btn" id="btnPrintPeriod" disabled>🖨️ Print</button>
          <button class="btn" id="btnPeriodCSV" disabled>Export CSV</button>
        </div>
        <h3>Custom Period Report (any dates, optional member)</h3>
        <div class="grid-3">
          <div>
            <label>From (inclusive)</label>
            <input type="date" id="pFrom">
          </div>
          <div>
            <label>To (inclusive)</label>
            <input type="date" id="pTo">
          </div>
          <div>
            <label>Member filter</label>
            <select id="pMember"></select>
          </div>
        </div>
        <div class="right" style="align-items:end;margin-top:8px">
          <button class="btn primary" id="btnRunPeriod">Run Period Report</button>
        </div>
        <div class="hr"></div>
        <div id="periodOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="toolbar">
          <button class="btn" id="btnPrintStmt" disabled>🖨️ Print</button>
          <button class="btn" id="btnMemberCSV" disabled>Export CSV</button>
        </div>
        <h3>Member Statement (activity in period + current snapshot)</h3>
        <div class="grid-3">
          <div>
            <label>Member</label>
            <select id="msMember"></select>
          </div>
          <div>
            <label>From</label>
            <input type="date" id="msFrom">
          </div>
          <div>
            <label>To</label>
            <input type="date" id="msTo">
          </div>
        </div>
        <div class="right" style="align-items:end;margin-top:8px">
          <button class="btn primary" id="btnMemberStmt">Run Member Statement</button>
        </div>
        <div class="hr"></div>
        <div id="msOut"></div>
        <p class="help">“Current Snapshot” shows balances now; “Activity in Period” shows movements within the chosen dates.</p>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="toolbar">
          <button class="btn" id="btnPrintShare" disabled>🖨️ Print</button>
        </div>
        <h3>Year-End Profit Sharing</h3>
        <div class="grid-3">
          <div>
            <label>Year</label>
            <input type="number" id="yShareYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn ok" id="btnShareOut">Compute Distribution</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="shareOut"></div>
        <p class="help">Profits considered: <b>interest collected</b> from loans in that year. Shared to members <b>proportional to their share capital</b>.</p>
      </div>
    </section>

    <!-- DATA -->
    <section id="data" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Backup / Restore (Local JSON)</h3>
          <div class="stack">
            <button class="btn primary" id="btnBackup2">Export JSON</button>
            <label class="btn"><input type="file" id="restoreFile2" accept="application/json" style="display:none">Import JSON</label>
            <button class="btn" id="btnSaveLocal">💾 Save</button>
          </div>
          <p class="help">Exports all members, loans, transactions, registrar, and settings.</p>
        </div>

        <div class="card">
          <h3>Excel Import / Export</h3>
          <div class="stack">
            <button class="btn" id="btnExportXLSX">Export Excel (All Sheets)</button>
            <button class="btn" id="btnExportLedgerXLSX">Export Blank Ledger Template</button>
            <label class="btn"><input type="file" id="importXLSX" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none">Import Excel</label>
          </div>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Ledger From (for filled export)</label>
              <input type="date" id="ledgerFrom">
            </div>
            <div>
              <label>Ledger To</label>
              <input type="date" id="ledgerTo">
            </div>
            <div class="right" style="align-items:end">
              <button class="btn" id="btnExportFilledLedger">Export Ledger (Filled)</button>
            </div>
          </div>
          <p class="help">Ledger has 30 rows (No. 1–30) + TOTALS. <b>Includes Shares column</b> after “Munno Taken”.</p>
        </div>

        <div class="card">
          <h3>Cloud Sync (Google Drive)</h3>
          <div class="stack">
            <button class="btn" id="btnGSignIn">Sign in with Google</button>
            <button class="btn" id="btnCloudSave" disabled>Save to Google Drive</button>
            <button class="btn" id="btnCloudLoad" disabled>Load from Google Drive</button>
            <button class="btn bad" id="btnGSignOut" disabled>Sign out</button>
          </div>
          <div class="stack" style="margin-top:8px">
            <span id="cloudStatus" class="pill">Signed out</span>
          </div>
          <p class="help">
            Uses “drive.file” scope and a single file: <b>kibiina-backup.json</b>. If you imported Excel/JSON, we auto-save to Drive.
          </p>
        </div>

        <div class="card">
          <h3>Self-Test / Diagnostics</h3>
          <div class="stack">
            <button class="btn" id="btnSelfTest">Run Self-Test</button>
          </div>
          <div id="diagOut" class="mono" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <h3>Danger Zone</h3>
          <button class="btn bad" id="btnWipe">Reset ALL data</button>
          <p class="help">This cannot be undone (unless you exported a backup).</p>
        </div>
      </div>
    </section>
  </main>

<!-- External libs (loaded lazily where possible) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ========= Utilities ========= */
const UGX = (v)=> new Intl.NumberFormat('en-UG', {style:'currency', currency:'UGX', maximumFractionDigits:0}).format(v||0);
const todayStr = ()=> new Date().toLocaleDateString('en-CA', { timeZone: 'Africa/Kampala' });
const parseDate = s => new Date(s+'T00:00:00');
const daysBetween = (a,b)=> Math.max(0, Math.round((parseDate(b)-parseDate(a)) / (1000*60*60*24)));
const clone = x => JSON.parse(JSON.stringify(x));
function fmtPct(p){ return `${(p*100).toFixed(2)}%`; }
function addMonthsStr(dateStr, m){
  const d = parseDate(dateStr); d.setMonth(d.getMonth()+Number(m||0)); return d.toISOString().slice(0,10);
}
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
function printSection(containerId, title=''){
  const el = document.getElementById(containerId);
  if(!el) return alert('Nothing to print.');
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>${title||document.title}</title>
  <style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:16px}
  table{width:100%;border-collapse:collapse}th,td{border-bottom:1px solid #e5e7eb;padding:6px;text-align:left}
  h2,h3{margin:.2rem 0 .6rem}
  .muted{color:#64748b}
  </style></head><body>${el.outerHTML}</body></html>`);
  w.document.close(); w.focus(); w.print();
}

/* ========= Data Model (localStorage) ========= */
const KEY='kibiina_v4';
let db = {};
try { db = JSON.parse(localStorage.getItem(KEY) || '{}'); }
catch(e){ console.warn('Local data corrupted. Resetting storage.', e); localStorage.removeItem(KEY); db = {}; }
if(!db.members){ // initialize
  db = {
    members: [], // {id,number,name,joinDate,shares,munno, registrar?}
    loans: [],   // {id, memberNo, principalOut, rateMonthly, startDate, lastAccrual, accruedInterest, termMonths, expectedInterestTotal, expectedInterestPaid, contracts:[{principal,rate,months,expectedInterest,issuedTs}]}
    welfareFund: 0,
    tx: [],      // {ts, type, memberNo, amount, meta}
    settings: { lastMeetingDate: todayStr(), lastAccrualPost: null, updatedAt: new Date().toISOString() }
  };
  save();
}
function save(){
  if(!db.settings) db.settings = {};
  db.settings.updatedAt = new Date().toISOString();
  localStorage.setItem(KEY, JSON.stringify(db));
}

/* ========= Member helpers ========= */
function getMemberByNo(no){ return db.members.find(m => Number(m.number) === Number(no)); }
function ensureUniqueNo(no, ignoreId=null){ return !db.members.some(m=> Number(m.number)===Number(no) && m.id!==ignoreId); }
function nextFreeNo(){ for(let i=1;i<=30;i++){ if(!db.members.some(m=>Number(m.number)===i)) return i; } return null; }

/* ========= Tabs ========= */
function wireTabs(){
  const tabsEl = document.getElementById('tabs');
  if(!tabsEl) return;
  tabsEl.addEventListener('click', e=>{
    const b = e.target.closest('.tab'); if(!b) return;
    document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===b));
    document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id !== b.dataset.tab);
    if(b.dataset.tab==='dashboard') renderDashboard();
    if(b.dataset.tab==='members')   renderMembers();
    if(b.dataset.tab==='registrar') renderRegistrar();
    if(b.dataset.tab==='loans')    { accrueAll(); renderLoans(); }
    if(b.dataset.tab==='repay')    { accrueAll(); renderRepay(); }
    if(b.dataset.tab==='reports')  { accrueAll(); initReports(); }
    if(b.dataset.tab==='meeting')  initMeeting();
    if(b.dataset.tab==='data')     { /* nothing extra on open */ }
  });
}

/* ========= Accrual + Expected Interest ========= */
function loanRateFor(amount){ if(amount>=1 && amount<=3999999) return 0.025; if(amount>=4000000) return 0.02; return 0; }

/** Daily accrual to l.accruedInterest (prorated from monthly) up to given date */
function accrueAll(upToDate){
  const dTo = upToDate || todayStr();
  db.loans.forEach(l=>{
    if(l.principalOut<=0 || !l.rateMonthly) return;
    const start = l.lastAccrual || l.startDate || dTo;
    const days = daysBetween(start, dTo);
    if(days<=0) return;
    const dailyRate = l.rateMonthly/30;
    const add = l.principalOut * dailyRate * days;
    l.accruedInterest = Math.round((l.accruedInterest||0) + add);
    l.lastAccrual = dTo;
  });
  save();
}

/** On app open: post monthly interest accrual journals (interest_accrual) at month-ends since last run */
function ensureMonthEndAccruals(){
  const last = db.settings.lastAccrualPost ? parseDate(db.settings.lastAccrualPost) : null;
  const today = new Date();
  // compute all month-ends from (last||oldest loan) to previous month end
  let cursor = last ? new Date(last) : null;
  if(!cursor){
    let minStart = null;
    db.loans.forEach(l=>{ if(l.startDate){ const d=parseDate(l.startDate); if(!minStart||d<minStart) minStart=d; }});
    cursor = minStart || new Date(today.getFullYear(), today.getMonth(), 1);
  }
  function monthEnd(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
  let nextME = monthEnd(cursor);
  const prevMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
  while(nextME <= prevMonthEnd){
    const ts = nextME.toISOString().slice(0,10);
    // Accrue interest for each active loan snapshot (simple: principalOut × rate)
    db.loans.forEach(l=>{
      if(l.principalOut>0 && l.rateMonthly){
        const add = Math.round(l.principalOut * l.rateMonthly);
        l.accruedInterest = Math.round((l.accruedInterest||0) + add);
        db.tx.push({ts, type:'interest_accrual', memberNo: Number(l.memberNo), amount: add, meta:{monthEnd:ts, rate:l.rateMonthly}});
      }
    });
    db.settings.lastAccrualPost = ts;
    nextME = monthEnd(new Date(nextME.getFullYear(), nextME.getMonth()+1, 1));
  }
  save();
}

/** Expected interest helpers (principal × rate × months) */
function computeExpectedInterest(principal, rate, months){
  return Math.round((Number(principal)||0) * (Number(rate)||0) * (Number(months)||0));
}
function interestPaidForMemberSince(no, since){
  return db.tx.filter(t=> t.type==='repay_interest' && Number(t.memberNo)===Number(no) && (!since || t.ts>=since)).reduce((s,t)=>s+t.amount,0);
}
function expectedRemainingForLoan(l){
  const paid = l.expectedInterestPaid || 0;
  const total = l.expectedInterestTotal || 0;
  return Math.max(0, total - paid);
}

/* ========= Dashboard ========= */
function renderDashboard(){
  const n = db.members.length;
  const shareCap = db.members.reduce((s,m)=> s + (m.shares||0)*3000, 0);
  const loansOut = db.loans.reduce((s,l)=> s + (l.principalOut||0), 0);
  const year = new Date().getFullYear();
  const intYTD = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                      .reduce((s,t)=> s + t.amount, 0);
  const munnoAgg = db.members.reduce((s,m)=> s + (m.munno||0), 0);
  const accruedOS = db.loans.reduce((s,l)=> s + (l.accruedInterest||0), 0);
  const expectedAll = db.loans.reduce((s,l)=> s + expectedRemainingForLoan(l), 0);

  document.getElementById('statMembers').textContent = String(n);
  document.getElementById('statShareCap').textContent = UGX(shareCap);
  document.getElementById('statLoans').textContent = UGX(loansOut);
  document.getElementById('statInterestYTD').textContent = UGX(intYTD);
  document.getElementById('fundWelfare').textContent = UGX(db.welfareFund||0);
  document.getElementById('fundMunno').textContent = UGX(munnoAgg);
  document.getElementById('statAccruedOS').textContent = UGX(accruedOS);
  document.getElementById('statExpectedInterest').textContent = UGX(expectedAll);
}

/* ========= Members ========= */
let editingId = null;
function renderMembers(){
  const tbody = document.querySelector('#membersTable tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const rows = [...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  rows.forEach((m)=>{
    const shareCap = (m.shares||0)*3000;
    const loan = db.loans.find(l=>Number(l.memberNo)===Number(m.number));
    const principalOut = loan? (loan.principalOut||0) : 0;
    const limit = Math.max(0, (shareCap*2) - principalOut);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.number||''}</td>
      <td>${m.name||''}</td>
      <td>${m.shares||0}</td>
      <td>${UGX(shareCap)}</td>
      <td>${UGX(m.munno||0)}</td>
      <td>${UGX(principalOut)}</td>
      <td>${UGX(limit)}</td>
      <td><button class="btn" data-edit="${m.id}">Edit</button></td>`;
    tbody.appendChild(tr);
  });
}
function resetMemberForm(){
  editingId=null;
  document.getElementById('mNo').value= nextFreeNo() || '';
  document.getElementById('mName').value='';
  document.getElementById('mShares').value=0;
  document.getElementById('mMunno').value=0;
  document.getElementById('mJoin').value=todayStr();
  document.getElementById('btnDeleteMember').disabled = true;
}
function wireMembers(){
  const table = document.getElementById('membersTable');
  if(table){
    table.addEventListener('click', e=>{
      const id = e.target.dataset.edit; if(!id) return;
      const m = db.members.find(x=>x.id===id);
      editingId = id;
      document.getElementById('mNo').value    = m.number||'';
      document.getElementById('mName').value  = m.name||'';
      document.getElementById('mShares').value= m.shares||0;
      document.getElementById('mMunno').value = m.munno||0;
      document.getElementById('mJoin').value  = m.joinDate||todayStr();
      document.getElementById('btnDeleteMember').disabled = false;
    });
  }
  const saveBtn = document.getElementById('btnSaveMember');
  if(saveBtn){
    saveBtn.onclick = ()=>{
      let number = parseInt(document.getElementById('mNo').value||0);
      if(!number){
        const nf = nextFreeNo();
        if(!nf){ alert('All numbers 1–30 are taken. Delete a member first.'); return; }
        number = nf; document.getElementById('mNo').value = nf;
      }
      if(number<1 || number>30){ alert('Member number must be between 1 and 30.'); return; }
      const name = document.getElementById('mName').value.trim();
      const shares = Math.min(10, Math.max(0, parseInt(document.getElementById('mShares').value||0)));
      const munno = Math.max(0, parseInt(document.getElementById('mMunno').value||0));
      const join = document.getElementById('mJoin').value || todayStr();
      if(!ensureUniqueNo(number, editingId)){ alert('That number is already assigned to another member.'); return; }
      if(!name){ alert('Enter member name'); return; }
      if(editingId){
        const m = db.members.find(x=>x.id===editingId);
        if(Number(m.number)!==number){
          db.loans.forEach(l=>{ if(Number(l.memberNo)===Number(m.number)) l.memberNo = number; });
          db.tx.forEach(t=>{ if(Number(t.memberNo)===Number(m.number)) t.memberNo = number; });
        }
        m.number=number; m.name=name; m.shares=shares; m.munno=munno; m.joinDate=join;
      }else{
        const id='m'+Math.random().toString(36).slice(2,9);
        db.members.push({id, number, name, shares, munno, joinDate:join});
      }
      save(); renderMembers(); renderDashboard(); resetMemberForm();
    };
  }
  const delBtn = document.getElementById('btnDeleteMember');
  if(delBtn){
    delBtn.onclick = ()=>{
      if(!editingId) return;
      const mem = db.members.find(x=>x.id===editingId);
      if(!confirm(`Delete member No. ${mem?.number}? This also removes loans.`)) return;
      db.loans = db.loans.filter(l=> Number(l.memberNo)!==Number(mem.number));
      db.members = db.members.filter(m=>m.id!==editingId);
      save(); renderMembers(); renderDashboard(); resetMemberForm();
    };
  }
  const c30 = document.getElementById('btnCreate30');
  if(c30){
    c30.onclick = ()=>{
      if(db.members.length && !confirm('Replace current list with 30 numbered members (1–30)?')) return;
      db.members = [];
      for(let i=1;i<=30;i++){
        const id='m'+Math.random().toString(36).slice(2,9);
        db.members.push({id, number:i, name:`Member ${i}`, shares:0, munno:0, joinDate:todayStr()});
      }
      save(); renderMembers(); renderDashboard();
    };
  }
}

/* ========= Meeting (Sunday) ========= */
function nextSundayStr(){ const d=new Date(); const day=d.getDay(); const diff=(7-day)%7; d.setDate(d.getDate()+diff); return d.toISOString().slice(0,10); }
function initMeeting(){
  const md = document.getElementById('meetDate'); if(md) md.value = db.settings.lastMeetingDate || nextSundayStr();
  const wp = document.getElementById('welfarePer'); if(wp) wp.value = 1500;
  const box = document.getElementById('meetingSheet'); if(box) box.innerHTML='';
  const pm = document.getElementById('btnPostMeeting'); if(pm) pm.disabled = true;
  const pr = document.getElementById('btnPrintMeeting'); if(pr) pr.disabled = true;
}
function wireMeeting(){
  const setSun = document.getElementById('btnTodaySunday');
  if(setSun) setSun.onclick = ()=>{ document.getElementById('meetDate').value = nextSundayStr(); };
  const start = document.getElementById('btnStartMeeting');
  if(start) start.onclick = ()=>{
    const date = document.getElementById('meetDate').value || todayStr();
    db.settings.lastMeetingDate = date; save();
    const per = parseInt(document.getElementById('welfarePer').value||1500);
    const box = document.getElementById('meetingSheet');
    if(db.members.length===0){ box.innerHTML='<div class="warnmsg">No members yet. Add members first.</div>'; return; }
    const sorted = [...db.members].sort((a,b)=> Number(a.number)-Number(b.number));
    let html = `<table class="table"><thead><tr>
        <th>No.</th><th>Name</th><th>Munno Deposit</th><th>Welfare (UGX ${per})</th><th>Buy Shares</th></tr></thead><tbody>`;
    sorted.forEach((m)=>{
      html += `<tr>
        <td>${m.number}</td>
        <td>${m.name}</td>
        <td><input type="number" min="0" step="1" id="in_munno_${m.number}" placeholder="0"></td>
        <td style="text-align:center"><input type="checkbox" id="in_wel_${m.number}" checked></td>
        <td><input type="number" min="0" max="${Math.max(0,10-(m.shares||0))}" step="1" id="in_share_${m.number}" placeholder="0"></td>
      </tr>`;
    });
    html += '</tbody></table>';
    box.innerHTML = html;
    document.getElementById('btnPostMeeting').disabled = false;
    document.getElementById('btnPrintMeeting').disabled = false;
  };
  const post = document.getElementById('btnPostMeeting');
  if(post) post.onclick = ()=>{
    const date = document.getElementById('meetDate').value || todayStr();
    const per = parseInt(document.getElementById('welfarePer').value||1500);
    accrueAll(date);
    db.members.forEach(m=>{
      const munno = parseInt(document.getElementById(`in_munno_${m.number}`).value||0);
      const wel = document.getElementById(`in_wel_${m.number}`).checked;
      const sharesBuy = Math.min(10-(m.shares||0), Math.max(0, parseInt(document.getElementById(`in_share_${m.number}`).value||0)));
      if(munno>0){
        m.munno = (m.munno||0) + munno;
        db.tx.push({ts:date, type:'munno_deposit', memberNo:m.number, amount:munno});
      }
      if(wel){
        db.welfareFund = (db.welfareFund||0) + per;
        db.tx.push({ts:date, type:'welfare', memberNo:m.number, amount:per});
      }
      if(sharesBuy>0){
        m.shares = (m.shares||0) + sharesBuy;
        db.tx.push({ts:date, type:'share_buy', memberNo:m.number, amount: sharesBuy*3000, meta:{shares:sharesBuy}});
      }
    });
    save(); initMeeting(); renderDashboard(); alert('Meeting posted.');
  };
  const btnPrint = document.getElementById('btnPrintMeeting');
  if(btnPrint) btnPrint.onclick = ()=> printSection('meetingSheet', 'Sunday Meeting Sheet');
}

/* ========= Loans ========= */
function recalcExpectedLoanUI(){
  const amount = parseInt(document.getElementById('loanAmt').value||0);
  const months = parseInt(document.getElementById('loanTerm').value||1);
  const date = document.getElementById('loanDate').value || todayStr();
  const rate = loanRateFor(amount);
  const expected = computeExpectedInterest(amount, rate, months);
  document.getElementById('loanExpected').value = UGX(expected);
  document.getElementById('loanDue').value = addMonthsStr(date, months);
  const no = document.getElementById('loanMember').value;
  const m = getMemberByNo(no);
  const shareCap = (m?.shares||0)*3000;
  const currentLoan = db.loans.find(l=>Number(l.memberNo)===Number(no));
  const principalOut = currentLoan? currentLoan.principalOut : 0;
  const limit = Math.max(0, shareCap*2 - principalOut);
  document.getElementById('loanHint').innerHTML =
    `Share capital: <b>${UGX(shareCap)}</b> → Limit: <b>${UGX(limit)}</b> • Rate: <b>${fmtPct(rate)}/mo</b>`;
}
function renderLoans(){
  const sel = document.getElementById('loanMember'); if(!sel) return;
  const sorted=[...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = sorted.map(m=>`<option value="${m.number}">${m.number} – ${m.name}</option>`).join('');
  document.getElementById('loanAmt').value='';
  document.getElementById('loanTerm').value='1';
  document.getElementById('loanDate').value = todayStr();
  document.getElementById('loanExpected').value='UGX 0';
  document.getElementById('loanDue').value='-';
  document.getElementById('loanHint').textContent='';
  const tbody = document.querySelector('#loansTable tbody'); if(!tbody) return;
  tbody.innerHTML='';
  db.loans.forEach(l=>{
    const m = getMemberByNo(l.memberNo);
    const tr = document.createElement('tr');
    const interestRemain = expectedRemainingForLoan(l);
    tr.innerHTML = `<td>${l.memberNo}</td><td>${m? m.name:''}</td>
      <td>${UGX(l.principalOut||0)}</td><td>${UGX(l.accruedInterest||0)}</td>
      <td>${fmtPct(l.rateMonthly||0)}/mo</td>
      <td>${l.termMonths||'-'} mo</td>
      <td>${UGX(l.expectedInterestTotal||0)}</td>
      <td>${UGX(interestRemain)}</td>
      <td>${l.startDate||''}</td>`;
    tbody.appendChild(tr);
  });
}
function wireLoans(){
  ['loanAmt','loanTerm','loanDate','loanMember'].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.addEventListener('input', recalcExpectedLoanUI); el.addEventListener('change', recalcExpectedLoanUI); }
  });
  const issue = document.getElementById('btnIssueLoan');
  if(issue){
    issue.onclick = ()=>{
      const memberNo = document.getElementById('loanMember').value;
      const m = getMemberByNo(memberNo);
      if(!m){ alert('Select member'); return; }
      const amount = parseInt(document.getElementById('loanAmt').value||0);
      const months = parseInt(document.getElementById('loanTerm').value||1);
      const date = document.getElementById('loanDate').value || todayStr();
      if(amount<=0){ alert('Enter amount'); return; }
      if(months<=0){ alert('Enter term (months)'); return; }
      const current = db.loans.find(l=>Number(l.memberNo)===Number(memberNo));
      const principalOut = current? current.principalOut : 0;
      const limit = Math.max(0, ((m.shares||0)*3000)*2 - principalOut);
      if(amount>limit){ alert('Amount exceeds limit.'); return; }
      const rate = loanRateFor(amount);
      const expected = computeExpectedInterest(amount, rate, months);
      const due = addMonthsStr(date, months);

      accrueAll(date);
      if(current){
        // top-up = new contract
        current.principalOut += amount;
        current.contracts = current.contracts||[];
        current.contracts.push({principal:amount, rate, months, expectedInterest:expected, issuedTs:date, due});
        current.expectedInterestTotal = Math.round((current.expectedInterestTotal||0) + expected);
        db.tx.push({ts:date, type:'loan_topup', memberNo, amount});
        db.tx.push({ts:date, type:'interest_expected', memberNo, amount:expected, meta:{months, principal:amount, rate}});
      } else {
        db.loans.push({
          id:'L'+Math.random().toString(36).slice(2,9), memberNo, principalOut:amount, rateMonthly:rate,
          startDate:date, lastAccrual:date, accruedInterest:0, termMonths:months,
          expectedInterestTotal:expected, expectedInterestPaid:0, contracts:[{principal:amount, rate, months, expectedInterest:expected, issuedTs:date, due}]
        });
        db.tx.push({ts:date, type:'loan_issue', memberNo, amount});
        db.tx.push({ts:date, type:'interest_expected', memberNo, amount:expected, meta:{months, principal:amount, rate}});
      }
      save(); renderLoans(); renderDashboard();
      alert(`Loan recorded.\nExpected interest: ${UGX(expected)} • Due: ${due}`);
    };
  }
  const saveBtn = document.getElementById('btnSaveAfterLoan'); if(saveBtn) saveBtn.onclick = ()=>{ save(); alert('Saved.'); };
}

/* ========= Repayments ========= */
function renderRepay(){
  const sel = document.getElementById('rpMember'); if(!sel) return;
  const withLoans = db.members.filter(m=> db.loans.find(l=>Number(l.memberNo)===Number(m.number) && (l.principalOut>0 || (l.accruedInterest||0)>0)));
  const sorted=[...withLoans].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = sorted.map(m=>`<option value="${m.number}">${m.number} – ${m.name}</option>`).join('');
  document.getElementById('rpAmt').value='';
  document.getElementById('rpDate').value = todayStr();
  document.getElementById('rpApply').value = 'auto';
  // Recent TX with balances
  const tbody = document.querySelector('#txTable tbody'); if(!tbody) return;
  const last = clone(db.tx).sort((a,b)=> new Date(b.ts) - new Date(a.ts)).slice(0,20);
  tbody.innerHTML = last.map(t=>{
    const m = getMemberByNo(t.memberNo);
    const loan = db.loans.find(l=>Number(l.memberNo)===Number(t.memberNo));
    const p = loan? loan.principalOut||0 : 0;
    const ai= loan? loan.accruedInterest||0 : 0;
    return `<tr><td>${t.ts}</td><td>${t.memberNo||''}</td><td>${m?m.name:''}</td><td>${t.type}</td><td>${UGX(t.amount)}</td><td>${UGX(p)}</td><td>${UGX(ai)}</td></tr>`;
  }).join('');
}
function wireRepay(){
  const post = document.getElementById('btnPostRepay');
  if(post){
    post.onclick = ()=>{
      const memberNo = document.getElementById('rpMember').value;
      const amt = parseInt(document.getElementById('rpAmt').value||0);
      const date = document.getElementById('rpDate').value || todayStr();
      const how = document.getElementById('rpApply').value;
      if(amt<=0){ alert('Enter amount'); return; }
      const loan = db.loans.find(l=>Number(l.memberNo)===Number(memberNo));
      if(!loan){ alert('No active loan'); return; }
      accrueAll(date);
      let remain = amt, paidInt=0, paidP=0;
      if(how==='auto' || how==='interest'){
        const payInt = Math.min(loan.accruedInterest||0, remain);
        if(payInt>0){
          loan.accruedInterest -= payInt;
          loan.expectedInterestPaid = Math.round((loan.expectedInterestPaid||0) + payInt);
          db.tx.push({ts:date, type:'repay_interest', memberNo, amount:payInt});
          remain -= payInt; paidInt=payInt;
        }
      }
      if((how==='auto' || how==='principal') && remain>0){
        const payP = Math.min(loan.principalOut, remain);
        if(payP>0){
          loan.principalOut -= payP;
          db.tx.push({ts:date, type:'repay_principal', memberNo, amount:payP});
          remain -= payP; paidP=payP;
        }
      }
      save(); renderRepay(); renderLoans(); renderDashboard();
      alert(`Repayment posted.\nInterest paid: ${UGX(paidInt)} • Principal paid: ${UGX(paidP)}\nNew principal balance: ${UGX(loan.principalOut)} • Interest O/S: ${UGX(loan.accruedInterest||0)}`);
    };
  }
  const saveBtn = document.getElementById('btnSaveAfterRepay'); if(saveBtn) saveBtn.onclick = ()=>{ save(); alert('Saved.'); };
}
</script>
<script>
/* ========= Reports ========= */
function initReports(){
  const y = new Date().getFullYear();
  document.getElementById('rYear').value = y;
  document.getElementById('yShareYear').value = y;

  // Default ranges (YTD)
  const from = new Date(y,0,1).toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const to   = new Date().toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const pF = document.getElementById('pFrom'); if(pF) pF.value = from;
  const pT = document.getElementById('pTo');   if(pT) pT.value = to;
  fillMemberOptions('pMember', true);
  fillMemberOptions('msMember', false);
  const msF = document.getElementById('msFrom'); if(msF) msF.value = from;
  const msT = document.getElementById('msTo');   if(msT) msT.value = to;

  document.getElementById('quarterOut').innerHTML='';
  document.getElementById('periodOut').innerHTML='';
  document.getElementById('msOut').innerHTML='';
  ['btnPrintQuarter','btnPrintPeriod','btnPrintStmt','btnPrintShare','btnPeriodCSV','btnMemberCSV'].forEach(id=>{
    const b=document.getElementById(id); if(b) b.disabled=true;
  });
}
function fillMemberOptions(selectId, includeAll){
  const sel = document.getElementById(selectId); if(!sel) return;
  const rows = [...db.members].sort((a,b)=>Number(a.number)-Number(b.number));
  sel.innerHTML = (includeAll? `<option value="all">All Members</option>` : '') +
    rows.map(m=>`<option value="${m.number}">${m.number} – ${m.name||''}</option>`).join('');
  if(!includeAll && rows.length) sel.value = String(rows[0].number);
}
function quarterRange(q, year){
  const y=Number(year);
  if(q==='Q1') return [new Date(y,0,1), new Date(y,2,31)];
  if(q==='Q2') return [new Date(y,3,1), new Date(y,5,30)];
  if(q==='Q3') return [new Date(y,6,1), new Date(y,8,30)];
  return [new Date(y,9,1), new Date(y,11,31)];
}
function wireReports(){
  const runQ = document.getElementById('btnRunQuarter');
  if(runQ){
    runQ.onclick = ()=>{
      const q = document.getElementById('rQuarter').value;
      const y = parseInt(document.getElementById('rYear').value||new Date().getFullYear());
      const [a,b] = quarterRange(q,y);
      const inRange = t => { const d = new Date(t.ts); return d>=a && d<=b; };
      const welfare = db.tx.filter(t=>t.type==='welfare' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const munno = db.tx.filter(t=>t.type==='munno_deposit' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const shares = db.tx.filter(t=>t.type==='share_buy' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const interestRec = db.tx.filter(t=>t.type==='repay_interest' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const principalRec = db.tx.filter(t=>t.type==='repay_principal' && inRange(t)).reduce((s,t)=>s+t.amount,0);
      const loansOut = db.tx.filter(t=>(t.type==='loan_issue'||t.type==='loan_topup') && inRange(t)).reduce((s,t)=>s+t.amount,0);
      document.getElementById('quarterOut').innerHTML = `
        <div class="grid-3">
          <div class="stat"><span class="muted">Welfare contributions</span><b>${UGX(welfare)}</b></div>
          <div class="stat"><span class="muted">Munno deposits</span><b>${UGX(munno)}</b></div>
          <div class="stat"><span class="muted">Shares purchased</span><b>${UGX(shares)}</b></div>
        </div>
        <div class="grid-3" style="margin-top:8px">
          <div class="stat"><span class="muted">Loans issued/topups</span><b>${UGX(loansOut)}</b></div>
          <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(principalRec)}</b></div>
          <div class="stat"><span class="muted">Interest collected</span><b>${UGX(interestRec)}</b></div>
        </div>
      `;
      const pb=document.getElementById('btnPrintQuarter'); if(pb) pb.disabled=false; pb.onclick=()=>printSection('quarterOut','Quarterly Summary');
    };
  }
  const btnP = document.getElementById('btnRunPeriod'); if(btnP) btnP.onclick = renderPeriodReport;
  const btnMS = document.getElementById('btnMemberStmt'); if(btnMS) btnMS.onclick = renderMemberStatement;
  const share = document.getElementById('btnShareOut');
  if(share){
    share.onclick = ()=>{
      const year = parseInt(document.getElementById('yShareYear').value||new Date().getFullYear());
      const totalInterest = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                                 .reduce((s,t)=>s+t.amount,0);
      const members = clone(db.members).map(m=> ({...m, shareCap:(m.shares||0)*3000}));
      const pool = members.reduce((s,m)=> s+m.shareCap, 0);
      let html = `<div class="stat"><span class="muted">Total interest (year)</span><b>${UGX(totalInterest)}</b></div>`;
      if(pool<=0 || totalInterest<=0){
        html += `<p class="warnmsg" style="margin-top:8px">No share capital or no interest collected for ${year}.</p>`;
      }else{
        html += `<table class="table" style="margin-top:8px"><thead><tr><th>No.</th><th>Name</th><th>Shares</th><th>Share Capital</th><th>Share %</th><th>Payout</th></tr></thead><tbody>`;
        members.sort((a,b)=>Number(a.number)-Number(b.number)).forEach(m=>{
          const pct = (m.shareCap||0)/pool;
          const pay = Math.round(totalInterest * pct);
          html += `<tr><td>${m.number||''}</td><td>${m.name}</td><td>${m.shares||0}</td><td>${UGX(m.shareCap||0)}</td><td>${(pct*100).toFixed(2)}%</td><td>${UGX(pay)}</td></tr>`;
        });
        html += `</tbody></table>`;
      }
      document.getElementById('shareOut').innerHTML = html;
      const pb=document.getElementById('btnPrintShare'); if(pb) pb.disabled=false; pb.onclick=()=>printSection('shareOut','Year-End Profit Sharing');
    };
  }
}

/* ===== Period helpers ===== */
function normalizeRange(fromStr, toStr){
  const defFrom = new Date(new Date().getFullYear(),0,1).toLocaleDateString('en-CA',{timeZone:'Africa/Kampala'});
  const defTo   = todayStr();
  const from = fromStr || defFrom;
  const to   = toStr   || defTo;
  const a = new Date(from); const b = new Date(to);
  return (a>b) ? [to, from] : [from, to];
}
function inRange(ts, from, to){
  const d = new Date(ts);
  return d>=new Date(from) && d<=new Date(to);
}
function sumPeriod(from, to, memberNoOrAll='all'){
  const isAll = memberNoOrAll==='all';
  const sums = {
    welfare:0, munnoDep:0, munnoReturned:0, munnoTaken:0,
    sharesUGX:0, sharesCount:0,
    loanIssue:0, loanTopup:0, loanTaken:0,
    repayPrincipal:0, repayInterest:0, fines:0, loanForm:0, txCount:0
  };
  const perMember = {};
  const addMemberRow = (no)=> perMember[no]||(perMember[no]={ No:no, Name:(getMemberByNo(no)?.name)||'',
    Welfare:0, Munno:0, MunnoReturned:0, MunnoTaken:0, SharesUGX:0, SharesCount:0, LoanTaken:0, PrincipalRepaid:0, InterestPaid:0, Fines:0, LoanForm:0 });

  db.tx.forEach(t=>{
    if(!t.ts || !inRange(t.ts, from, to)) return;
    if(!isAll && Number(t.memberNo)!==Number(memberNoOrAll)) return;
    const no = Number(t.memberNo)||0;
    sums.txCount++;
    switch(t.type){
      case 'welfare': sums.welfare+=t.amount; if(no){addMemberRow(no); perMember[no].Welfare+=t.amount;} break;
      case 'munno_deposit': sums.munnoDep+=t.amount; if(no){addMemberRow(no); perMember[no].Munno+=t.amount;} break;
      case 'munno_returned': case 'munno_withdraw':
        sums.munnoReturned+=t.amount; if(no){addMemberRow(no); perMember[no].MunnoReturned+=t.amount;} break;
      case 'munno_taken':
        sums.munnoTaken+=t.amount; if(no){addMemberRow(no); perMember[no].MunnoTaken+=t.amount;} break;
      case 'share_buy':
        sums.sharesUGX+=t.amount; sums.sharesCount += (t.meta?.shares||0);
        if(no){addMemberRow(no); perMember[no].SharesUGX+=t.amount; perMember[no].SharesCount+=(t.meta?.shares||0);}
        break;
      case 'loan_issue':
        sums.loanIssue+=t.amount; sums.loanTaken+=t.amount;
        if(no){addMemberRow(no); perMember[no].LoanTaken+=t.amount;} break;
      case 'loan_topup':
        sums.loanTopup+=t.amount; sums.loanTaken+=t.amount;
        if(no){addMemberRow(no); perMember[no].LoanTaken+=t.amount;} break;
      case 'repay_principal':
        sums.repayPrincipal+=t.amount; if(no){addMemberRow(no); perMember[no].PrincipalRepaid+=t.amount;} break;
      case 'repay_interest':
        sums.repayInterest+=t.amount; if(no){addMemberRow(no); perMember[no].InterestPaid+=t.amount;} break;
      case 'fine':
        sums.fines+=t.amount; if(no){addMemberRow(no); perMember[no].Fines+=t.amount;} break;
      case 'loan_form_fee':
        sums.loanForm+=t.amount; if(no){addMemberRow(no); perMember[no].LoanForm+=t.amount;} break;
    }
  });
  return { sums, perMember: Object.values(perMember).sort((a,b)=>a.No-b.No) };
}
/* ===== Render: Custom Period ===== */
let lastPeriodCSVRows = null;
function renderPeriodReport(){
  const [from, to] = normalizeRange(
    document.getElementById('pFrom').value,
    document.getElementById('pTo').value
  );
  const who = document.getElementById('pMember').value || 'all';
  const { sums, perMember } = sumPeriod(from, to, who);

  let html = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Dates</span><b>${from} → ${to}</b></div>
      <div class="stat"><span class="muted">Transactions</span><b>${sums.txCount}</b></div>
      <div class="stat"><span class="muted">Interest collected</span><b>${UGX(sums.repayInterest)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Welfare</span><b>${UGX(sums.welfare)}</b></div>
      <div class="stat"><span class="muted">Munno deposits</span><b>${UGX(sums.munnoDep)}</b></div>
      <div class="stat"><span class="muted">Munno returned</span><b>${UGX(sums.munnoReturned)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Shares (UGX)</span><b>${UGX(sums.sharesUGX)}</b></div>
      <div class="stat"><span class="muted">Shares (count)</span><b>${sums.sharesCount}</b></div>
      <div class="stat"><span class="muted">Fines</span><b>${UGX(sums.fines)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Loans issued</span><b>${UGX(sums.loanIssue)}</b></div>
      <div class="stat"><span class="muted">Loan topups</span><b>${UGX(sums.loanTopup)}</b></div>
      <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(sums.repayPrincipal)}</b></div>
    </div>
  `;

  if(perMember.length){
    const headerExtra = (who==='all')
      ? `<h4 style="margin-top:12px">Per-member breakdown</h4>`
      : `<h4 style="margin-top:12px">Member ${who} – ${(getMemberByNo(who)?.name)||''}</h4>`;
    html += `
      ${headerExtra}
      <table class="table">
        <thead>
          <tr>
            <th>No.</th><th>Name</th>
            <th>Welfare</th><th>Munno +</th><th>Munno Returned</th><th>Munno Taken</th>
            <th>Shares (UGX)</th><th>Shares (#)</th>
            <th>Loans Taken</th><th>Principal Repaid</th><th>Interest Paid</th><th>Fines</th><th>Loan Form</th>
          </tr>
        </thead>
        <tbody>
          ${perMember.map(r=>`
            <tr>
              <td>${r.No}</td><td>${r.Name}</td>
              <td>${UGX(r.Welfare)}</td><td>${UGX(r.Munno)}</td><td>${UGX(r.MunnoReturned)}</td><td>${UGX(r.MunnoTaken)}</td>
              <td>${UGX(r.SharesUGX)}</td><td>${r.SharesCount}</td>
              <td>${UGX(r.LoanTaken)}</td><td>${UGX(r.PrincipalRepaid)}</td><td>${UGX(r.InterestPaid)}</td><td>${UGX(r.Fines)}</td><td>${UGX(r.LoanForm)}</td>
            </tr>`).join('')}
        </tbody>
      </table>
    `;
    lastPeriodCSVRows = [
      ['From',from,'To',to,'Member',who],
      [],
      ['No','Name','Welfare','Munno+','MunnoReturned','MunnoTaken','SharesUGX','SharesCount','LoanTaken','PrincipalRepaid','InterestPaid','Fines','LoanForm'],
      ...perMember.map(r=>[r.No,r.Name,r.Welfare,r.Munno,r.MunnoReturned,r.MunnoTaken,r.SharesUGX,r.SharesCount,r.LoanTaken,r.PrincipalRepaid,r.InterestPaid,r.Fines,r.LoanForm])
    ];
    const pb=document.getElementById('btnPrintPeriod'); if(pb) pb.disabled=false; pb.onclick=()=>printSection('periodOut','Custom Period Report');
    const csvB=document.getElementById('btnPeriodCSV'); if(csvB) csvB.disabled=false; csvB.onclick=exportPeriodCSV;
  }else{
    lastPeriodCSVRows = null;
    document.getElementById('btnPeriodCSV').disabled = true;
  }

  document.getElementById('periodOut').innerHTML = html;
}
function toCSV(rows){
  return rows.map(r=>r.map(v=>{
    const s = (v===undefined||v===null)? '' : String(v);
    if(s.includes(',')||s.includes('"')||s.includes('\n')) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }).join(',')).join('\n');
}
function exportPeriodCSV(){
  if(!lastPeriodCSVRows){ alert('Run a period report first.'); return; }
  const csv = toCSV(lastPeriodCSVRows);
  download('period-report.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
}

/* ===== Member Statement ===== */
let lastMemberCSVRows = null;
function currentSnapshotFor(no){
  accrueAll(todayStr());
  const m = getMemberByNo(no);
  const loan = db.loans.find(l=>Number(l.memberNo)===Number(no));
  return {
    shares: m?.shares||0,
    shareCap: (m?.shares||0)*3000,
    munno: m?.munno||0,
    principalOut: loan?.principalOut||0,
    accruedInterest: loan?.accruedInterest||0
  };
}
function txForMemberInRange(no, from, to){
  return db.tx.filter(t=> Number(t.memberNo)===Number(no) && t.ts && inRange(t.ts, from, to))
              .sort((a,b)=> new Date(a.ts)-new Date(b.ts));
}
function renderMemberStatement(){
  const sel = document.getElementById('msMember'); if(!sel||!sel.value){ alert('Choose a member'); return; }
  const no = Number(sel.value);
  const [from, to] = normalizeRange(document.getElementById('msFrom').value, document.getElementById('msTo').value);
  const person = getMemberByNo(no);
  const { sums } = sumPeriod(from, to, no);
  const snap = currentSnapshotFor(no);
  const tx = txForMemberInRange(no, from, to);

  let html = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Member</span><b>${no} – ${person?.name||''}</b></div>
      <div class="stat"><span class="muted">Period</span><b>${from} → ${to}</b></div>
      <div class="stat"><span class="muted">Transactions in period</span><b>${tx.length}</b></div>
    </div>
    <h4 style="margin-top:10px">Current Snapshot (now)</h4>
    <div class="grid-3">
      <div class="stat"><span class="muted">Shares</span><b>${snap.shares} (UGX ${UGX(snap.shareCap).replace('UGX ','')})</b></div>
      <div class="stat"><span class="muted">Munno balance</span><b>${UGX(snap.munno)}</b></div>
      <div class="stat"><span class="muted">Loan O/S • Interest O/S</span><b>${UGX(snap.principalOut)} • ${UGX(snap.accruedInterest)}</b></div>
    </div>
    <h4 style="margin-top:10px">Activity in Period</h4>
    <div class="grid-3">
      <div class="stat"><span class="muted">Welfare</span><b>${UGX(sums.welfare)}</b></div>
      <div class="stat"><span class="muted">Munno +</span><b>${UGX(sums.munnoDep)}</b></div>
      <div class="stat"><span class="muted">Munno returned</span><b>${UGX(sums.munnoReturned)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Shares (UGX)</span><b>${UGX(sums.sharesUGX)}</b></div>
      <div class="stat"><span class="muted">Shares (count)</span><b>${sums.sharesCount}</b></div>
      <div class="stat"><span class="muted">Fines</span><b>${UGX(sums.fines)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Loans taken</span><b>${UGX(sums.loanTaken)}</b></div>
      <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(sums.repayPrincipal)}</b></div>
      <div class="stat"><span class="muted">Interest paid</span><b>${UGX(sums.repayInterest)}</b></div>
    </div>
    <h4 style="margin-top:12px">Transactions (${tx.length})</h4>
    <table class="table">
      <thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Meta</th></tr></thead>
      <tbody>
        ${tx.map(t=>`<tr><td>${t.ts}</td><td>${t.type}</td><td>${UGX(t.amount)}</td><td>${t.meta?JSON.stringify(t.meta):''}</td></tr>`).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('msOut').innerHTML = html;
  lastMemberCSVRows = [
    ['Member', `${no} – ${person?.name||''}`],
    ['From', from, 'To', to],
    [],
    ['Date','Type','Amount','Meta'],
    ...tx.map(t=>[t.ts, t.type, t.amount, t.meta? JSON.stringify(t.meta): ''])
  ];
  const pb=document.getElementById('btnPrintStmt'); if(pb) pb.disabled=false; pb.onclick=()=>printSection('msOut','Member Statement');
  const csvB=document.getElementById('btnMemberCSV'); if(csvB) csvB.disabled=(tx.length===0); csvB.onclick=exportMemberCSV;
}
function exportMemberCSV(){
  if(!lastMemberCSVRows){ alert('Run a member statement first.'); return; }
  const csv = toCSV(lastMemberCSVRows);
  download('member-statement.csv', new Blob([csv], {type:'text/csv;charset=utf-8'}));
}

/* ========= Backup/Restore (JSON) ========= */
function wireBackup(){
  const b1 = document.getElementById('btnBackup');
  const b2 = document.getElementById('btnBackup2');
  if(b1) b1.onclick = ()=>{ accrueAll(); download('kibiina-backup.json', new Blob([JSON.stringify(db,null,2)], {type:'application/json'})); };
  if(b2) b2.onclick = ()=>{ accrueAll(); download('kibiina-backup.json', new Blob([JSON.stringify(db,null,2)], {type:'application/json'})); };
  const r1 = document.getElementById('restoreFile');
  const r2 = document.getElementById('restoreFile2');
  if(r1) r1.addEventListener('change', handleRestore);
  if(r2) r2.addEventListener('change', handleRestore);
  const wipe = document.getElementById('btnWipe');
  if(wipe) wipe.onclick = ()=>{ if(!confirm('This will delete ALL data. Continue?')) return; localStorage.removeItem(KEY); location.reload(); };
  const saveLocal = document.getElementById('btnSaveLocal'); if(saveLocal) saveLocal.onclick = ()=>{ save(); alert('Saved locally.'); };
  const saveNow = document.getElementById('btnSaveNow'); if(saveNow) saveNow.onclick = ()=>{ save(); alert('Saved locally.'); };
}
async function handleRestore(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = async ()=>{
    try{
      const obj = JSON.parse(r.result);
      if(!obj.members||!obj.loans||!obj.tx){ alert('Invalid file'); return;}
      db = obj; save();
      renderDashboard(); renderMembers(); initMeeting(); renderLoans(); renderRepay(); initReports(); renderRegistrar();
      await maybeDriveAutoSave(); // auto-save to Drive
      alert('JSON imported and saved to Google Drive.');
    }catch(err){ alert('Invalid JSON'); }
  };
  r.readAsText(f);
}

/* ========= Excel Import / Export (SheetJS) ========= */
// Template contract
const TEMPLATE_VERSION = 'kibiina-xlsx-v2'; // v2 adds Shares column to Ledger
const MEMBERS_HEADERS = ['No','Name','JoinDate','Shares','Munno'];
const LOANS_HEADERS   = ['No','PrincipalOut','RateMonthly','StartDate','LastAccrual','AccruedInterest','TermMonths','ExpectedInterest'];
const TX_HEADERS      = ['Date','No','Type','Amount','Meta'];
function ledgerHeaders(){
  // Shares column is after MunnoTaken (as requested)
  return ['No','Name','Welfare','Munno','MunnoReturned','MunnoTaken','SharesUGX','LoanTaken','LoanReturned','LoanForm','Period','Interest','LoanBalance','Fines'];
}
function membersToRows(){
  const map = new Map(db.members.map(m=>[Number(m.number), m]));
  const out=[];
  for(let i=1;i<=30;i++){
    const m = map.get(i);
    out.push({ No:i, Name:m?m.name:'', JoinDate:m?m.joinDate:'', Shares:m?m.shares||0:0, Munno:m?m.munno||0:0 });
  }
  return out;
}
function loansToRows(){
  return db.loans.map(l=>({ No:l.memberNo, PrincipalOut:l.principalOut, RateMonthly:l.rateMonthly, StartDate:l.startDate, LastAccrual:l.lastAccrual||'', AccruedInterest:l.accruedInterest||0, TermMonths:l.termMonths||'', ExpectedInterest:l.expectedInterestTotal||0 }));
}
function txToRows(){
  return db.tx.map(t=>({ Date:t.ts, No:t.memberNo||'', Type:t.type, Amount:t.amount, Meta:t.meta?JSON.stringify(t.meta):'' }));
}
function ledgerRowsBlank(){
  const rows=[];
  for(let i=1;i<=30;i++){
    rows.push({ No:i, Name:(getMemberByNo(i)?.name)||'', Welfare:0, Munno:0, MunnoReturned:0, MunnoTaken:0, SharesUGX:0, LoanTaken:0, LoanReturned:0, LoanForm:0, Period:'', Interest:0, LoanBalance:0, Fines:0 });
  }
  return rows;
}
function computeLedgerRowsFilled(fromStr, toStr){
  const today = new Date().toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const yearStart = new Date(new Date().getFullYear(),0,1).toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const from = fromStr || yearStart;
  const to = toStr || today;
  accrueAll(to);
  const sums = {};
  for(let i=1;i<=30;i++) sums[i] = { No:i, Name:(getMemberByNo(i)?.name)||'', Welfare:0, Munno:0, MunnoReturned:0, MunnoTaken:0, SharesUGX:0, LoanTaken:0, LoanReturned:0, LoanForm:0, Period:to, Interest:0, LoanBalance:0, Fines:0 };
  const inRange = (ts)=>{ const d = new Date(ts); return d>=new Date(from) && d<=new Date(to); };
  db.tx.forEach(t=>{
    if(!t.ts || !inRange(t.ts)) return;
    const no = Number(t.memberNo); if(!no) return;
    const amt = Number(t.amount)||0;
    switch(t.type){
      case 'welfare': sums[no].Welfare += amt; break;
      case 'munno_deposit': sums[no].Munno += amt; break;
      case 'munno_withdraw': sums[no].MunnoReturned += amt; break;
      case 'munno_returned': sums[no].MunnoReturned += amt; break;
      case 'munno_taken': sums[no].MunnoTaken += amt; break;
      case 'share_buy': sums[no].SharesUGX += amt; break; // NEW column
      case 'loan_issue':
      case 'loan_topup': sums[no].LoanTaken += amt; break;
      case 'repay_principal': sums[no].LoanReturned += amt; break;
      case 'loan_form_fee': sums[no].LoanForm += amt; break;
      case 'repay_interest': sums[no].Interest += amt; break;
      case 'fine': sums[no].Fines += amt; break;
    }
  });
  db.loans.forEach(l=>{ const no=Number(l.memberNo); if(!no) return; sums[no].LoanBalance = (sums[no].LoanBalance||0) + (l.principalOut||0); });
  return Object.values(sums);
}
function colLetter(n){ let s=''; while(n>0){ const m=(n-1)%26; s=String.fromCharCode(65+m)+s; n=Math.floor((n-1)/26); } return s; }
function addTotalsRow(ws, numericCols){
  const headerRow=1; const firstData=2; const lastData=31; const totalRow=32;
  ws['A'+totalRow] = {t:'s', v:'TOTALS'};
  numericCols.forEach(idx=>{ const col=colLetter(idx); ws[col+totalRow] = { t:'n', f:`SUM(${col}${firstData}:${col}${lastData})` }; });
  const lastCol = colLetter(Math.max(...numericCols, 14));
  ws['!ref'] = `A1:${lastCol}${totalRow}`;
}
// Validate headers & numbers
function readHeaders(ws){
  const r = XLSX.utils.decode_range(ws['!ref']);
  const headers=[];
  for(let c=r.s.c;c<=r.e.c;c++){
    const cellAddr = XLSX.utils.encode_cell({r:0,c});
    const cell = ws[cellAddr];
    headers.push(cell? String(cell.v).trim(): '');
  }
  return headers;
}
function eqArr(a,b){ if(a.length!==b.length) return false; for(let i=0;i<a.length;i++){ if(String(a[i])!==String(b[i])) return false; } return true; }
function validateNoSet(rows, sheetName){
  const set = new Set(rows.map(r=> Number(r.No)));
  const missing = [];
  for(let i=1;i<=30;i++){ if(!set.has(i)) missing.push(i); }
  return missing.length? `${sheetName}: missing member numbers ${missing.join(', ')}` : null;
}
function validateWorkbook(XLSX, wb){
  const errs=[];
  const mustSheets = ['Members','Ledger'];
  mustSheets.forEach(n=>{ if(!wb.Sheets[n]) errs.push(`Missing sheet: ${n}`); });
  if(errs.length) return errs;
  const hMembers = readHeaders(wb.Sheets['Members']);
  if(!eqArr(hMembers, MEMBERS_HEADERS)) errs.push(`Members headers must be ${MEMBERS_HEADERS.join(', ')}`);
  const hLedger = readHeaders(wb.Sheets['Ledger']);
  if(!eqArr(hLedger, ledgerHeaders())) errs.push(`Ledger headers must be ${ledgerHeaders().join(', ')}`);
  if(wb.Sheets['Loans']){
    const hLoans = readHeaders(wb.Sheets['Loans']);
    if(!eqArr(hLoans, LOANS_HEADERS)) errs.push(`Loans headers must be ${LOANS_HEADERS.join(', ')}`);
  }
  if(wb.Sheets['Transactions']){
    const hTx = readHeaders(wb.Sheets['Transactions']);
    if(!eqArr(hTx, TX_HEADERS)) errs.push(`Transactions headers must be ${TX_HEADERS.join(', ')}`);
  }
  const memRows = XLSX.utils.sheet_to_json(wb.Sheets['Members']);
  const ledRows = XLSX.utils.sheet_to_json(wb.Sheets['Ledger']);
  const m1 = validateNoSet(memRows,'Members'); if(m1) errs.push(m1);
  const m2 = validateNoSet(ledRows,'Ledger');  if(m2) errs.push(m2);
  return errs;
}
async function doExport(includeLedger=true){
  const wb = XLSX.utils.book_new();
  const wsMeta = XLSX.utils.aoa_to_sheet([
    ['Template', TEMPLATE_VERSION],
    ['Exported', new Date().toISOString()]
  ]);
  XLSX.utils.book_append_sheet(wb, wsMeta, 'Meta');
  const wsMembers = XLSX.utils.json_to_sheet(membersToRows(), {header:MEMBERS_HEADERS});
  XLSX.utils.book_append_sheet(wb, wsMembers, 'Members');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(loansToRows(), {header:LOANS_HEADERS}), 'Loans');
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(txToRows(), {header:TX_HEADERS}), 'Transactions');
  if(includeLedger){
    const from = (document.getElementById('ledgerFrom')?.value)||'';
    const to   = (document.getElementById('ledgerTo')?.value)||'';
    const wsLedger = XLSX.utils.json_to_sheet(computeLedgerRowsFilled(from, to), {header:ledgerHeaders()});
    // numeric col indices (1-based): Welfare=3 Munno=4 MunnoReturned=5 MunnoTaken=6 SharesUGX=7 LoanTaken=8 LoanReturned=9 LoanForm=10 Interest=12 LoanBalance=13 Fines=14
    addTotalsRow(wsLedger, [3,4,5,6,7,8,9,10,12,13,14]);
    XLSX.utils.book_append_sheet(wb, wsLedger, 'Ledger');
  }
  XLSX.writeFile(wb, `kibiina-${new Date().toISOString().slice(0,10)}.xlsx`);
}
function wireExcel(){
  const ex = document.getElementById('btnExportXLSX');
  if(ex) ex.onclick = async ()=>{ try{ await doExport(true); }catch(err){ alert(err.message||'Failed to export Excel'); } };
  const exL = document.getElementById('btnExportLedgerXLSX');
  if(exL) exL.onclick = async ()=>{
    try{
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(ledgerRowsBlank(), {header:ledgerHeaders()});
      addTotalsRow(ws, [3,4,5,6,7,8,9,10,12,13,14]);
      XLSX.utils.book_append_sheet(wb, ws, 'Ledger');
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(membersToRows(), {header:MEMBERS_HEADERS}), 'Members');
      XLSX.writeFile(wb, `kibiina-ledger-template-${new Date().toISOString().slice(0,10)}.xlsx`);
    }catch(err){ alert(err.message||'Failed to export ledger'); }
  };
  const exF = document.getElementById('btnExportFilledLedger');
  if(exF) exF.onclick = ()=> doExport(true);

  const imp = document.getElementById('importXLSX');
  if(imp) imp.addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const ab = await f.arrayBuffer();
      const wb = XLSX.read(ab, {type:'array'});
      const errs = validateWorkbook(XLSX, wb);
      if(errs.length){ alert('IMPORT BLOCKED: Template mismatch.\n\n'+errs.map(x=>'• '+x).join('\n')); e.target.value=''; return; }

      // Members (upsert)
      const memRows = XLSX.utils.sheet_to_json(wb.Sheets['Members']);
      memRows.forEach(r=>{
        const no=Number(r.No); if(!no||no<1||no>30) return;
        let m = getMemberByNo(no);
        if(!m){ m={ id:'m'+Math.random().toString(36).slice(2,9), number:no, name:'', shares:0, munno:0, joinDate:todayStr() }; db.members.push(m); }
        if(r.Name!==undefined) m.name=String(r.Name);
        if(r.JoinDate) m.joinDate=String(r.JoinDate).slice(0,10);
        if(r.Shares!==undefined) m.shares=Number(r.Shares)||0;
        if(r.Munno!==undefined) m.munno=Number(r.Munno)||0;
      });

      // Loans (merge/upsert)
      if(wb.Sheets['Loans']){
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['Loans']);
        rows.forEach(r=>{
          const no=Number(r.No); if(!no||no<1||no>30) return;
          let loan = db.loans.find(l=>Number(l.memberNo)===no);
          if(!loan){
            loan = {
              id:'L'+Math.random().toString(36).slice(2,9),
              memberNo:no,
              principalOut:Number(r.PrincipalOut)||0,
              rateMonthly:Number(r.RateMonthly)||loanRateFor(Number(r.PrincipalOut)||0),
              startDate:String(r.StartDate||todayStr()).slice(0,10),
              lastAccrual:String(r.LastAccrual||'')||undefined,
              accruedInterest:Number(r.AccruedInterest)||0,
              termMonths: Number(r.TermMonths)||'',
              expectedInterestTotal:Number(r.ExpectedInterest)||0,
              expectedInterestPaid:0,
              contracts:[]
            };
            db.loans.push(loan);
          }else{
            // add values (not overwrite zeros blindly)
            if(r.PrincipalOut!==undefined) loan.principalOut = Number(loan.principalOut||0) + (Number(r.PrincipalOut)||0);
            if(r.AccruedInterest!==undefined) loan.accruedInterest = Number(loan.accruedInterest||0) + (Number(r.AccruedInterest)||0);
            if(r.ExpectedInterest!==undefined) loan.expectedInterestTotal = Number(loan.expectedInterestTotal||0) + (Number(r.ExpectedInterest)||0);
            if(r.TermMonths!==undefined && !loan.termMonths) loan.termMonths = Number(r.TermMonths)||'';
            if(r.RateMonthly!==undefined && !loan.rateMonthly) loan.rateMonthly = Number(r.RateMonthly)||loan.rateMonthly;
            if(r.StartDate && !loan.startDate) loan.startDate = String(r.StartDate).slice(0,10);
          }
        });
      }

      // Transactions (append unique-ish by ts+No+Type+Amount)
      if(wb.Sheets['Transactions']){
        const rows = XLSX.utils.sheet_to_json(wb.Sheets['Transactions']);
        const existingKey = new Set(db.tx.map(t=>`${t.ts}|${t.memberNo||''}|${t.type}|${t.amount}`));
        rows.forEach(r=>{
          const rec = {
            ts:String(r.Date).slice(0,10),
            memberNo: r.No? Number(r.No): undefined,
            type:String(r.Type||''),
            amount: Number(r.Amount)||0,
            meta: r.Meta? (typeof r.Meta==='string'? (()=>{
              try{ return JSON.parse(r.Meta); }catch(_){ return r.Meta; }
            })() : r.Meta) : undefined
          };
          const key = `${rec.ts}|${rec.memberNo||''}|${rec.type}|${rec.amount}`;
          if(!existingKey.has(key)){
            db.tx.push(rec);
            existingKey.add(key);
          }
        });
      }

      // Ledger (apply as postings; merge — newer dates add up)
      const ledRows = XLSX.utils.sheet_to_json(wb.Sheets['Ledger']);
      ledRows.forEach(r=>{
        const no = Number(r.No); if(!no||no<1||no>30) return;
        const ts = r.Period? String(r.Period).slice(0,10) : todayStr();
        if(Number(r.Welfare)>0){ db.welfareFund=(db.welfareFund||0)+Number(r.Welfare); db.tx.push({ts, type:'welfare', memberNo:no, amount:Number(r.Welfare)}); }
        if(Number(r.Munno)>0){ const m=getMemberByNo(no); if(m){ m.munno=(m.munno||0)+Number(r.Munno); db.tx.push({ts, type:'munno_deposit', memberNo:no, amount:Number(r.Munno)}); }}
        if(Number(r.MunnoReturned)>0){ const m=getMemberByNo(no); const amt=Number(r.MunnoReturned)||0; if(m && amt>0){ m.munno=Math.max(0,(m.munno||0)-amt); db.tx.push({ts, type:'munno_returned', memberNo:no, amount:amt}); }}
        if(Number(r.MunnoTaken)>0){ const m=getMemberByNo(no); const amt=Number(r.MunnoTaken)||0; if(m && amt>0){ m.munno=Math.max(0,(m.munno||0)-amt); db.tx.push({ts, type:'munno_taken', memberNo:no, amount:amt}); }}
        if(Number(r.SharesUGX)>0){ const sh=Number(r.SharesUGX); const m=getMemberByNo(no); if(m){ const sharesBuy = Math.round(sh/3000); m.shares = (m.shares||0)+sharesBuy; db.tx.push({ts, type:'share_buy', memberNo:no, amount:sh, meta:{shares:sharesBuy}}); } }
        if(Number(r.LoanTaken)>0){
          const amt=Number(r.LoanTaken); let loan = db.loans.find(l=>Number(l.memberNo)===no); accrueAll(ts);
          if(loan){ loan.principalOut += amt; db.tx.push({ts, type:'loan_topup', memberNo:no, amount:amt}); }
          else { db.loans.push({ id:'L'+Math.random().toString(36).slice(2,9), memberNo:no, principalOut:amt, rateMonthly:loanRateFor(amt), startDate:ts, lastAccrual:ts, accruedInterest:0, termMonths:'', expectedInterestTotal:0, expectedInterestPaid:0, contracts:[] }); db.tx.push({ts, type:'loan_issue', memberNo:no, amount:amt}); }
        }
        if(Number(r.LoanReturned)>0){ const amt=Number(r.LoanReturned); const loan=db.loans.find(l=>Number(l.memberNo)===no); if(loan){ accrueAll(ts); const pay=Math.min(amt, loan.principalOut); loan.principalOut-=pay; db.tx.push({ts, type:'repay_principal', memberNo:no, amount:pay}); }}
        if(Number(r.Interest)>0){ const amt=Number(r.Interest); const loan=db.loans.find(l=>Number(l.memberNo)===no); if(loan){ accrueAll(ts); const pay=Math.min(amt, loan.accruedInterest||0); loan.accruedInterest=(loan.accruedInterest||0)-pay; loan.expectedInterestPaid = Math.round((loan.expectedInterestPaid||0) + pay); db.tx.push({ts, type:'repay_interest', memberNo:no, amount:pay}); }}
        if(Number(r.LoanForm)>0){ db.tx.push({ts, type:'loan_form_fee', memberNo:no, amount:Number(r.LoanForm)}); }
        if(Number(r.Fines)>0){ db.tx.push({ts, type:'fine', memberNo:no, amount:Number(r.Fines)}); }
      });

      save();
      renderDashboard(); renderMembers(); initMeeting(); renderLoans(); renderRepay(); initReports(); renderRegistrar();

      await maybeDriveAutoSave(); // auto-save to Drive
      alert('Excel imported and saved to Google Drive.');
      e.target.value='';
    }catch(err){
      console.error(err);
      alert('Failed to import Excel: '+(err.message||err));
    }
  });
}

/* ========= Self-Test ========= */
function diag(msg, ok=true){ const box=document.getElementById('diagOut'); if(!box) return; const line = (ok? '✅ ':'❌ ')+msg+'\n'; box.textContent += line; }
function clearDiag(){ const box=document.getElementById('diagOut'); if(box) box.textContent=''; }
function assert(cond, msg){ cond? diag(msg, true): diag(msg, false); return !!cond; }
async function runSelfTest(){
  clearDiag();
  diag('Starting self-test...');
  const snap = clone(db);
  try{
    db.members = []; for(let i=1;i<=30;i++){ db.members.push({ id:'m'+Math.random().toString(36).slice(2,9), number:i, name:`Member ${i}`, shares:5, munno:0, joinDate:todayStr() }); }
    db.loans = []; db.tx = []; db.welfareFund = 0; save();
    assert(db.members.length===30, '30 members created');
    const d = todayStr();
    db.tx.push({ts:d, type:'welfare', memberNo:1, amount:1500}); db.welfareFund+=1500;
    db.tx.push({ts:d, type:'munno_deposit', memberNo:1, amount:10000}); getMemberByNo(1).munno+=10000;
    db.loans.push({ id:'L'+Math.random().toString(36).slice(2,9), memberNo:1, principalOut:500000, rateMonthly:0.025, startDate:d, lastAccrual:d, accruedInterest:0, termMonths:3, expectedInterestTotal:37500, expectedInterestPaid:0, contracts:[{principal:500000,rate:0.025,months:3,expectedInterest:37500,issuedTs:d}] });
    accrueAll(d);
    db.tx.push({ts:d, type:'repay_interest', memberNo:1, amount:10000}); db.loans[0].accruedInterest = Math.max(0,(db.loans[0].accruedInterest||0)-10000); db.loans[0].expectedInterestPaid+=10000;
    db.tx.push({ts:d, type:'repay_principal', memberNo:1, amount:50000}); db.loans[0].principalOut -= 50000;
    db.tx.push({ts:d, type:'fine', memberNo:1, amount:2000});
    const rows = computeLedgerRowsFilled(d, d);
    assert(rows.length===30, 'Ledger has 30 rows');
    const r1 = rows.find(r=>r.No===1);
    assert(r1.Welfare===1500, 'Welfare matched');
    assert(r1.Munno===10000, 'Munno deposit matched');
    assert(r1.LoanBalance>=450000, 'Loan balance present');
    assert(r1.Interest>=0, 'Interest captured');
    diag('Self-test complete. If all checks are green, the app is functioning.');
  }catch(err){ diag('Self-test failed: '+(err.message||err), false); }
  finally { db = snap; save(); renderMembers(); renderLoans(); renderRepay(); renderDashboard(); }
}
function wireSelfTest(){
  const st = document.getElementById('btnSelfTest');
  if(st) st.addEventListener('click', runSelfTest);
}

/* ========= Registrar data & files (IndexedDB) ========= */
function ensureRegistrar(m){
  if(!m.registrar){
    m.registrar = {
      regDate: m.joinDate || todayStr(),
      fullName: m.name || '',
      phone: '', natId: '', nationality: 'Ugandan', residence: '',
      tribe:'', dob:'', age:'', formFilled:'yes',
      nextOfKin: { name:'', relation:'', phone:'', address:'' },
      passportPhotoIds: [], bylawsFileId: null, regFormFileId: null, otherDocIds: []
    };
  }
  return m.registrar;
}
db.members.forEach(ensureRegistrar);

const FILEDB_NAME='kibiina_files_v1';
const FILEDB_STORE='files';
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(FILEDB_NAME, 1);
    req.onupgradeneeded = (ev)=>{
      const dbi = ev.target.result;
      if(!dbi.objectStoreNames.contains(FILEDB_STORE)){
        dbi.createObjectStore(FILEDB_STORE, { keyPath:'id' });
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error || new Error('Failed to open file DB'));
  });
}
async function filePut(file){
  const dbi = await idbOpen();
  const tx = dbi.transaction(FILEDB_STORE,'readwrite');
  const store = tx.objectStore(FILEDB_STORE);
  const id = 'f_'+Math.random().toString(36).slice(2,10);
  const rec = { id, name:file.name, type:file.type||'application/octet-stream', size:file.size||0, ts:Date.now(), data:file };
  store.put(rec);
  return new Promise((res,rej)=>{
    tx.oncomplete = ()=> res(id);
    tx.onerror = ()=> rej(tx.error || new Error('File save failed'));
  });
}
async function fileGet(id){
  const dbi = await idbOpen();
  const tx = dbi.transaction(FILEDB_STORE,'readonly');
  const store = tx.objectStore(FILEDB_STORE);
  return new Promise((res,rej)=>{
    const r = store.get(id);
    r.onsuccess = ()=> res(r.result||null);
    r.onerror = ()=> rej(r.error||new Error('File get failed'));
  });
}
async function fileDelete(id){
  const dbi = await idbOpen();
  const tx = dbi.transaction(FILEDB_STORE,'readwrite');
  const store = tx.objectStore(FILEDB_STORE);
  store.delete(id);
  return new Promise((res,rej)=>{
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error||new Error('File delete failed'));
  });
}
async function fileDownload(id){
  const rec = await fileGet(id); if(!rec){ alert('File missing'); return; }
  const url = URL.createObjectURL(rec.data);
  const a = document.createElement('a');
  a.href = url; a.download = rec.name || 'download';
  a.click(); setTimeout(()=> URL.revokeObjectURL(url), 1000);
}

/* Registrar render & wire */
function renderRegistrar(){
  const sel = document.getElementById('regMemberNo');
  if(!sel) return;
  sel.innerHTML = [...db.members].sort((a,b)=>Number(a.number)-Number(b.number))
    .map(m=>`<option value="${m.number}">${m.number} – ${m.name||''}</option>`).join('');
  if(!sel.value && db.members.length) sel.value = String(db.members[0].number);
  fillRegistrarForm();
}
function selectedMemberRegistrar(){
  const sel = document.getElementById('regMemberNo'); if(!sel) return null;
  const m = getMemberByNo(sel.value); if(!m) return null;
  ensureRegistrar(m);
  return m;
}
function renderFileList(containerId, ids){
  const box = document.getElementById(containerId); if(!box) return;
  if(!ids || !ids.length){ box.innerHTML = '<div class="muted">No files uploaded.</div>'; return; }
  box.innerHTML = '';
  ids.forEach(async (fid)=>{
    const rec = await fileGet(fid); if(!rec) return;
    const row = document.createElement('div');
    row.className = 'stack';
    row.style.margin = '6px 0';
    let thumb = '';
    if(rec.type.startsWith('image/')){
      const url = URL.createObjectURL(rec.data);
      thumb = `<img src="${url}" alt="" style="width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">`;
      setTimeout(()=> URL.revokeObjectURL(url), 5000);
    }
    row.innerHTML = `
      ${thumb}
      <span class="pill">${rec.name}</span>
      <button class="btn" data-dl="${fid}">Download</button>
      <button class="btn bad" data-rm="${fid}">Remove</button>
    `;
    row.addEventListener('click', async (e)=>{
      const dl = e.target.dataset.dl;
      const rm = e.target.dataset.rm;
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = m.registrar;
      if(dl){ await fileDownload(dl); }
      if(rm){
        await fileDelete(rm);
        r.passportPhotoIds = (r.passportPhotoIds||[]).filter(x=>x!==rm);
        r.otherDocIds      = (r.otherDocIds||[]).filter(x=>x!==rm);
        save(); renderFileList(containerId, containerId==='listPassports'?r.passportPhotoIds:r.otherDocIds);
      }
    });
    box.appendChild(row);
  });
}
function renderSingleFileInfo(containerId, id){
  const box = document.getElementById(containerId); if(!box) return;
  if(!id){ box.innerHTML = '<div class="muted">No file uploaded.</div>'; return; }
  (async()=>{
    const rec = await fileGet(id);
    if(!rec){ box.innerHTML = '<div class="muted">File not found.</div>'; return; }
    box.innerHTML = `
      <div class="stack">
        <span class="pill">${rec.name}</span>
        <button class="btn" id="${containerId}_dl">Download</button>
      </div>
    `;
    const btn = document.getElementById(`${containerId}_dl`);
    if(btn) btn.onclick = ()=> fileDownload(id);
  })();
}
function fillRegistrarForm(){
  const m = selectedMemberRegistrar(); if(!m) return;
  const r = m.registrar;
  document.getElementById('regDate').value       = r.regDate || todayStr();
  document.getElementById('regFullName').value   = r.fullName || '';
  document.getElementById('regPhone').value      = r.phone || '';
  document.getElementById('regNIN').value        = r.natId || '';
  document.getElementById('regNationality').value= r.nationality || '';
  document.getElementById('regResidence').value  = r.residence || '';
  document.getElementById('regTribe').value      = r.tribe || '';
  document.getElementById('regDOB').value        = r.dob || '';
  document.getElementById('regAge').value        = r.age || '';
  document.getElementById('regFormFilled').value = r.formFilled || 'yes';
  renderFileList('listPassports', r.passportPhotoIds);
  renderSingleFileInfo('infoBylaws', r.bylawsFileId);
  renderSingleFileInfo('infoForm',   r.regFormFileId);
  renderFileList('listOtherDocs', r.otherDocIds);

  // Next of kin
  if(!r.nextOfKin) r.nextOfKin = {name:'',relation:'',phone:'',address:''};
  document.getElementById('regKinName').value    = r.nextOfKin.name || '';
  document.getElementById('regKinRelation').value= r.nextOfKin.relation || '';
  document.getElementById('regKinPhone').value   = r.nextOfKin.phone || '';
  document.getElementById('regKinAddress').value = r.nextOfKin.address || '';
}
function wireRegistrar(){
  const who = document.getElementById('regMemberNo');
  if(who){ who.addEventListener('change', fillRegistrarForm); }
  const saveBtn = document.getElementById('btnSaveRegistrar');
  if(saveBtn){
    saveBtn.onclick = ()=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      r.regDate     = document.getElementById('regDate').value || todayStr();
      r.fullName    = document.getElementById('regFullName').value.trim();
      r.phone       = document.getElementById('regPhone').value.trim();
      r.natId       = document.getElementById('regNIN').value.trim();
      r.nationality = document.getElementById('regNationality').value.trim();
      r.residence   = document.getElementById('regResidence').value.trim();
      r.tribe       = document.getElementById('regTribe').value.trim();
      r.dob         = document.getElementById('regDOB').value || '';
      r.age         = document.getElementById('regAge').value || '';
      r.formFilled  = document.getElementById('regFormFilled').value || 'yes';
      r.nextOfKin = {
        name:     document.getElementById('regKinName').value.trim(),
        relation: document.getElementById('regKinRelation').value.trim(),
        phone:    document.getElementById('regKinPhone').value.trim(),
        address:  document.getElementById('regKinAddress').value.trim()
      };
      if(!m.name && r.fullName) m.name = r.fullName; // sync display name if empty
      save(); renderMembers(); alert('Registrar details saved.');
    };
  }
  // Files
  const pass = document.getElementById('regPassports');
  if(pass){
    pass.addEventListener('change', async (e)=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      const files = Array.from(e.target.files||[]);
      for(const f of files){ const id = await filePut(f); r.passportPhotoIds.push(id); }
      save(); e.target.value=''; renderFileList('listPassports', r.passportPhotoIds);
    });
  }
  const byl = document.getElementById('regBylaws');
  if(byl){
    byl.addEventListener('change', async (e)=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      const file = (e.target.files||[])[0]; if(!file) return;
      if(r.bylawsFileId){ try{ await fileDelete(r.bylawsFileId); }catch{} }
      r.bylawsFileId = await filePut(file);
      save(); e.target.value=''; renderSingleFileInfo('infoBylaws', r.bylawsFileId);
    });
  }
  const rmByl = document.getElementById('btnRemoveBylaws');
  if(rmByl){
    rmByl.onclick = async ()=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      if(r.bylawsFileId){ try{ await fileDelete(r.bylawsFileId);}catch{} r.bylawsFileId = null; save(); renderSingleFileInfo('infoBylaws', null); }
    };
  }
  const regf = document.getElementById('regForm');
  if(regf){
    regf.addEventListener('change', async (e)=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      const file = (e.target.files||[])[0]; if(!file) return;
      if(r.regFormFileId){ try{ await fileDelete(r.regFormFileId); }catch{} }
      r.regFormFileId = await filePut(file);
      save(); e.target.value=''; renderSingleFileInfo('infoForm', r.regFormFileId);
    });
  }
  const rmForm = document.getElementById('btnRemoveForm');
  if(rmForm){
    rmForm.onclick = async ()=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      if(r.regFormFileId){ try{ await fileDelete(r.regFormFileId);}catch{} r.regFormFileId = null; save(); renderSingleFileInfo('infoForm', null); }
    };
  }
  const other = document.getElementById('regOtherDocs');
  if(other){
    other.addEventListener('change', async (e)=>{
      const m = selectedMemberRegistrar(); if(!m) return;
      const r = ensureRegistrar(m);
      const files = Array.from(e.target.files||[]);
      for(const f of files){ const id = await filePut(f); r.otherDocIds.push(id); }
      save(); e.target.value=''; renderFileList('listOtherDocs', r.otherDocIds);
    });
  }
}

/* ======== Google Drive Config & Sync ======== */
const GOOGLE_CLIENT_ID = "1012401719257-nm0hj0h1na9d7tm8eat4tllgigjrbir0.apps.googleusercontent.com";
const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.file";
const DRIVE_FILE_NAME = "kibiina-backup.json";
let driveAccessToken = null;
let driveTokenClient = null;

function setCloudStatus(text, good=false){
  const el = document.getElementById('cloudStatus');
  if(!el) return;
  el.textContent = text;
  el.className = 'pill ' + (good ? '' : '');
}
function setCloudButtons(enabled){
  ['btnCloudSave','btnCloudLoad','btnGSignOut'].forEach(id=>{
    const b = document.getElementById(id); if(b) b.disabled = !enabled;
  });
}
function loadGIS(){
  return new Promise((resolve,reject)=>{
    if(window.google && window.google.accounts){ return resolve(); }
    const s = document.createElement('script');
    s.src = "https://accounts.google.com/gsi/client";
    s.async = true; s.defer = true;
    s.onload = resolve; s.onerror = ()=>reject(new Error("Failed to load Google Identity Services"));
    document.head.appendChild(s);
  });
}
async function initDrive(){
  await loadGIS();
  driveTokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: DRIVE_SCOPE,
    callback: (resp)=>{
      if(resp && resp.access_token){
        driveAccessToken = resp.access_token;
        setCloudStatus("Signed in • Ready", true);
        setCloudButtons(true);
      }else{
        setCloudStatus("Sign-in failed");
      }
    }
  });
  // no auto popup; wait for click
}
function driveEnsureToken(interactive=true){
  return new Promise((res)=>{
    if(driveAccessToken){ return res(true); }
    if(!driveTokenClient){ setCloudStatus("Cloud not ready"); return res(false); }
    const opts = interactive ? {} : {prompt:""};
    driveTokenClient.callback = (resp)=>{
      if(resp && resp.access_token){
        driveAccessToken = resp.access_token;
        setCloudStatus("Signed in • Ready", true);
        setCloudButtons(true);
        return res(true);
      }
      res(false);
    };
    driveTokenClient.requestAccessToken(opts);
  });
}
function driveSignOut(){
  driveAccessToken = null;
  setCloudButtons(false);
  setCloudStatus("Signed out");
}
async function driveFindBackup(){
  const q = encodeURIComponent(`name='${DRIVE_FILE_NAME}' and mimeType='application/json' and trashed=false`);
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime)`;
  const r = await fetch(url, { headers: { Authorization: `Bearer ${driveAccessToken}` }});
  if(!r.ok) throw new Error(await r.text());
  const j = await r.json();
  return (j.files && j.files[0]) ? j.files[0] : null;
}
async function driveDownloadFile(fileId){
  const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
    headers: { Authorization: `Bearer ${driveAccessToken}` }
  });
  if(!r.ok) throw new Error(await r.text());
  return r.text();
}
function multipartBody(meta, contentStr, mime="application/json"){
  const boundary = "-------kibiina" + Math.random().toString(36).slice(2);
  const delimiter = `\r\n--${boundary}\r\n`;
  const close = `\r\n--${boundary}--`;
  const body =
    delimiter +
    "Content-Type: application/json; charset=UTF-8\r\n\r\n" +
    JSON.stringify(meta) +
    delimiter +
    `Content-Type: ${mime}\r\n\r\n` +
    contentStr +
    close;
  const headers = { "Content-Type": `multipart/related; boundary=${boundary}`, "Authorization": `Bearer ${driveAccessToken}` };
  return { body, headers };
}
async function driveCreateBackup(jsonStr){
  const meta = { name: DRIVE_FILE_NAME, mimeType: "application/json" };
  const { body, headers } = multipartBody(meta, jsonStr);
  const url = "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart";
  const r = await fetch(url, { method:"POST", headers, body });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function driveUpdateBackup(fileId, jsonStr){
  const meta = { mimeType: "application/json" };
  const { body, headers } = multipartBody(meta, jsonStr);
  const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`;
  const r = await fetch(url, { method:"PATCH", headers, body });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function driveSave(showToast=true){
  const ok = await driveEnsureToken(true); if(!ok){ alert("Please sign in to Google first."); return; }
  const btn = document.getElementById('btnCloudSave');
  try{
    const json = JSON.stringify(db, null, 2);
    const existing = await driveFindBackup();
    if(existing){ await driveUpdateBackup(existing.id, json); }
    else { await driveCreateBackup(json); }
    if(btn){ btn.textContent = "Data saved ✓"; setTimeout(()=> btn.textContent="Save to Google Drive", 2500); }
    const t = new Date().toLocaleString('en-UG', { timeZone:'Africa/Kampala' });
    setCloudStatus(`Last saved: ${t}`, true);
  }catch(err){
    console.error(err);
    alert("Failed to save to Google Drive:\n"+(err.message||err));
    if(btn) btn.textContent = "Save to Google Drive";
  }
}
async function driveLoad(silent=false){
  const ok = await driveEnsureToken(!silent); if(!ok){ if(!silent) alert("Please sign in to Google first."); return; }
  try{
    const existing = await driveFindBackup();
    if(!existing){ if(!silent) alert("No cloud backup found yet."); return; }
    const txt = await driveDownloadFile(existing.id);
    const remote = JSON.parse(txt);
    if(!remote.members || !remote.loans || !remote.tx){ throw new Error("Backup is invalid."); }
    db = remote; save();
    renderDashboard(); renderMembers(); initMeeting(); renderLoans(); renderRepay(); initReports(); renderRegistrar();
    if(!silent) alert("Loaded latest backup from Google Drive.");
    const t = new Date(existing.modifiedTime).toLocaleString('en-UG', { timeZone:'Africa/Kampala' });
    setCloudStatus(`Loaded: ${t}`, true);
  }catch(err){
    console.error(err);
    if(!silent) alert("Failed to load from Google Drive:\n"+(err.message||err));
  }
}
function wireDrive(){
  const signIn = document.getElementById('btnGSignIn');
  const signOut= document.getElementById('btnGSignOut');
  const saveB  = document.getElementById('btnCloudSave');
  const loadB  = document.getElementById('btnCloudLoad');

  if(signIn) signIn.onclick = async ()=>{
    const ok = await driveEnsureToken(true);
    if(ok){
      setCloudStatus("Signed in • Ready", true);
      setCloudButtons(true);
    }
  };
  if(signOut) signOut.onclick = ()=> driveSignOut();
  if(saveB) saveB.onclick = ()=> driveSave(true);
  if(loadB) loadB.onclick = ()=> driveLoad(false);
}
async function maybeDriveAutoSave(){
  if(!driveTokenClient) return;
  const ok = await driveEnsureToken(false);
  if(ok) await driveSave(false);
}

/* ========= Boot ========= */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Default ledger date range (YTD)
  const y = new Date().getFullYear();
  const from = new Date(y,0,1).toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const to = new Date().toLocaleDateString('en-CA', { timeZone:'Africa/Kampala' });
  const lf = document.getElementById('ledgerFrom'); if(lf) lf.value = from;
  const lt = document.getElementById('ledgerTo');   if(lt) lt.value = to;

  ensureMonthEndAccruals(); // auto-post interest_accrual for missed month-ends

  wireTabs();
  wireMembers();
  wireMeeting();
  wireLoans();
  wireRepay();
  wireReports();
  wireBackup();
  wireExcel();
  wireSelfTest();
  wireRegistrar();

  renderDashboard();
  renderMembers();
  initMeeting();
  renderLoans();
  renderRepay();
  initReports();
  renderRegistrar();

  await initDrive();
  wireDrive();
});
</script>
</body>
</html>
