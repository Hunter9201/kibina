<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>KIBIINA – Savings & Loans Management</title>
<meta name="description" content="Kibiina saving group: members save weekly, buy shares, borrow against shares, track welfare, and generate quarterly reports with profit sharing.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#0ea5e9; --brand-d:#0369a1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --ink:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f8fafc;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--line)}
  .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
  .brand{display:flex;gap:10px;align-items:center;font-weight:800}
  .brand-badge{width:36px;height:36px;border-radius:10px;background:var(--brand);color:#fff;display:grid;place-items:center}
  .tabs{display:flex;flex-wrap:wrap;gap:8px}
  .tab{border:1px solid var(--line);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  main{padding:16px;max-width:1200px;margin:0 auto}
  h2{margin:.2rem 0 1rem}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px}
  .card h3{margin:.3rem 0 .8rem}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
  input,select,button,textarea{font:inherit}
  input[type="number"],input[type="date"],input[type="text"],select,textarea{
    width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#fff
  }
  .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-d);border-color:var(--brand-d)}
  .btn.ok{background:var(--ok);border-color:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
  .btn.bad{background:var(--bad);border-color:var(--bad);color:#fff}
  .stack{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:#f1f5f9;font-size:12px}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px dashed var(--line);padding:8px;text-align:left;font-size:14px}
  .help{font-size:12px;color:var(--muted)}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width: 900px){
    .row{grid-template-columns:1fr}
    .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
  }
  .stat{padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .stat b{display:block;font-size:20px;margin-top:4px}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .warnmsg{background:#fff7ed;border:1px solid #fdba74;color:#9a3412;padding:8px;border-radius:10px}
  .goodmsg{background:#ecfdf5;border:1px solid #86efac;color:#065f46;padding:8px;border-radius:10px}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand"><div class="brand-badge">K</div> KIBIINA – Savings & Loans</div>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="dashboard">Dashboard</button>
        <button class="tab" data-tab="members">Members</button>
        <button class="tab" data-tab="meeting">Sunday Meeting</button>
        <button class="tab" data-tab="loans">Loans</button>
        <button class="tab" data-tab="repay">Repayments</button>
        <button class="tab" data-tab="reports">Reports</button>
        <button class="tab" data-tab="data">Data</button>
      </div>
    </div>
  </header>

  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpanel">
      <h2>Group Overview</h2>
      <div class="grid-4">
        <div class="stat"><span class="muted">Members</span><b id="statMembers">0</b></div>
        <div class="stat"><span class="muted">Total Share Capital</span><b id="statShareCap">UGX 0</b></div>
        <div class="stat"><span class="muted">Loans Outstanding</span><b id="statLoans">UGX 0</b></div>
        <div class="stat"><span class="muted">Interest Collected (YTD)</span><b id="statInterestYTD">UGX 0</b></div>
      </div>
      <div class="hr"></div>
      <div class="grid-2">
        <div class="card">
          <h3>Funds</h3>
          <table class="table">
            <tr><th>Fund</th><th>Balance</th></tr>
            <tr><td>Welfare</td><td id="fundWelfare">UGX 0</td></tr>
            <tr><td>Munno (aggregate of members)</td><td id="fundMunno">UGX 0</td></tr>
          </table>
          <p class="help">Munno is saved by each member and is returned in full with no charges or profit.</p>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="stack">
            <button class="btn primary" id="btnCreate30">Create 30 default members</button>
            <button class="btn" id="btnTodaySunday">Set meeting date to next Sunday</button>
            <button class="btn" id="btnBackup">Export data (JSON)</button>
            <label class="btn"><input type="file" id="restoreFile" accept="application/json" style="display:none">Import data</label>
          </div>
          <p class="help">All data saves to this browser using localStorage. Use export/import to move or back up.</p>
        </div>
      </div>
    </section>

    <!-- MEMBERS -->
    <section id="members" class="tabpanel" hidden>
      <div class="row">
        <div class="card" style="grid-column: span 4;">
          <h3>Add / Edit Member</h3>
          <label>Name</label>
          <input id="mName" type="text" placeholder="Member name">
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Shares (0–10)</label>
              <input id="mShares" type="number" min="0" max="10" step="1" value="0">
            </div>
            <div>
              <label>Munno Balance (UGX)</label>
              <input id="mMunno" type="number" min="0" step="1" value="0">
            </div>
            <div>
              <label>Join Date</label>
              <input id="mJoin" type="date">
            </div>
          </div>
          <div class="stack" style="margin-top:10px">
            <button class="btn primary" id="btnSaveMember">Save Member</button>
            <button class="btn bad" id="btnDeleteMember" disabled>Delete</button>
          </div>
          <p class="help">Each share costs UGX 3,000. Max 10 shares per member (affects borrowing limit).</p>
        </div>
        <div class="card" style="grid-column: span 8;">
          <h3>Member List</h3>
          <table class="table" id="membersTable">
            <thead>
              <tr><th>#</th><th>Name</th><th>Shares</th><th>Share Capital</th><th>Munno</th><th>Loan O/S</th><th>Available Limit</th><th></th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MEETING -->
    <section id="meeting" class="tabpanel" hidden>
      <div class="card">
        <h3>Sunday Meeting Entry</h3>
        <div class="grid-3">
          <div>
            <label>Meeting (Sunday) Date</label>
            <input type="date" id="meetDate">
          </div>
          <div>
            <label>Welfare amount per member</label>
            <input type="number" id="welfarePer" value="1500" min="0" step="1">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnStartMeeting">Start / Reset Sheet</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="meetingSheet"></div>
        <div class="right" style="margin-top:10px">
          <button class="btn ok" id="btnPostMeeting" disabled>Post Meeting</button>
        </div>
        <p class="help">Enter Munno deposits (any amount), tick welfare (UGX 1,500 default), and add shares (max 10 total). Posting updates balances and records transactions.</p>
      </div>
    </section>

    <!-- LOANS -->
    <section id="loans" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Issue Loan</h3>
          <label>Member</label>
          <select id="loanMember"></select>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="loanAmt" min="0" step="1">
            </div>
            <div>
              <label>Start Date</label>
              <input type="date" id="loanDate">
            </div>
            <div>
              <label>Monthly Rate</label>
              <input type="text" id="loanRate" disabled value="auto (2.5% / 2%)">
            </div>
          </div>
          <div id="loanHint" class="help" style="margin-top:6px"></div>
          <div class="stack" style="margin-top:10px">
            <button class="btn primary" id="btnIssueLoan">Issue Loan</button>
          </div>
        </div>
        <div class="card">
          <h3>Active Loans</h3>
          <table class="table" id="loansTable">
            <thead>
              <tr><th>Member</th><th>Principal O/S</th><th>Accrued Interest</th><th>Rate</th><th>Since</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <p class="help">Limit: up to <b>2× share capital</b>. Rate: <b>2.5%/month</b> for UGX 1–3,999,000; otherwise <b>2%/month</b>. Interest accrues daily from monthly rate.</p>
        </div>
      </div>
    </section>

    <!-- REPAYMENTS -->
    <section id="repay" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Record Repayment</h3>
          <label>Member (with loan)</label>
          <select id="rpMember"></select>
          <div class="grid-3" style="margin-top:8px">
            <div>
              <label>Amount (UGX)</label>
              <input type="number" id="rpAmt" min="0" step="1">
            </div>
            <div>
              <label>Date</label>
              <input type="date" id="rpDate">
            </div>
            <div>
              <label>Apply to</label>
              <select id="rpApply">
                <option value="auto">Interest first (recommended)</option>
                <option value="principal">Principal only</option>
                <option value="interest">Interest only</option>
              </select>
            </div>
          </div>
          <div class="stack" style="margin-top:10px">
            <button class="btn ok" id="btnPostRepay">Post Repayment</button>
          </div>
          <p class="help">Default applies repayment to accrued interest first, then principal.</p>
        </div>
        <div class="card">
          <h3>Recent Transactions</h3>
          <table class="table" id="txTable">
            <thead><tr><th>Date</th><th>Member</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reports" class="tabpanel" hidden>
      <div class="card">
        <h3>Reports</h3>
        <div class="grid-3">
          <div>
            <label>Quarter</label>
            <select id="rQuarter">
              <option value="Q1">Q1 (Jan–Mar)</option>
              <option value="Q2">Q2 (Apr–Jun)</option>
              <option value="Q3">Q3 (Jul–Sep)</option>
              <option value="Q4">Q4 (Oct–Dec)</option>
            </select>
          </div>
          <div>
            <label>Year</label>
            <input type="number" id="rYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn primary" id="btnRunQuarter">Run Quarterly Report</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="quarterOut"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Year-End Profit Sharing</h3>
        <div class="grid-3">
          <div>
            <label>Year</label>
            <input type="number" id="yShareYear" min="2000" step="1" value="">
          </div>
          <div class="right" style="align-items:end">
            <button class="btn ok" id="btnShareOut">Compute Distribution</button>
          </div>
        </div>
        <div class="hr"></div>
        <div id="shareOut"></div>
        <p class="help">Profits considered: <b>interest collected</b> from loans in that year. Shared to members <b>proportional to their share capital</b>.</p>
      </div>
    </section>

    <!-- DATA -->
    <section id="data" class="tabpanel" hidden>
      <div class="grid-2">
        <div class="card">
          <h3>Backup / Restore</h3>
          <div class="stack">
            <button class="btn primary" id="btnBackup2">Export JSON</button>
            <label class="btn"><input type="file" id="restoreFile2" accept="application/json" style="display:none">Import JSON</label>
          </div>
          <p class="help">Exports all members, loans, transactions, and settings.</p>
        </div>
        <div class="card">
          <h3>Danger Zone</h3>
          <button class="btn bad" id="btnWipe">Reset ALL data</button>
          <p class="help">This cannot be undone (unless you exported a backup).</p>
        </div>
      </div>
    </section>
  </main>

<script>
/* ========= Utilities ========= */
const UGX = (v)=> new Intl.NumberFormat('en-UG', {style:'currency', currency:'UGX', maximumFractionDigits:0}).format(v||0);
const todayStr = ()=> new Date().toISOString().slice(0,10);
const parseDate = s => new Date(s+'T00:00:00');
const daysBetween = (a,b)=> Math.max(0, Math.round((parseDate(b)-parseDate(a)) / (1000*60*60*24)));
const clone = x => JSON.parse(JSON.stringify(x));

/* ========= Data Model (localStorage) ========= */
const KEY='kibiina_v1';
let db = JSON.parse(localStorage.getItem(KEY) || '{}');
if(!db.members){ // initialize
  db = {
    members: [], // {id,name,joinDate,shares,munno,loanId?}
    loans: [],   // {id, memberId, principalOut, rateMonthly, startDate, lastAccrual, accruedInterest}
    welfareFund: 0,
    tx: [],      // {ts, type, memberId?, amount, meta}
    settings: { lastMeetingDate: todayStr() }
  };
  save();
}
function save(){ localStorage.setItem(KEY, JSON.stringify(db)); }

/* ========= Tabs ========= */
document.getElementById('tabs').addEventListener('click', e=>{
  const b = e.target.closest('.tab'); if(!b) return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active', x===b));
  document.querySelectorAll('.tabpanel').forEach(p=>p.hidden = p.id !== b.dataset.tab);
  if(b.dataset.tab==='dashboard') renderDashboard();
  if(b.dataset.tab==='members') renderMembers();
  if(b.dataset.tab==='loans')    { accrueAll(); renderLoans(); }
  if(b.dataset.tab==='repay')    { accrueAll(); renderRepay(); }
  if(b.dataset.tab==='reports')  { accrueAll(); initReports(); }
  if(b.dataset.tab==='meeting')  initMeeting();
});

/* ========= Dashboard ========= */
function renderDashboard(){
  const n = db.members.length;
  const shareCap = db.members.reduce((s,m)=> s + (m.shares||0)*3000, 0);
  const loansOut = db.loans.reduce((s,l)=> s + l.principalOut, 0);
  const year = new Date().getFullYear();
  const intYTD = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                      .reduce((s,t)=> s + t.amount, 0);
  const munnoAgg = db.members.reduce((s,m)=> s + (m.munno||0), 0);
  document.getElementById('statMembers').textContent = String(n);
  document.getElementById('statShareCap').textContent = UGX(shareCap);
  document.getElementById('statLoans').textContent = UGX(loansOut);
  document.getElementById('statInterestYTD').textContent = UGX(intYTD);
  document.getElementById('fundWelfare').textContent = UGX(db.welfareFund||0);
  document.getElementById('fundMunno').textContent = UGX(munnoAgg);
}
renderDashboard();

/* ========= Members ========= */
let editingId = null;
function renderMembers(){
  const tbody = document.querySelector('#membersTable tbody');
  tbody.innerHTML = '';
  db.members.forEach((m,idx)=>{
    const shareCap = (m.shares||0)*3000;
    const loan = db.loans.find(l=>l.memberId===m.id);
    const principalOut = loan? loan.principalOut : 0;
    const limit = Math.max(0, (shareCap*2) - principalOut);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${idx+1}</td>
      <td>${m.name}</td>
      <td>${m.shares||0}</td>
      <td>${UGX(shareCap)}</td>
      <td>${UGX(m.munno||0)}</td>
      <td>${UGX(principalOut)}</td>
      <td>${UGX(limit)}</td>
      <td><button class="btn" data-edit="${m.id}">Edit</button></td>`;
    tbody.appendChild(tr);
  });
}
function resetMemberForm(){
  editingId=null;
  document.getElementById('mName').value='';
  document.getElementById('mShares').value=0;
  document.getElementById('mMunno').value=0;
  document.getElementById('mJoin').value=todayStr();
  document.getElementById('btnDeleteMember').disabled = true;
}
document.getElementById('membersTable').addEventListener('click', e=>{
  const id = e.target.dataset.edit; if(!id) return;
  const m = db.members.find(x=>x.id===id);
  editingId = id;
  document.getElementById('mName').value   = m.name||'';
  document.getElementById('mShares').value = m.shares||0;
  document.getElementById('mMunno').value  = m.munno||0;
  document.getElementById('mJoin').value   = m.joinDate||todayStr();
  document.getElementById('btnDeleteMember').disabled = false;
});
document.getElementById('btnSaveMember').onclick = ()=>{
  const name = document.getElementById('mName').value.trim();
  const shares = Math.min(10, Math.max(0, parseInt(document.getElementById('mShares').value||0)));
  const munno = Math.max(0, parseInt(document.getElementById('mMunno').value||0));
  const join = document.getElementById('mJoin').value || todayStr();
  if(!name){ alert('Enter member name'); return; }
  if(editingId){
    const m = db.members.find(x=>x.id===editingId);
    m.name=name; m.shares=shares; m.munno=munno; m.joinDate=join;
  }else{
    const id='m'+Math.random().toString(36).slice(2,9);
    db.members.push({id,name,shares,munno,joinDate:join});
  }
  save(); renderMembers(); renderDashboard(); resetMemberForm();
};
document.getElementById('btnDeleteMember').onclick = ()=>{
  if(!editingId) return;
  if(!confirm('Delete this member?')) return;
  // also remove loan if any
  db.loans = db.loans.filter(l=>l.memberId!==editingId);
  db.members = db.members.filter(m=>m.id!==editingId);
  save(); renderMembers(); renderDashboard(); resetMemberForm();
};
document.getElementById('btnCreate30').onclick = ()=>{
  if(db.members.length && !confirm('Add 30 demo members to existing list?')) return;
  for(let i=1;i<=30;i++){
    const id='m'+Math.random().toString(36).slice(2,9);
    db.members.push({id,name:`Member ${i}`,shares:0,munno:0,joinDate:todayStr()});
  }
  save(); renderMembers(); renderDashboard();
};

/* ========= Meeting (Sunday) ========= */
function nextSundayStr(){
  const d = new Date(); const day = d.getDay(); // 0 Sun
  const diff = (7 - day) % 7; // days to next Sunday (0 if today Sunday)
  d.setDate(d.getDate() + diff);
  return d.toISOString().slice(0,10);
}
document.getElementById('btnTodaySunday').onclick = ()=>{
  document.getElementById('meetDate').value = nextSundayStr();
};
function initMeeting(){
  document.getElementById('meetDate').value = db.settings.lastMeetingDate || nextSundayStr();
  document.getElementById('welfarePer').value = 1500;
  document.getElementById('meetingSheet').innerHTML='';
  document.getElementById('btnPostMeeting').disabled = true;
}
document.getElementById('btnStartMeeting').onclick = ()=>{
  const date = document.getElementById('meetDate').value || todayStr();
  db.settings.lastMeetingDate = date; save();
  const per = parseInt(document.getElementById('welfarePer').value||1500);
  const box = document.getElementById('meetingSheet');
  if(db.members.length===0){ box.innerHTML='<div class="warnmsg">No members yet. Add members first.</div>'; return; }
  let html = `<table class="table"><thead><tr>
      <th>#</th><th>Name</th><th>Munno Deposit</th><th>Welfare (UGX ${per})</th><th>Buy Shares</th></tr></thead><tbody>`;
  db.members.forEach((m,i)=>{
    html += `<tr>
      <td>${i+1}</td>
      <td>${m.name}</td>
      <td><input type="number" min="0" step="1" id="in_munno_${m.id}" placeholder="0"></td>
      <td style="text-align:center"><input type="checkbox" id="in_wel_${m.id}" checked></td>
      <td><input type="number" min="0" max="${Math.max(0,10-(m.shares||0))}" step="1" id="in_share_${m.id}" placeholder="0"></td>
    </tr>`;
  });
  html += '</tbody></table>';
  box.innerHTML = html;
  document.getElementById('btnPostMeeting').disabled = false;
};
document.getElementById('btnPostMeeting').onclick = ()=>{
  const date = document.getElementById('meetDate').value || todayStr();
  const per = parseInt(document.getElementById('welfarePer').value||1500);
  accrueAll(date); // up to meeting date
  db.members.forEach(m=>{
    const munno = parseInt(document.getElementById(`in_munno_${m.id}`).value||0);
    const wel = document.getElementById(`in_wel_${m.id}`).checked;
    const sharesBuy = Math.min(10-(m.shares||0), Math.max(0, parseInt(document.getElementById(`in_share_${m.id}`).value||0)));
    if(munno>0){
      m.munno = (m.munno||0) + munno;
      db.tx.push({ts:date, type:'munno_deposit', memberId:m.id, amount:munno});
    }
    if(wel){
      db.welfareFund = (db.welfareFund||0) + per;
      db.tx.push({ts:date, type:'welfare', memberId:m.id, amount:per});
    }
    if(sharesBuy>0){
      m.shares = (m.shares||0) + sharesBuy;
      db.tx.push({ts:date, type:'share_buy', memberId:m.id, amount: sharesBuy*3000, meta:{shares:sharesBuy}});
    }
  });
  save(); initMeeting(); renderDashboard(); alert('Meeting posted.');
};

/* ========= Loans ========= */
function loanRateFor(amount){
  if(amount>=1 && amount<=3999000) return 0.025;
  if(amount>3999000) return 0.02;
  return 0;
}
// Accrue interest on all loans up to a date (default today)
function accrueAll(upToDate){
  const dTo = upToDate || todayStr();
  db.loans.forEach(l=>{
    if(l.principalOut<=0) return;
    const start = l.lastAccrual || l.startDate;
    const days = daysBetween(start, dTo);
    if(days<=0) return;
    const dailyRate = l.rateMonthly/30; // simple pro-rata
    const add = l.principalOut * dailyRate * days;
    l.accruedInterest = (l.accruedInterest||0) + Math.round(add);
    l.lastAccrual = dTo;
  });
  save();
}
function renderLoans(){
  // member dropdown
  const sel = document.getElementById('loanMember');
  sel.innerHTML = db.members.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  document.getElementById('loanAmt').value='';
  document.getElementById('loanDate').value = todayStr();
  document.getElementById('loanHint').textContent='';
  // table
  const tbody = document.querySelector('#loansTable tbody');
  tbody.innerHTML='';
  db.loans.forEach(l=>{
    const m = db.members.find(x=>x.id===l.memberId);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m? m.name:'?'}</td>
      <td>${UGX(l.principalOut)}</td>
      <td>${UGX(l.accruedInterest||0)}</td>
      <td>${(l.rateMonthly*100).toFixed(2)}%/mo</td>
      <td>${l.startDate}</td>`;
    tbody.appendChild(tr);
  });
}
document.getElementById('loanAmt').addEventListener('input', ()=>{
  const mid = document.getElementById('loanMember').value;
  const m = db.members.find(x=>x.id===mid); if(!m) return;
  const amount = parseInt(document.getElementById('loanAmt').value||0);
  const shareCap = (m.shares||0)*3000;
  const currentLoan = db.loans.find(l=>l.memberId===mid);
  const principalOut = currentLoan? currentLoan.principalOut : 0;
  const limit = Math.max(0, shareCap*2 - principalOut);
  const rate = loanRateFor(amount);
  document.getElementById('loanHint').innerHTML =
    `Share capital: <b>${UGX(shareCap)}</b> → Limit: <b>${UGX(limit)}</b> • Proposed rate: <b>${(rate*100)||0}%/mo</b>`;
});
document.getElementById('btnIssueLoan').onclick = ()=>{
  const memberId = document.getElementById('loanMember').value;
  const m = db.members.find(x=>x.id===memberId);
  if(!m){ alert('Select member'); return; }
  const amount = parseInt(document.getElementById('loanAmt').value||0);
  const date = document.getElementById('loanDate').value || todayStr();
  if(amount<=0){ alert('Enter amount'); return; }
  // check limit
  const current = db.loans.find(l=>l.memberId===memberId);
  const principalOut = current? current.principalOut : 0;
  const limit = Math.max(0, ((m.shares||0)*3000)*2 - principalOut);
  if(amount>limit){ alert('Amount exceeds limit.'); return; }
  const rate = loanRateFor(amount);
  accrueAll(date);
  if(current){
    current.principalOut += amount;
    db.tx.push({ts:date, type:'loan_topup', memberId, amount});
  }else{
    db.loans.push({
      id: 'L'+Math.random().toString(36).slice(2,9),
      memberId, principalOut:amount, rateMonthly:rate, startDate:date, lastAccrual:date, accruedInterest:0
    });
    db.tx.push({ts:date, type:'loan_issue', memberId, amount});
  }
  save(); renderLoans(); renderDashboard(); alert('Loan recorded.');
};

/* ========= Repayments ========= */
function renderRepay(){
  const sel = document.getElementById('rpMember');
  const withLoans = db.members.filter(m=> db.loans.find(l=>l.memberId===m.id && l.principalOut>0 || (l.accruedInterest||0)>0));
  sel.innerHTML = withLoans.map(m=>`<option value="${m.id}">${m.name}</option>`).join('');
  document.getElementById('rpAmt').value='';
  document.getElementById('rpDate').value = todayStr();
  document.getElementById('rpApply').value = 'auto';
  // tx table (recent 15)
  const tbody = document.querySelector('#txTable tbody');
  const last = clone(db.tx).sort((a,b)=> new Date(b.ts) - new Date(a.ts)).slice(0,15);
  tbody.innerHTML = last.map(t=>{
    const m = db.members.find(x=>x.id===t.memberId);
    return `<tr><td>${t.ts}</td><td>${m?m.name:''}</td><td>${t.type}</td><td>${UGX(t.amount)}</td></tr>`;
  }).join('');
}
document.getElementById('btnPostRepay').onclick = ()=>{
  const memberId = document.getElementById('rpMember').value;
  const amt = parseInt(document.getElementById('rpAmt').value||0);
  const date = document.getElementById('rpDate').value || todayStr();
  const how = document.getElementById('rpApply').value;
  if(amt<=0){ alert('Enter amount'); return; }
  const loan = db.loans.find(l=>l.memberId===memberId);
  if(!loan){ alert('No active loan'); return; }
  accrueAll(date);
  let remain = amt;
  if(how==='auto' || how==='interest'){
    const payInt = Math.min(loan.accruedInterest||0, remain);
    if(payInt>0){
      loan.accruedInterest -= payInt;
      db.tx.push({ts:date, type:'repay_interest', memberId, amount:payInt});
      remain -= payInt;
    }
  }
  if((how==='auto' || how==='principal') && remain>0){
    const payP = Math.min(loan.principalOut, remain);
    if(payP>0){
      loan.principalOut -= payP;
      db.tx.push({ts:date, type:'repay_principal', memberId, amount:payP});
      remain -= payP;
    }
  }
  save(); renderRepay(); renderLoans(); renderDashboard();
  alert('Repayment posted.');
};

/* ========= Reports ========= */
function initReports(){
  const y = new Date().getFullYear();
  document.getElementById('rYear').value = y;
  document.getElementById('yShareYear').value = y;
  document.getElementById('quarterOut').innerHTML='';
  document.getElementById('shareOut').innerHTML='';
}
function quarterRange(q, year){
  const y=Number(year);
  if(q==='Q1') return [new Date(y,0,1), new Date(y,2,31)];
  if(q==='Q2') return [new Date(y,3,1), new Date(y,5,30)];
  if(q==='Q3') return [new Date(y,6,1), new Date(y,8,30)];
  return [new Date(y,9,1), new Date(y,11,31)];
}
document.getElementById('btnRunQuarter').onclick = ()=>{
  const q = document.getElementById('rQuarter').value;
  const y = parseInt(document.getElementById('rYear').value||new Date().getFullYear());
  const [a,b] = quarterRange(q,y);
  const inRange = t => {
    const d = new Date(t.ts);
    return d>=a && d<=b;
  };
  const welfare = db.tx.filter(t=>t.type==='welfare' && inRange(t)).reduce((s,t)=>s+t.amount,0);
  const munno = db.tx.filter(t=>t.type==='munno_deposit' && inRange(t)).reduce((s,t)=>s+t.amount,0);
  const shares = db.tx.filter(t=>t.type==='share_buy' && inRange(t)).reduce((s,t)=>s+t.amount,0);
  const interestRec = db.tx.filter(t=>t.type==='repay_interest' && inRange(t)).reduce((s,t)=>s+t.amount,0);
  const principalRec = db.tx.filter(t=>t.type==='repay_principal' && inRange(t)).reduce((s,t)=>s+t.amount,0);
  const loansOut = db.tx.filter(t=>(t.type==='loan_issue'||t.type==='loan_topup') && inRange(t)).reduce((s,t)=>s+t.amount,0);
  document.getElementById('quarterOut').innerHTML = `
    <div class="grid-3">
      <div class="stat"><span class="muted">Welfare contributions</span><b>${UGX(welfare)}</b></div>
      <div class="stat"><span class="muted">Munno deposits</span><b>${UGX(munno)}</b></div>
      <div class="stat"><span class="muted">Shares purchased</span><b>${UGX(shares)}</b></div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div class="stat"><span class="muted">Loans issued/topups</span><b>${UGX(loansOut)}</b></div>
      <div class="stat"><span class="muted">Principal repaid</span><b>${UGX(principalRec)}</b></div>
      <div class="stat"><span class="muted">Interest collected</span><b>${UGX(interestRec)}</b></div>
    </div>
  `;
};
document.getElementById('btnShareOut').onclick = ()=>{
  const year = parseInt(document.getElementById('yShareYear').value||new Date().getFullYear());
  const totalInterest = db.tx.filter(t => t.type==='repay_interest' && new Date(t.ts).getFullYear()===year)
                             .reduce((s,t)=>s+t.amount,0);
  const members = clone(db.members).map(m=> ({...m, shareCap:(m.shares||0)*3000}));
  const pool = members.reduce((s,m)=> s+m.shareCap, 0);
  let html = `<div class="stat"><span class="muted">Total interest (year)</span><b>${UGX(totalInterest)}</b></div>`;
  if(pool<=0 || totalInterest<=0){
    html += `<p class="warnmsg" style="margin-top:8px">No share capital or no interest collected for ${year}.</p>`;
  }else{
    html += `<table class="table" style="margin-top:8px"><thead><tr><th>Member</th><th>Shares</th><th>Share Capital</th><th>Share %</th><th>Payout</th></tr></thead><tbody>`;
    members.forEach(m=>{
      const pct = m.shareCap/pool;
      const pay = Math.round(totalInterest * pct);
      html += `<tr><td>${m.name}</td><td>${m.shares||0}</td><td>${UGX(m.shareCap)}</td><td>${(pct*100).toFixed(2)}%</td><td>${UGX(pay)}</td></tr>`;
    });
    html += `</tbody></table>`;
  }
  document.getElementById('shareOut').innerHTML = html;
};

/* ========= Backup/Restore ========= */
function download(filename, text){
  const blob = new Blob([text], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = filename; a.click();
  setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
}
document.getElementById('btnBackup').onclick = ()=>{
  accrueAll(); download('kibiina-backup.json', JSON.stringify(db, null, 2));
};
document.getElementById('btnBackup2').onclick = ()=>{
  accrueAll(); download('kibiina-backup.json', JSON.stringify(db, null, 2));
};
document.getElementById('restoreFile').addEventListener('change', handleRestore);
document.getElementById('restoreFile2').addEventListener('change', handleRestore);
function handleRestore(e){
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ try{
      const obj = JSON.parse(r.result);
      if(!obj.members||!obj.loans||!obj.tx){ alert('Invalid file'); return;}
      db = obj; save(); location.reload();
    }catch(err){ alert('Invalid JSON'); } };
  r.readAsText(f);
}
document.getElementById('btnWipe').onclick = ()=>{
  if(!confirm('This will delete ALL data. Continue?')) return;
  localStorage.removeItem(KEY); location.reload();
};

/* ========= On load render ========= */
renderMembers();
initMeeting();
renderLoans();
renderRepay();
initReports();
</script>
</body>
</html>
